id: 7f10c1653e35933c0f1e
bug_link: https://syzkaller.appspot.com/bug?extid=7f10c1653e35933c0f1e
title: memory leak in binder_transaction (2)
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 53604854c6f00ce1db4393499125aff94e3d9bbd
fix_commit: 1aa3aaf8953c84bad398adf6c3cabc9d6685bf7d
datetime: '2023-10-05T12:48:08+02:00'
fix_commit_message: "binder: fix memory leaks of spam and pending work\n\nA transaction\
  \ complete work is allocated and queued for each\ntransaction. Under certain conditions\
  \ the work->type might be marked as\nBINDER_WORK_TRANSACTION_ONEWAY_SPAM_SUSPECT\
  \ to notify userspace about\npotential spamming threads or as BINDER_WORK_TRANSACTION_PENDING\
  \ when\nthe target is currently frozen.\n\nHowever, these work types are not being\
  \ handled in binder_release_work()\nso they will leak during a cleanup. This was\
  \ reported by syzkaller with\nthe following kmemleak dump:\n\nBUG: memory leak\n\
  unreferenced object 0xffff88810e2d6de0 (size 32):\n  comm \"syz-executor338\", pid\
  \ 5046, jiffies 4294968230 (age 13.590s)\n  hex dump (first 32 bytes):\n    e0 6d\
  \ 2d 0e 81 88 ff ff e0 6d 2d 0e 81 88 ff ff  .m-......m-.....\n    04 00 00 00 00\
  \ 00 00 00 00 00 00 00 00 00 00 00  ................\n  backtrace:\n    [<ffffffff81573b75>]\
  \ kmalloc_trace+0x25/0x90 mm/slab_common.c:1114\n    [<ffffffff83d41873>] kmalloc\
  \ include/linux/slab.h:599 [inline]\n    [<ffffffff83d41873>] kzalloc include/linux/slab.h:720\
  \ [inline]\n    [<ffffffff83d41873>] binder_transaction+0x573/0x4050 drivers/android/binder.c:3152\n\
  \    [<ffffffff83d45a05>] binder_thread_write+0x6b5/0x1860 drivers/android/binder.c:4010\n\
  \    [<ffffffff83d486dc>] binder_ioctl_write_read drivers/android/binder.c:5066\
  \ [inline]\n    [<ffffffff83d486dc>] binder_ioctl+0x1b2c/0x3cf0 drivers/android/binder.c:5352\n\
  \    [<ffffffff816b25f2>] vfs_ioctl fs/ioctl.c:51 [inline]\n    [<ffffffff816b25f2>]\
  \ __do_sys_ioctl fs/ioctl.c:871 [inline]\n    [<ffffffff816b25f2>] __se_sys_ioctl\
  \ fs/ioctl.c:857 [inline]\n    [<ffffffff816b25f2>] __x64_sys_ioctl+0xf2/0x140 fs/ioctl.c:857\n\
  \    [<ffffffff84b30008>] do_syscall_x64 arch/x86/entry/common.c:50 [inline]\n \
  \   [<ffffffff84b30008>] do_syscall_64+0x38/0xb0 arch/x86/entry/common.c:80\n  \
  \  [<ffffffff84c0008b>] entry_SYSCALL_64_after_hwframe+0x63/0xcd\n\nFix the leaks\
  \ by kfreeing these work types in binder_release_work() and\nhandle them as a BINDER_WORK_TRANSACTION_COMPLETE\
  \ cleanup.\n\nCc: stable@vger.kernel.org\nFixes: 0567461a7a6e (\"binder: return\
  \ pending info for frozen async txns\")\nFixes: a7dc1e6f99df (\"binder: tell userspace\
  \ to dump current backtrace when detected oneway spamming\")\nReported-by: syzbot+7f10c1653e35933c0f1e@syzkaller.appspotmail.com\n\
  Closes: https://syzkaller.appspot.com/bug?extid=7f10c1653e35933c0f1e\nSuggested-by:\
  \ Alice Ryhl <aliceryhl@google.com>\nSigned-off-by: Carlos Llamas <cmllamas@google.com>\n\
  Reviewed-by: Alice Ryhl <aliceryhl@google.com>\nAcked-by: Todd Kjos <tkjos@google.com>\n\
  Link: https://lore.kernel.org/r/20230922175138.230331-1-cmllamas@google.com\nSigned-off-by:\
  \ Greg Kroah-Hartman <gregkh@linuxfoundation.org>\n"
submodule:
- drivers/android
hunk_count: 1
covered_count: 0
