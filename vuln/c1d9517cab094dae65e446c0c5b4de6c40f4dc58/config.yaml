id: c1d9517cab094dae65e446c0c5b4de6c40f4dc58
bug_link: https://syzkaller.appspot.com/bug?extid=c1d9517cab094dae65e446c0c5b4de6c40f4dc58
title: WARNING in handle_ept_misconfig
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 135a06c3a515bbd17729eb04f4f26316d48363d7
fix_commit: 95e057e25892eaa48cad1e2d637b80d0f1a4fac5
datetime: '2018-02-24T01:43:37+01:00'
fix_commit_message: "KVM: X86: Fix SMRAM accessing even if VM is shutdown\n\nReported\
  \ by syzkaller:\n\n   WARNING: CPU: 6 PID: 2434 at arch/x86/kvm/vmx.c:6660 handle_ept_misconfig+0x54/0x1e0\
  \ [kvm_intel]\n   CPU: 6 PID: 2434 Comm: repro_test Not tainted 4.15.0+ #4\n   RIP:\
  \ 0010:handle_ept_misconfig+0x54/0x1e0 [kvm_intel]\n   Call Trace:\n    vmx_handle_exit+0xbd/0xe20\
  \ [kvm_intel]\n    kvm_arch_vcpu_ioctl_run+0xdaf/0x1d50 [kvm]\n    kvm_vcpu_ioctl+0x3e9/0x720\
  \ [kvm]\n    do_vfs_ioctl+0xa4/0x6a0\n    SyS_ioctl+0x79/0x90\n    entry_SYSCALL_64_fastpath+0x25/0x9c\n\
  \nThe testcase creates a first thread to issue KVM_SMI ioctl, and then creates\n\
  a second thread to mmap and operate on the same vCPU.  This triggers a race\ncondition\
  \ when running the testcase with multiple threads. Sometimes one thread\nexits with\
  \ a triple fault while another thread mmaps and operates on the same\nvCPU.  Because\
  \ CS=0x3000/IP=0x8000 is not mapped, accessing the SMI handler\nresults in an EPT\
  \ misconfig. This patch fixes it by returning RET_PF_EMULATE\nin kvm_handle_bad_page(),\
  \ which will go on to cause an emulation failure and an\nexit with KVM_EXIT_INTERNAL_ERROR.\n\
  \nReported-by: syzbot+c1d9517cab094dae65e446c0c5b4de6c40f4dc58@syzkaller.appspotmail.com\n\
  Cc: Paolo Bonzini <pbonzini@redhat.com>\nCc: Radim Krčmář <rkrcmar@redhat.com>\n\
  Cc: stable@vger.kernel.org\nSigned-off-by: Wanpeng Li <wanpengli@tencent.com>\n\
  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>\n"
submodule:
- arch/x86/kvm
hunk_count: 1
covered_count: 0
