id: 4088ed905e4ae2b0e13b
bug_link: https://syzkaller.appspot.com/bug?extid=4088ed905e4ae2b0e13b
title: WARNING in ib_unregister_device_queued
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 65936bf25f90fe440bb2d11624c7d10fab266639
fix_commit: 0cb42c0265837fafa2b4f302c8a7fed2631d7869
datetime: '2020-07-02T14:25:42-03:00'
fix_commit_message: 'RDMA/core: Fix bogus WARN_ON during ib_unregister_device_queued()


  ib_unregister_device_queued() can only be used by drivers using the new

  dealloc_device callback flow, and it has a safety WARN_ON to ensure

  drivers are using it properly.


  However, if unregister and register are raced there is a special

  destruction path that maintains the uniform error handling semantic of

  ''caller does ib_dealloc_device() on failure''. This requires disabling the

  dealloc_device callback which triggers the WARN_ON.


  Instead of using NULL to disable the callback use a special function

  pointer so the WARN_ON does not trigger.


  Fixes: d0899892edd0 ("RDMA/device: Provide APIs from the core code to help unregistration")

  Link: https://lore.kernel.org/r/0-v1-a36d512e0a99+762-syz_dealloc_driver_jgg@nvidia.com

  Reported-by: syzbot+4088ed905e4ae2b0e13b@syzkaller.appspotmail.com

  Suggested-by: Hillf Danton <hdanton@sina.com>

  Reviewed-by: Leon Romanovsky <leonro@mellanox.com>

  Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>

  '
submodule:
- drivers/infiniband/core
hunk_count: 3
covered_count: 0
