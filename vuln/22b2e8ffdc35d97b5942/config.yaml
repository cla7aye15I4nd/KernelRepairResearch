id: 22b2e8ffdc35d97b5942
bug_link: https://syzkaller.appspot.com/bug?extid=22b2e8ffdc35d97b5942
title: 'KASAN: use-after-free Read in fib6_ifup (2)'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 128bb975dc3c25d00de04e503e2fe0a780d04459
fix_commit: 591ff9ea51cec683e4cb378a3469228ba1d69010
datetime: '2018-01-18T21:14:00-05:00'
fix_commit_message: "ipv6: don't let tb6_root node share routes with other node\n\n\
  After commit 4512c43eac7e, if we add a route to the subtree of tb6_root\nwhich does\
  \ not have any route attached to it yet, the current code will\nlet tb6_root and\
  \ the node in the subtree share the same route.\nThis could cause problem cause\
  \ tb6_root has RTN_INFO flag marked and the\ntree repair and clean up code will\
  \ not work properly.\nThis commit makes sure tb6_root->leaf points back to null_entry\
  \ instead\nof sharing route with other node.\n\nIt fixes the following syzkaller\
  \ reported issue:\nBUG: KASAN: use-after-free in ipv6_prefix_equal include/net/ipv6.h:540\
  \ [inline]\nBUG: KASAN: use-after-free in fib6_add_1+0x165f/0x1790 net/ipv6/ip6_fib.c:618\n\
  Read of size 8 at addr ffff8801bc043498 by task syz-executor5/19819\n\nCPU: 1 PID:\
  \ 19819 Comm: syz-executor5 Not tainted 4.15.0-rc7+ #186\nHardware name: Google\
  \ Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011\nCall Trace:\n\
  \ __dump_stack lib/dump_stack.c:17 [inline]\n dump_stack+0x194/0x257 lib/dump_stack.c:53\n\
  \ print_address_description+0x73/0x250 mm/kasan/report.c:252\n kasan_report_error\
  \ mm/kasan/report.c:351 [inline]\n kasan_report+0x25b/0x340 mm/kasan/report.c:409\n\
  \ __asan_report_load8_noabort+0x14/0x20 mm/kasan/report.c:430\n ipv6_prefix_equal\
  \ include/net/ipv6.h:540 [inline]\n fib6_add_1+0x165f/0x1790 net/ipv6/ip6_fib.c:618\n\
  \ fib6_add+0x5fa/0x1540 net/ipv6/ip6_fib.c:1214\n __ip6_ins_rt+0x6c/0x90 net/ipv6/route.c:1003\n\
  \ ip6_route_add+0x141/0x190 net/ipv6/route.c:2790\n ipv6_route_ioctl+0x4db/0x6b0\
  \ net/ipv6/route.c:3299\n inet6_ioctl+0xef/0x1e0 net/ipv6/af_inet6.c:520\n sock_do_ioctl+0x65/0xb0\
  \ net/socket.c:958\n sock_ioctl+0x2c2/0x440 net/socket.c:1055\n vfs_ioctl fs/ioctl.c:46\
  \ [inline]\n do_vfs_ioctl+0x1b1/0x1520 fs/ioctl.c:686\n SYSC_ioctl fs/ioctl.c:701\
  \ [inline]\n SyS_ioctl+0x8f/0xc0 fs/ioctl.c:692\n entry_SYSCALL_64_fastpath+0x23/0x9a\n\
  RIP: 0033:0x452ac9\nRSP: 002b:00007fd42b321c58 EFLAGS: 00000212 ORIG_RAX: 0000000000000010\n\
  RAX: ffffffffffffffda RBX: 000000000071bea0 RCX: 0000000000452ac9\nRDX: 0000000020fd7000\
  \ RSI: 000000000000890b RDI: 0000000000000013\nRBP: 000000000000049e R08: 0000000000000000\
  \ R09: 0000000000000000\nR10: 0000000000000000 R11: 0000000000000212 R12: 00000000006f4f70\n\
  R13: 00000000ffffffff R14: 00007fd42b3226d4 R15: 0000000000000000\n\nFixes: 4512c43eac7e\
  \ (\"ipv6: remove null_entry before adding default route\")\nSigned-off-by: Wei\
  \ Wang <weiwan@google.com>\nAcked-by: Eric Dumazet <edumazet@google.com>\nAcked-by:\
  \ Martin KaFai Lau <kafai@fb.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>\n"
submodule:
- net/ipv6
hunk_count: 1
covered_count: 0
