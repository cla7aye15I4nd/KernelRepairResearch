id: fb5458330b4442f2090d
bug_link: https://syzkaller.appspot.com/bug?extid=fb5458330b4442f2090d
title: 'INFO: task hung in io_sq_thread_park'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 28c4721b80a702462fb77373c23428ee698fa5dd
fix_commit: 3ebba796fa251d042be42b929a2d916ee5c34a49
datetime: '2021-03-04T06:37:14-07:00'
fix_commit_message: "io_uring: ensure that SQPOLL thread is started for exit\n\nIf\
  \ we create it in a disabled state because IORING_SETUP_R_DISABLED is\nset on ring\
  \ creation, we need to ensure that we've kicked the thread if\nwe're exiting before\
  \ it's been explicitly disabled. Otherwise we can run\ninto a deadlock where exit\
  \ is waiting go park the SQPOLL thread, but the\nSQPOLL thread itself is waiting\
  \ to get a signal to start.\n\nThat results in the below trace of both tasks hung,\
  \ waiting on each other:\n\nINFO: task syz-executor458:8401 blocked for more than\
  \ 143 seconds.\n      Not tainted 5.11.0-next-20210226-syzkaller #0\n\"echo 0 >\
  \ /proc/sys/kernel/hung_task_timeout_secs\" disables this message.\ntask:syz-executor458\
  \ state:D stack:27536 pid: 8401 ppid:  8400 flags:0x00004004\nCall Trace:\n context_switch\
  \ kernel/sched/core.c:4324 [inline]\n __schedule+0x90c/0x21a0 kernel/sched/core.c:5075\n\
  \ schedule+0xcf/0x270 kernel/sched/core.c:5154\n schedule_timeout+0x1db/0x250 kernel/time/timer.c:1868\n\
  \ do_wait_for_common kernel/sched/completion.c:85 [inline]\n __wait_for_common kernel/sched/completion.c:106\
  \ [inline]\n wait_for_common kernel/sched/completion.c:117 [inline]\n wait_for_completion+0x168/0x270\
  \ kernel/sched/completion.c:138\n io_sq_thread_park fs/io_uring.c:7115 [inline]\n\
  \ io_sq_thread_park+0xd5/0x130 fs/io_uring.c:7103\n io_uring_cancel_task_requests+0x24c/0xd90\
  \ fs/io_uring.c:8745\n __io_uring_files_cancel+0x110/0x230 fs/io_uring.c:8840\n\
  \ io_uring_files_cancel include/linux/io_uring.h:47 [inline]\n do_exit+0x299/0x2a60\
  \ kernel/exit.c:780\n do_group_exit+0x125/0x310 kernel/exit.c:922\n __do_sys_exit_group\
  \ kernel/exit.c:933 [inline]\n __se_sys_exit_group kernel/exit.c:931 [inline]\n\
  \ __x64_sys_exit_group+0x3a/0x50 kernel/exit.c:931\n do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46\n\
  \ entry_SYSCALL_64_after_hwframe+0x44/0xae\nRIP: 0033:0x43e899\nRSP: 002b:00007ffe89376d48\
  \ EFLAGS: 00000246 ORIG_RAX: 00000000000000e7\nRAX: ffffffffffffffda RBX: 00000000004af2f0\
  \ RCX: 000000000043e899\nRDX: 000000000000003c RSI: 00000000000000e7 RDI: 0000000000000000\n\
  RBP: 0000000000000000 R08: ffffffffffffffc0 R09: 0000000010000000\nR10: 0000000000008011\
  \ R11: 0000000000000246 R12: 00000000004af2f0\nR13: 0000000000000001 R14: 0000000000000000\
  \ R15: 0000000000000001\nINFO: task iou-sqp-8401:8402 can't die for more than 143\
  \ seconds.\ntask:iou-sqp-8401    state:D stack:30272 pid: 8402 ppid:  8400 flags:0x00004004\n\
  Call Trace:\n context_switch kernel/sched/core.c:4324 [inline]\n __schedule+0x90c/0x21a0\
  \ kernel/sched/core.c:5075\n schedule+0xcf/0x270 kernel/sched/core.c:5154\n schedule_timeout+0x1db/0x250\
  \ kernel/time/timer.c:1868\n do_wait_for_common kernel/sched/completion.c:85 [inline]\n\
  \ __wait_for_common kernel/sched/completion.c:106 [inline]\n wait_for_common kernel/sched/completion.c:117\
  \ [inline]\n wait_for_completion+0x168/0x270 kernel/sched/completion.c:138\n io_sq_thread+0x27d/0x1ae0\
  \ fs/io_uring.c:6717\n ret_from_fork+0x1f/0x30 arch/x86/entry/entry_64.S:294\nINFO:\
  \ task iou-sqp-8401:8402 blocked for more than 143 seconds.\n\nReported-by: syzbot+fb5458330b4442f2090d@syzkaller.appspotmail.com\n\
  Signed-off-by: Jens Axboe <axboe@kernel.dk>\n"
submodule:
- fs
hunk_count: 3
covered_count: 1
