id: c56f6371c48cad0420f9
bug_link: https://syzkaller.appspot.com/bug?extid=c56f6371c48cad0420f9
title: 'INFO: task hung in hci_dev_close_sync'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 029cc0963412c4f989d2731759ce4578f7e1a667
fix_commit: e36bea6e78ab2b6c9c7396972fee231eae551cfc
datetime: '2022-07-05T13:20:03-07:00'
fix_commit_message: 'Bluetooth: core: Fix deadlock on hci_power_on_sync.


  `cancel_work_sync(&hdev->power_on)` was moved to hci_dev_close_sync in

  commit [1] to ensure that power_on work is canceled after HCI interface

  down.


  But, in certain cases power_on work function may call hci_dev_close_sync

  itself: hci_power_on -> hci_dev_do_close -> hci_dev_close_sync ->

  cancel_work_sync(&hdev->power_on), causing deadlock. In particular, this

  happens when device is rfkilled on boot. To avoid deadlock, move

  power_on work canceling out of hci_dev_do_close/hci_dev_close_sync.


  Deadlock introduced by commit [1] was reported in [2,3] as broken

  suspend. Suspend did not work because `hdev->req_lock` held as result of

  `power_on` work deadlock. In fact, other BT features were not working.

  It was not observed when testing [1] since it was verified without

  rfkill in place.


  NOTE: It is not needed to cancel power_on work from other places where

  hci_dev_do_close/hci_dev_close_sync is called in case:

  * Requests were serialized due to `hdev->req_workqueue`. The power_on

  work is first in that workqueue.

  * hci_rfkill_set_block which won''t close device anyway until HCI_SETUP

  is on.

  * hci_sock_release which runs after hci_sock_bind which ensures

  HCI_SETUP was cleared.


  As result, behaviour is the same as in pre-dd06ed7 commit, except

  power_on work cancel added to hci_dev_close.


  [1]: commit ff7f2926114d ("Bluetooth: core: Fix missing power_on work cancel on
  HCI close")

  [2]: https://lore.kernel.org/lkml/20220614181706.26513-1-max.oss.09@gmail.com/

  [2]: https://lore.kernel.org/lkml/1236061d-95dd-c3ad-a38f-2dae7aae51ef@o2.pl/


  Fixes: ff7f2926114d ("Bluetooth: core: Fix missing power_on work cancel on HCI close")

  Signed-off-by: Vasyl Vavrychuk <vasyl.vavrychuk@opensynergy.com>

  Reported-by: Max Krummenacher <max.krummenacher@toradex.com>

  Reported-by: Mateusz Jonczyk <mat.jonczyk@o2.pl>

  Tested-by: Max Krummenacher <max.krummenacher@toradex.com>

  Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>

  '
submodule:
- net/bluetooth
hunk_count: 3
covered_count: 2
