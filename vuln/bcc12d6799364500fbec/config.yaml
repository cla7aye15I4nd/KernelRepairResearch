id: bcc12d6799364500fbec
bug_link: https://syzkaller.appspot.com/bug?extid=bcc12d6799364500fbec
title: 'BUG: sleeping function called from invalid context in pcpu_alloc_noprof'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: f0a56c17e64bb5e7cdb9295df2b5fc21e4949005
fix_commit: 8e5f1bb812741821e2a8ac221fba45cab6c73e43
datetime: '2025-05-20T19:18:24-07:00'
fix_commit_message: "ipv6: Narrow down RCU critical section in inet6_rtm_newroute().\n\
  \nCommit 169fd62799e8 (\"ipv6: Get rid of RTNL for SIOCADDRT and\nRTM_NEWROUTE.\"\
  ) added rcu_read_lock() covering\nip6_route_info_create_nh() and __ip6_ins_rt()\
  \ to guarantee that\nnexthop and netdev will not go away.\n\nHowever, as reported\
  \ by syzkaller [0], ip_tun_build_state() calls\ndst_cache_init() with GFP_KERNEL\
  \ during the RCU critical section.\n\nip6_route_info_create_nh() fetches nexthop\
  \ or netdev depending on\nwhether RTA_NH_ID is set, and struct fib6_info holds a\
  \ refcount\nof either of them by nexthop_get() or netdev_get_by_index().\n\nnetdev_get_by_index()\
  \ looks up a dev and calls dev_hold() under RCU.\n\nSo, we need RCU only around\
  \ nexthop_find_by_id() and nexthop_get()\n( and a few more nexthop code).\n\nLet's\
  \ add rcu_read_lock() there and remove rcu_read_lock() in\nip6_route_add() and ip6_route_multipath_add().\n\
  \nNow these functions called from fib6_add() need RCU:\n\n  - inet6_rt_notify()\n\
  \  - fib6_drop_pcpu_from() (via fib6_purge_rt())\n  - rt6_flush_exceptions() (via\
  \ fib6_purge_rt())\n  - ip6_ignore_linkdown() (via rt6_multipath_rebalance())\n\n\
  All callers of inet6_rt_notify() need RCU, so rcu_read_lock() is\nadded there.\n\
  \n[0]:\n[ BUG: Invalid wait context ]\n6.15.0-rc4-syzkaller-00746-g836b313a14a3\
  \ #0 Tainted: G W\n ----------------------------\nsyz-executor234/5832 is trying\
  \ to lock:\nffffffff8e021688 (pcpu_alloc_mutex){+.+.}-{4:4}, at:\npcpu_alloc_noprof+0x284/0x16b0\
  \ mm/percpu.c:1782\nother info that might help us debug this:\ncontext-{5:5}\n1\
  \ lock held by syz-executor234/5832:\n 0: ffffffff8df3b860 (rcu_read_lock){....}-{1:3},\
  \ at: rcu_lock_acquire\ninclude/linux/rcupdate.h:331 [inline]\n 0: ffffffff8df3b860\
  \ (rcu_read_lock){....}-{1:3}, at: rcu_read_lock\ninclude/linux/rcupdate.h:841 [inline]\n\
  \ 0: ffffffff8df3b860 (rcu_read_lock){....}-{1:3}, at:\nip6_route_add+0x4d/0x2f0\
  \ net/ipv6/route.c:3913\nstack backtrace:\nCPU: 0 UID: 0 PID: 5832 Comm: syz-executor234\
  \ Tainted: G W\n6.15.0-rc4-syzkaller-00746-g836b313a14a3 #0 PREEMPT(full)\nTainted:\
  \ [W]=WARN\nHardware name: Google Google Compute Engine/Google Compute Engine,\n\
  BIOS Google 04/29/2025\nCall Trace:\n <TASK>\n dump_stack_lvl+0x189/0x250 lib/dump_stack.c:120\n\
  \ print_lock_invalid_wait_context kernel/locking/lockdep.c:4831 [inline]\n check_wait_context\
  \ kernel/locking/lockdep.c:4903 [inline]\n __lock_acquire+0xbcf/0xd20 kernel/locking/lockdep.c:5185\n\
  \ lock_acquire+0x120/0x360 kernel/locking/lockdep.c:5866\n __mutex_lock_common kernel/locking/mutex.c:601\
  \ [inline]\n __mutex_lock+0x182/0xe80 kernel/locking/mutex.c:746\n pcpu_alloc_noprof+0x284/0x16b0\
  \ mm/percpu.c:1782\n dst_cache_init+0x37/0xc0 net/core/dst_cache.c:145\n ip_tun_build_state+0x193/0x6b0\
  \ net/ipv4/ip_tunnel_core.c:687\n lwtunnel_build_state+0x381/0x4c0 net/core/lwtunnel.c:137\n\
  \ fib_nh_common_init+0x129/0x460 net/ipv4/fib_semantics.c:635\n fib6_nh_init+0x15e4/0x2030\
  \ net/ipv6/route.c:3669\n ip6_route_info_create_nh+0x139/0x870 net/ipv6/route.c:3866\n\
  \ ip6_route_add+0xf6/0x2f0 net/ipv6/route.c:3915\n inet6_rtm_newroute+0x284/0x1c50\
  \ net/ipv6/route.c:5732\n rtnetlink_rcv_msg+0x7cc/0xb70 net/core/rtnetlink.c:6955\n\
  \ netlink_rcv_skb+0x219/0x490 net/netlink/af_netlink.c:2534\n netlink_unicast_kernel\
  \ net/netlink/af_netlink.c:1313 [inline]\n netlink_unicast+0x758/0x8d0 net/netlink/af_netlink.c:1339\n\
  \ netlink_sendmsg+0x805/0xb30 net/netlink/af_netlink.c:1883\n sock_sendmsg_nosec\
  \ net/socket.c:712 [inline]\n __sock_sendmsg+0x219/0x270 net/socket.c:727\n ____sys_sendmsg+0x505/0x830\
  \ net/socket.c:2566\n ___sys_sendmsg+0x21f/0x2a0 net/socket.c:2620\n __sys_sendmsg\
  \ net/socket.c:2652 [inline]\n __do_sys_sendmsg net/socket.c:2657 [inline]\n __se_sys_sendmsg\
  \ net/socket.c:2655 [inline]\n __x64_sys_sendmsg+0x19b/0x260 net/socket.c:2655\n\
  \ do_syscall_x64 arch/x86/entry/syscall_64.c:63 [inline]\n do_syscall_64+0xf6/0x210\
  \ arch/x86/entry/syscall_64.c:94\n\nFixes: 169fd62799e8 (\"ipv6: Get rid of RTNL\
  \ for SIOCADDRT and RTM_NEWROUTE.\")\nReported-by: syzbot+bcc12d6799364500fbec@syzkaller.appspotmail.com\n\
  Closes: https://syzkaller.appspot.com/bug?extid=bcc12d6799364500fbec\nReported-by:\
  \ Eric Dumazet <edumazet@google.com>\nCloses: https://lore.kernel.org/netdev/CANn89i+r1cGacVC_6n3-A-WSkAa_Nr+pmxJ7Gt+oP-P9by2aGw@mail.gmail.com/\n\
  Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>\nLink: https://patch.msgid.link/20250516022759.44392-4-kuniyu@amazon.com\n\
  Signed-off-by: Jakub Kicinski <kuba@kernel.org>\n"
submodule:
- net/ipv6
hunk_count: 12
covered_count: 4
