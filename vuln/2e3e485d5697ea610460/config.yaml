id: 2e3e485d5697ea610460
bug_link: https://syzkaller.appspot.com/bug?extid=2e3e485d5697ea610460
title: WARNING in cma_exit_net
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 6734b2973565e36659e97e12ab0d0faf1d9f3fbe
fix_commit: 061ccb52d23cfa2cf3195546a21c3a87194db5b7
datetime: '2019-04-03T15:20:32-03:00'
fix_commit_message: "RDMA/cma: Set proper port number as index\n\nConversion from\
  \ IDR to XArray missed the fact that idr_alloc() returned\nindex as a return value,\
  \ this index was saved in port variable and used as\nquery index later on. This\
  \ caused to the following error.\n\n BUG: KASAN: use-after-free in cma_check_port+0x86a/0xa20\
  \ [rdma_cm]\n Read of size 8 at addr ffff888069fde998 by task ucmatose/387\n CPU:\
  \ 3 PID: 387 Comm: ucmatose Not tainted 5.1.0-rc2+ #253\n Hardware name: QEMU Standard\
  \ PC (Q35 + ICH9, 2009), BIOS rel-1.11.0-0-g63451fca13-prebuilt.qemu-project.org\
  \ 04/01/2014\n Call Trace:\n  dump_stack+0x7c/0xc0\n  print_address_description+0x6c/0x23c\n\
  \  ? cma_check_port+0x86a/0xa20 [rdma_cm]\n  kasan_report.cold.3+0x1c/0x35\n  ?\
  \ cma_check_port+0x86a/0xa20 [rdma_cm]\n  ? cma_check_port+0x86a/0xa20 [rdma_cm]\n\
  \  cma_check_port+0x86a/0xa20 [rdma_cm]\n  rdma_bind_addr+0x11bc/0x1b00 [rdma_cm]\n\
  \  ? find_held_lock+0x33/0x1c0\n  ? cma_ndev_work_handler+0x180/0x180 [rdma_cm]\n\
  \  ? wait_for_completion+0x3d0/0x3d0\n  ucma_bind+0x120/0x160 [rdma_ucm]\n  ? ucma_resolve_addr+0x1a0/0x1a0\
  \ [rdma_ucm]\n  ucma_write+0x1f8/0x2b0 [rdma_ucm]\n  ? ucma_open+0x260/0x260 [rdma_ucm]\n\
  \  vfs_write+0x157/0x460\n  ksys_write+0xb8/0x170\n  ? __ia32_sys_read+0xb0/0xb0\n\
  \  ? trace_hardirqs_off_caller+0x5b/0x160\n  ? do_syscall_64+0x18/0x3c0\n  do_syscall_64+0x95/0x3c0\n\
  \  entry_SYSCALL_64_after_hwframe+0x49/0xbe\n\n  Allocated by task 381:\n   __kasan_kmalloc.constprop.5+0xc1/0xd0\n\
  \   cma_alloc_port+0x4d/0x160 [rdma_cm]\n   rdma_bind_addr+0x14e7/0x1b00 [rdma_cm]\n\
  \   ucma_bind+0x120/0x160 [rdma_ucm]\n   ucma_write+0x1f8/0x2b0 [rdma_ucm]\n   vfs_write+0x157/0x460\n\
  \   ksys_write+0xb8/0x170\n   do_syscall_64+0x95/0x3c0\n   entry_SYSCALL_64_after_hwframe+0x49/0xbe\n\
  \n  Freed by task 381:\n   __kasan_slab_free+0x12e/0x180\n   kfree+0xed/0x290\n\
  \   rdma_destroy_id+0x6b6/0x9e0 [rdma_cm]\n   ucma_close+0x110/0x300 [rdma_ucm]\n\
  \   __fput+0x25a/0x740\n   task_work_run+0x10e/0x190\n   do_exit+0x85e/0x29e0\n\
  \   do_group_exit+0xf0/0x2e0\n   get_signal+0x2e0/0x17e0\n   do_signal+0x94/0x1570\n\
  \   exit_to_usermode_loop+0xfa/0x130\n   do_syscall_64+0x327/0x3c0\n   entry_SYSCALL_64_after_hwframe+0x49/0xbe\n\
  \nReported-by: <syzbot+2e3e485d5697ea610460@syzkaller.appspotmail.com>\nReported-by:\
  \ Ran Rozenstein <ranro@mellanox.com>\nFixes: 638267537ad9 (\"cma: Convert portspace\
  \ IDRs to XArray\")\nSigned-off-by: Leon Romanovsky <leonro@mellanox.com>\nReviewed-by:\
  \ Bart Van Assche <bvanassche@acm.org>\nTested-by: Bart Van Assche <bvanassche@acm.org>\n\
  Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>\n"
submodule:
- drivers/infiniband/core
hunk_count: 1
covered_count: 0
