id: fd7b34375c1c8ce29c93
bug_link: https://syzkaller.appspot.com/bug?extid=fd7b34375c1c8ce29c93
title: 'BUG: unable to handle kernel NULL pointer dereference in sk_psock_verdict_data_ready'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 5c138a8a4abe152fcbef1ed40a6a4b5727b2991b
fix_commit: 4cd12c6065dfcdeba10f49949bffcf383b3952d8
datetime: '2024-02-21T17:15:23+01:00'
fix_commit_message: "bpf, sockmap: Fix NULL pointer dereference in sk_psock_verdict_data_ready()\n\
  \nsyzbot reported the following NULL pointer dereference issue [1]:\n\n  BUG: kernel\
  \ NULL pointer dereference, address: 0000000000000000\n  [...]\n  RIP: 0010:0x0\n\
  \  [...]\n  Call Trace:\n   <TASK>\n   sk_psock_verdict_data_ready+0x232/0x340 net/core/skmsg.c:1230\n\
  \   unix_stream_sendmsg+0x9b4/0x1230 net/unix/af_unix.c:2293\n   sock_sendmsg_nosec\
  \ net/socket.c:730 [inline]\n   __sock_sendmsg+0x221/0x270 net/socket.c:745\n  \
  \ ____sys_sendmsg+0x525/0x7d0 net/socket.c:2584\n   ___sys_sendmsg net/socket.c:2638\
  \ [inline]\n   __sys_sendmsg+0x2b0/0x3a0 net/socket.c:2667\n   do_syscall_64+0xf9/0x240\n\
  \   entry_SYSCALL_64_after_hwframe+0x6f/0x77\n\nIf sk_psock_verdict_data_ready()\
  \ and sk_psock_stop_verdict() are called\nconcurrently, psock->saved_data_ready\
  \ can be NULL, causing the above issue.\n\nThis patch fixes this issue by calling\
  \ the appropriate data ready function\nusing the sk_psock_data_ready() helper and\
  \ protecting it from concurrency\nwith sk->sk_callback_lock.\n\nFixes: 6df7f764cd3c\
  \ (\"bpf, sockmap: Wake up polling after data copy\")\nReported-by: syzbot+fd7b34375c1c8ce29c93@syzkaller.appspotmail.com\n\
  Signed-off-by: Shigeru Yoshida <syoshida@redhat.com>\nSigned-off-by: Daniel Borkmann\
  \ <daniel@iogearbox.net>\nTested-by: syzbot+fd7b34375c1c8ce29c93@syzkaller.appspotmail.com\n\
  Acked-by: John Fastabend <john.fastabend@gmail.com>\nCloses: https://syzkaller.appspot.com/bug?extid=fd7b34375c1c8ce29c93\
  \ [1]\nLink: https://lore.kernel.org/bpf/20240218150933.6004-1-syoshida@redhat.com\n"
submodule:
- net/core
hunk_count: 1
covered_count: 1
