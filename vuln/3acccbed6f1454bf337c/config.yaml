id: 3acccbed6f1454bf337c
bug_link: https://syzkaller.appspot.com/bug?extid=3acccbed6f1454bf337c
title: 'WARNING: ODEBUG bug in bdev_super_lock (2)'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 3ff56e285de5a375fbfab3c3f1af81bbd23db36d
fix_commit: 22650a99821dda3d05f1c334ea90330b4982de56
datetime: '2024-03-27T13:17:15+01:00'
fix_commit_message: 'fs,block: yield devices early


  Currently a device is only really released once the umount returns to

  userspace due to how file closing works. That ultimately could cause

  an old umount assumption to be violated that concurrent umount and mount

  don''t fail. So an exclusively held device with a temporary holder should

  be yielded before the filesystem is gone. Add a helper that allows

  callers to do that. This also allows us to remove the two holder ops

  that Linus wasn''t excited about.


  Link: https://lore.kernel.org/r/20240326-vfs-bdev-end_holder-v1-1-20af85202918@kernel.org

  Fixes: f3a608827d1f ("bdev: open block device as files") # mainline only

  Reviewed-by: Christoph Hellwig <hch@lst.de>

  Reviewed-by: Jan Kara <jack@suse.cz>

  Suggested-by: Linus Torvalds <torvalds@linux-foundation.org>

  Signed-off-by: Christian Brauner <brauner@kernel.org>

  '
submodule:
- block
- drivers/mtd/devices
- fs
- fs/bcachefs
- fs/cramfs
- fs/ext4
- fs/f2fs
- fs/jfs
- fs/reiserfs
- fs/romfs
- fs/xfs
- include/linux
hunk_count: 29
covered_count: 1
