id: 3b6b9ff7b80430020c7b
bug_link: https://syzkaller.appspot.com/bug?extid=3b6b9ff7b80430020c7b
title: 'KMSAN: uninit-value in usbnet_probe (3)'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: e45b7196df60a4aef86c3998611c91fcc93d21f3
fix_commit: 405b0d610745fb5e84fc2961d9b960abb9f3d107
datetime: '2025-05-26T15:56:21+02:00'
fix_commit_message: "net: usb: aqc111: fix error handling of usbnet read calls\n\n\
  Syzkaller, courtesy of syzbot, identified an error (see report [1]) in\naqc111 driver,\
  \ caused by incomplete sanitation of usb read calls'\nresults. This problem is quite\
  \ similar to the one fixed in commit\n920a9fa27e78 (\"net: asix: add proper error\
  \ handling of usb read errors\").\n\nFor instance, usbnet_read_cmd() may read fewer\
  \ than 'size' bytes,\neven if the caller expected the full amount, and aqc111_read_cmd()\n\
  will not check its result properly. As [1] shows, this may lead\nto MAC address\
  \ in aqc111_bind() being only partly initialized,\ntriggering KMSAN warnings.\n\n\
  Fix the issue by verifying that the number of bytes read is\nas expected and not\
  \ less.\n\n[1] Partial syzbot report:\nBUG: KMSAN: uninit-value in is_valid_ether_addr\
  \ include/linux/etherdevice.h:208 [inline]\nBUG: KMSAN: uninit-value in usbnet_probe+0x2e57/0x4390\
  \ drivers/net/usb/usbnet.c:1830\n is_valid_ether_addr include/linux/etherdevice.h:208\
  \ [inline]\n usbnet_probe+0x2e57/0x4390 drivers/net/usb/usbnet.c:1830\n usb_probe_interface+0xd01/0x1310\
  \ drivers/usb/core/driver.c:396\n call_driver_probe drivers/base/dd.c:-1 [inline]\n\
  \ really_probe+0x4d1/0xd90 drivers/base/dd.c:658\n __driver_probe_device+0x268/0x380\
  \ drivers/base/dd.c:800\n...\n\nUninit was stored to memory at:\n dev_addr_mod+0xb0/0x550\
  \ net/core/dev_addr_lists.c:582\n __dev_addr_set include/linux/netdevice.h:4874\
  \ [inline]\n eth_hw_addr_set include/linux/etherdevice.h:325 [inline]\n aqc111_bind+0x35f/0x1150\
  \ drivers/net/usb/aqc111.c:717\n usbnet_probe+0xbe6/0x4390 drivers/net/usb/usbnet.c:1772\n\
  \ usb_probe_interface+0xd01/0x1310 drivers/usb/core/driver.c:396\n...\n\nUninit\
  \ was stored to memory at:\n ether_addr_copy include/linux/etherdevice.h:305 [inline]\n\
  \ aqc111_read_perm_mac drivers/net/usb/aqc111.c:663 [inline]\n aqc111_bind+0x794/0x1150\
  \ drivers/net/usb/aqc111.c:713\n usbnet_probe+0xbe6/0x4390 drivers/net/usb/usbnet.c:1772\n\
  \ usb_probe_interface+0xd01/0x1310 drivers/usb/core/driver.c:396\n call_driver_probe\
  \ drivers/base/dd.c:-1 [inline]\n...\n\nLocal variable buf.i created at:\n aqc111_read_perm_mac\
  \ drivers/net/usb/aqc111.c:656 [inline]\n aqc111_bind+0x221/0x1150 drivers/net/usb/aqc111.c:713\n\
  \ usbnet_probe+0xbe6/0x4390 drivers/net/usb/usbnet.c:1772\n\nReported-by: syzbot+3b6b9ff7b80430020c7b@syzkaller.appspotmail.com\n\
  Closes: https://syzkaller.appspot.com/bug?extid=3b6b9ff7b80430020c7b\nTested-by:\
  \ syzbot+3b6b9ff7b80430020c7b@syzkaller.appspotmail.com\nFixes: df2d59a2ab6c (\"\
  net: usb: aqc111: Add support for getting and setting of MAC address\")\nSigned-off-by:\
  \ Nikita Zhandarovich <n.zhandarovich@fintech.ru>\nLink: https://patch.msgid.link/20250520113240.2369438-1-n.zhandarovich@fintech.ru\n\
  Signed-off-by: Paolo Abeni <pabeni@redhat.com>\n\n"
submodule:
- drivers/net/usb
hunk_count: 2
covered_count: 2
