id: 5b82f0e951f8c2bcdb8f
bug_link: https://syzkaller.appspot.com/bug?extid=5b82f0e951f8c2bcdb8f
title: general protection fault in btrfs_finish_ordered_extent
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 17b17fcd6d446b95904a6929c40012ee7f0afc0c
fix_commit: 7cad645ebf20d777b2a48750ebd80fd81593b78c
datetime: '2023-07-18T03:14:01+02:00'
fix_commit_message: 'btrfs: fix ordered extent split error handling in btrfs_dio_submit_io


  When the call to btrfs_extract_ordered_extent in btrfs_dio_submit_io

  fails to allocate memory for a new ordered_extent, it calls into the

  btrfs_dio_end_io for error handling.  btrfs_dio_end_io then assumes that

  bbio->ordered is set because it is supposed to be at this point, except

  for this error handling corner case.  Try to not overload the

  btrfs_dio_end_io with error handling of a bio in a non-canonical state,

  and instead call btrfs_finish_ordered_extent and iomap_dio_bio_end_io

  directly for this error case.


  Reported-by: syzbot <syzbot+5b82f0e951f8c2bcdb8f@syzkaller.appspotmail.com>

  Fixes: b41b6f6937dc ("btrfs: use btrfs_finish_ordered_extent to complete direct
  writes")

  Reviewed-by: Josef Bacik <josef@toxicpanda.com>

  Tested-by: syzbot <syzbot+5b82f0e951f8c2bcdb8f@syzkaller.appspotmail.com>

  Signed-off-by: Christoph Hellwig <hch@lst.de>

  Signed-off-by: David Sterba <dsterba@suse.com>

  '
submodule:
- fs/btrfs
hunk_count: 1
covered_count: 1
