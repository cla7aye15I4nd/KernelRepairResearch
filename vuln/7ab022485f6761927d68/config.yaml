id: 7ab022485f6761927d68
bug_link: https://syzkaller.appspot.com/bug?extid=7ab022485f6761927d68
title: 'INFO: task can''t die in __bio_queue_enter'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 438cd74223c0029cd7409ca99aaf92e0972f3557
fix_commit: 10f7335e3627b4efa341ef8ac457f2c0770c5c19
datetime: '2021-11-11T11:52:33-07:00'
fix_commit_message: 'blk-mq: don''t grab ->q_usage_counter in blk_mq_sched_bio_merge


  blk_mq_sched_bio_merge is only called from blk-mq.c:blk_attempt_bio_merge(),

  which is called when queue usage counter is grabbed already:


  1) blk_mq_get_new_requests()


  2) blk_mq_get_request()

  - cached request in current plug owns one queue usage counter


  So don''t grab ->q_usage_counter in blk_mq_sched_bio_merge(), and more

  importantly this nest way causes hang in blk_mq_freeze_queue_wait().


  Cc: Christoph Hellwig <hch@lst.de>

  Signed-off-by: Ming Lei <ming.lei@redhat.com>

  Reviewed-by: Christoph Hellwig <hch@lst.de>

  Link: https://lore.kernel.org/r/20211111085134.345235-2-ming.lei@redhat.com

  Signed-off-by: Jens Axboe <axboe@kernel.dk>

  '
submodule:
- block
hunk_count: 2
covered_count: 0
