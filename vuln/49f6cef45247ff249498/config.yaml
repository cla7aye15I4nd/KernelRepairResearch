id: 49f6cef45247ff249498
bug_link: https://syzkaller.appspot.com/bug?extid=49f6cef45247ff249498
title: WARNING in sock_map_del_link
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 23acb14af1914010dd0aae1bbb7fab28bf518b8e
fix_commit: 8c5c2a4898e3d6bad86e29d471e023c8a19ba799
datetime: '2023-04-13T20:36:32+02:00'
fix_commit_message: "bpf, sockmap: Revert buggy deadlock fix in the sockhash and sockmap\n\
  \nsyzbot reported a splat and bisected it to recent commit ed17aa92dc56 (\"bpf,\n\
  sockmap: fix deadlocks in the sockhash and sockmap\"):\n\n  [...]\n  WARNING: CPU:\
  \ 1 PID: 9280 at kernel/softirq.c:376 __local_bh_enable_ip+0xbe/0x130 kernel/softirq.c:376\n\
  \  Modules linked in:\n  CPU: 1 PID: 9280 Comm: syz-executor.1 Not tainted 6.2.0-syzkaller-13249-gd319f344561d\
  \ #0\n  Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS\
  \ Google 03/30/2023\n  RIP: 0010:__local_bh_enable_ip+0xbe/0x130 kernel/softirq.c:376\n\
  \  [...]\n  Call Trace:\n  <TASK>\n  spin_unlock_bh include/linux/spinlock.h:395\
  \ [inline]\n  sock_map_del_link+0x2ea/0x510 net/core/sock_map.c:165\n  sock_map_unref+0xb0/0x1d0\
  \ net/core/sock_map.c:184\n  sock_hash_delete_elem+0x1ec/0x2a0 net/core/sock_map.c:945\n\
  \  map_delete_elem kernel/bpf/syscall.c:1536 [inline]\n  __sys_bpf+0x2edc/0x53e0\
  \ kernel/bpf/syscall.c:5053\n  __do_sys_bpf kernel/bpf/syscall.c:5166 [inline]\n\
  \  __se_sys_bpf kernel/bpf/syscall.c:5164 [inline]\n  __x64_sys_bpf+0x79/0xc0 kernel/bpf/syscall.c:5164\n\
  \  do_syscall_x64 arch/x86/entry/common.c:50 [inline]\n  do_syscall_64+0x39/0xb0\
  \ arch/x86/entry/common.c:80\n  entry_SYSCALL_64_after_hwframe+0x63/0xcd\n  RIP:\
  \ 0033:0x7fe8f7c8c169\n  </TASK>\n  [...]\n\nRevert for now until we have a proper\
  \ solution.\n\nFixes: ed17aa92dc56 (\"bpf, sockmap: fix deadlocks in the sockhash\
  \ and sockmap\")\nReported-by: syzbot+49f6cef45247ff249498@syzkaller.appspotmail.com\n\
  Cc: Hsin-Wei Hung <hsinweih@uci.edu>\nCc: Xin Liu <liuxin350@huawei.com>\nCc: John\
  \ Fastabend <john.fastabend@gmail.com>\nSigned-off-by: Daniel Borkmann <daniel@iogearbox.net>\n\
  Link: https://lore.kernel.org/bpf/000000000000f1db9605f939720e@google.com/\n"
submodule:
- net/core
hunk_count: 4
covered_count: 2
