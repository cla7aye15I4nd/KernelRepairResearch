id: 9319a4268a640e26b72b
bug_link: https://syzkaller.appspot.com/bug?extid=9319a4268a640e26b72b
title: WARNING in __mod_memcg_lruvec_state
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: e6b331ab0a716c1d9273383ae59c5b2eea5ac00d
fix_commit: 4f687281012e2da1a34cfe08ab10ea1361c600d2
datetime: '2024-05-11T15:41:35-07:00'
fix_commit_message: 'mm: do not update memcg stats for NR_{FILE/SHMEM}_PMDMAPPED


  Previously, all NR_VM_EVENT_ITEMS stats were maintained per-memcg,

  although some of those fields are not exposed anywhere. Commit

  14e0f6c957e39 ("memcg: reduce memory for the lruvec and memcg stats")

  changed this such that we only maintain the stats we actually expose

  per-memcg via a translation table.


  Additionally, commit 514462bbe927b ("memcg: warn for unexpected events

  and stats") added a warning if a per-memcg stat update is attempted for

  a stat that is not in the translation table. The warning started firing

  for the NR_{FILE/SHMEM}_PMDMAPPED stat updates in the rmap code. These

  stats are not maintained per-memcg, and hence are not in the translation

  table.


  Do not use __lruvec_stat_mod_folio() when updating NR_FILE_PMDMAPPED and

  NR_SHMEM_PMDMAPPED. Use __mod_node_page_state() instead, which updates

  the global per-node stats only.


  Link: https://lkml.kernel.org/r/20240506192924.271999-1-yosryahmed@google.com

  Fixes: 514462bbe927 ("memcg: warn for unexpected events and stats")

  Signed-off-by: Yosry Ahmed <yosryahmed@google.com>

  Reported-by: syzbot+9319a4268a640e26b72b@syzkaller.appspotmail.com

  Closes: https://lore.kernel.org/lkml/0000000000001b9d500617c8b23c@google.com

  Acked-by: Shakeel Butt <shakeel.butt@linux.dev>

  Acked-by: David Hildenbrand <david@redhat.com>

  Reviewed-by: Roman Gushchin <roman.gushchin@linux.dev>

  Cc: Johannes Weiner <hannes@cmpxchg.org>

  Cc: Michal Hocko <mhocko@kernel.org>

  Cc: Muchun Song <muchun.song@linux.dev>

  Signed-off-by: Andrew Morton <akpm@linux-foundation.org>

  '
submodule:
- mm
hunk_count: 3
covered_count: 2
