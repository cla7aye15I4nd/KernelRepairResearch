id: 3f960c64a104eaa2c813
bug_link: https://syzkaller.appspot.com/bug?extid=3f960c64a104eaa2c813
title: possible deadlock in peernet2id_alloc
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 8ae4dff882eb879c17bf46574201bd37fc6bc8b5
fix_commit: e1f469cd5866499ac40bfdca87411e1c525a10c7
datetime: '2020-09-07T14:32:39-07:00'
fix_commit_message: "Revert \"netns: don't disable BHs when locking \"nsid_lock\"\"\
  \n\nThis reverts commit 8d7e5dee972f1cde2ba96c621f1541fa36e7d4f4.\n\nTo protect\
  \ netns id, the nsid_lock is used when netns id is being\nallocated and removed\
  \ by peernet2id_alloc() and unhash_nsid().\nThe nsid_lock can be used in BH context\
  \ but only spin_lock() is used\nin this code.\nUsing spin_lock() instead of spin_lock_bh()\
  \ can result in a deadlock in\nthe following scenario reported by the lockdep.\n\
  In order to avoid a deadlock, the spin_lock_bh() should be used instead\nof spin_lock()\
  \ to acquire nsid_lock.\n\nTest commands:\n    ip netns del nst\n    ip netns add\
  \ nst\n    ip link add veth1 type veth peer name veth2\n    ip link set veth1 netns\
  \ nst\n    ip netns exec nst ip link add name br1 type bridge vlan_filtering 1\n\
  \    ip netns exec nst ip link set dev br1 up\n    ip netns exec nst ip link set\
  \ dev veth1 master br1\n    ip netns exec nst ip link set dev veth1 up\n    ip netns\
  \ exec nst ip link add macvlan0 link br1 up type macvlan\n\nSplat looks like:\n\
  [   33.615860][  T607] WARNING: SOFTIRQ-safe -> SOFTIRQ-unsafe lock order detected\n\
  [   33.617194][  T607] 5.9.0-rc1+ #665 Not tainted\n[ ... ]\n[   33.670615][  T607]\
  \ Chain exists of:\n[   33.670615][  T607]   &mc->mca_lock --> &bridge_netdev_addr_lock_key\
  \ --> &net->nsid_lock\n[   33.670615][  T607]\n[   33.673118][  T607]  Possible\
  \ interrupt unsafe locking scenario:\n[   33.673118][  T607]\n[   33.674599][  T607]\
  \        CPU0                    CPU1\n[   33.675557][  T607]        ----      \
  \              ----\n[   33.676516][  T607]   lock(&net->nsid_lock);\n[   33.677306][\
  \  T607]                                local_irq_disable();\n[   33.678517][  T607]\
  \                                lock(&mc->mca_lock);\n[   33.679725][  T607]  \
  \                              lock(&bridge_netdev_addr_lock_key);\n[   33.681166][\
  \  T607]   <Interrupt>\n[   33.681791][  T607]     lock(&mc->mca_lock);\n[   33.682579][\
  \  T607]\n[   33.682579][  T607]  *** DEADLOCK ***\n[ ... ]\n[   33.922046][  T607]\
  \ stack backtrace:\n[   33.922999][  T607] CPU: 3 PID: 607 Comm: ip Not tainted\
  \ 5.9.0-rc1+ #665\n[   33.924099][  T607] Hardware name: QEMU Standard PC (i440FX\
  \ + PIIX, 1996), BIOS 1.10.2-1ubuntu1 04/01/2014\n[   33.925714][  T607] Call Trace:\n\
  [   33.926238][  T607]  dump_stack+0x78/0xab\n[   33.926905][  T607]  check_irq_usage+0x70b/0x720\n\
  [   33.927708][  T607]  ? iterate_chain_key+0x60/0x60\n[   33.928507][  T607]  ?\
  \ check_path+0x22/0x40\n[   33.929201][  T607]  ? check_noncircular+0xcf/0x180\n\
  [   33.930024][  T607]  ? __lock_acquire+0x1952/0x1f20\n[   33.930860][  T607] \
  \ __lock_acquire+0x1952/0x1f20\n[   33.931667][  T607]  lock_acquire+0xaf/0x3a0\n\
  [   33.932366][  T607]  ? peernet2id_alloc+0x3a/0x170\n[   33.933147][  T607]  ?\
  \ br_port_fill_attrs+0x54c/0x6b0 [bridge]\n[   33.934140][  T607]  ? br_port_fill_attrs+0x5de/0x6b0\
  \ [bridge]\n[   33.935113][  T607]  ? kvm_sched_clock_read+0x14/0x30\n[   33.935974][\
  \  T607]  _raw_spin_lock+0x30/0x70\n[   33.936728][  T607]  ? peernet2id_alloc+0x3a/0x170\n\
  [   33.937523][  T607]  peernet2id_alloc+0x3a/0x170\n[   33.938313][  T607]  rtnl_fill_ifinfo+0xb5e/0x1400\n\
  [   33.939091][  T607]  rtmsg_ifinfo_build_skb+0x8a/0xf0\n[   33.939953][  T607]\
  \  rtmsg_ifinfo_event.part.39+0x17/0x50\n[   33.940863][  T607]  rtmsg_ifinfo+0x1f/0x30\n\
  [   33.941571][  T607]  __dev_notify_flags+0xa5/0xf0\n[   33.942376][  T607]  ?\
  \ __irq_work_queue_local+0x49/0x50\n[   33.943249][  T607]  ? irq_work_queue+0x1d/0x30\n\
  [   33.943993][  T607]  ? __dev_set_promiscuity+0x7b/0x1a0\n[   33.944878][  T607]\
  \  __dev_set_promiscuity+0x7b/0x1a0\n[   33.945758][  T607]  dev_set_promiscuity+0x1e/0x50\n\
  [   33.946582][  T607]  br_port_set_promisc+0x1f/0x40 [bridge]\n[   33.947487][\
  \  T607]  br_manage_promisc+0x8b/0xe0 [bridge]\n[   33.948388][  T607]  __dev_set_promiscuity+0x123/0x1a0\n\
  [   33.949244][  T607]  __dev_set_rx_mode+0x68/0x90\n[   33.950021][  T607]  dev_uc_add+0x50/0x60\n\
  [   33.950720][  T607]  macvlan_open+0x18e/0x1f0 [macvlan]\n[   33.951601][  T607]\
  \  __dev_open+0xd6/0x170\n[   33.952269][  T607]  __dev_change_flags+0x181/0x1d0\n\
  [   33.953056][  T607]  rtnl_configure_link+0x2f/0xa0\n[   33.953884][  T607]  __rtnl_newlink+0x6b9/0x8e0\n\
  [   33.954665][  T607]  ? __lock_acquire+0x95d/0x1f20\n[   33.955450][  T607]  ?\
  \ lock_acquire+0xaf/0x3a0\n[   33.956193][  T607]  ? is_bpf_text_address+0x5/0xe0\n\
  [   33.956999][  T607]  rtnl_newlink+0x47/0x70\n\nAcked-by: Guillaume Nault <gnault@redhat.com>\n\
  Fixes: 8d7e5dee972f (\"netns: don't disable BHs when locking \"nsid_lock\"\")\n\
  Reported-by: syzbot+3f960c64a104eaa2c813@syzkaller.appspotmail.com\nSigned-off-by:\
  \ Taehee Yoo <ap420073@gmail.com>\nSigned-off-by: Jakub Kicinski <kuba@kernel.org>\n"
submodule:
- net/core
hunk_count: 5
covered_count: 2
