id: ac0bc3a70282b4d586cc
bug_link: https://syzkaller.appspot.com/bug?extid=ac0bc3a70282b4d586cc
title: WARNING in vmx_handle_exit (2)
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 61146f67e4cb67064ce3003d94ee19302d314fff
fix_commit: 64c947a1cf351989245ba83eb0587645c8d0c482
datetime: '2025-02-28T09:15:47-08:00'
fix_commit_message: "KVM: VMX: Reject KVM_RUN if userspace forces emulation during\
  \ nested VM-Enter\n\nExtend KVM's restrictions on userspace forcing \"emulation\
  \ required\" at odd\ntimes to cover stuffing invalid guest state while a nested\
  \ run is pending.\nClobbering guest state while KVM is in the middle of emulating\
  \ VM-Enter is\nnonsensical, as it puts the vCPU into an architecturally impossible\
  \ state,\nand will trip KVM's sanity check that guards against KVM bugs, e.g. helps\n\
  detect missed VMX consistency checks.\n\n  WARNING: CPU: 3 PID: 6336 at arch/x86/kvm/vmx/vmx.c:6480\
  \ __vmx_handle_exit arch/x86/kvm/vmx/vmx.c:6480 [inline]\n  WARNING: CPU: 3 PID:\
  \ 6336 at arch/x86/kvm/vmx/vmx.c:6480 vmx_handle_exit+0x40f/0x1f70 arch/x86/kvm/vmx/vmx.c:6637\n\
  \  Modules linked in:\n  CPU: 3 UID: 0 PID: 6336 Comm: syz.0.73 Not tainted 6.13.0-rc1-syzkaller-00316-gb5f217084ab3\
  \ #0\n  Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-debian-1.16.3-2~bpo12+1\
  \ 04/01/2014\n  RIP: 0010:__vmx_handle_exit arch/x86/kvm/vmx/vmx.c:6480 [inline]\n\
  \  RIP: 0010:vmx_handle_exit+0x40f/0x1f70 arch/x86/kvm/vmx/vmx.c:6637\n   <TASK>\n\
  \   vcpu_enter_guest arch/x86/kvm/x86.c:11081 [inline]\n   vcpu_run+0x3047/0x4f50\
  \ arch/x86/kvm/x86.c:11242\n   kvm_arch_vcpu_ioctl_run+0x44a/0x1740 arch/x86/kvm/x86.c:11560\n\
  \   kvm_vcpu_ioctl+0x6ce/0x1520 virt/kvm/kvm_main.c:4340\n   vfs_ioctl fs/ioctl.c:51\
  \ [inline]\n   __do_sys_ioctl fs/ioctl.c:906 [inline]\n   __se_sys_ioctl fs/ioctl.c:892\
  \ [inline]\n   __x64_sys_ioctl+0x190/0x200 fs/ioctl.c:892\n   do_syscall_x64 arch/x86/entry/common.c:52\
  \ [inline]\n   do_syscall_64+0xcd/0x250 arch/x86/entry/common.c:83\n   entry_SYSCALL_64_after_hwframe+0x77/0x7f\n\
  \   </TASK>\n\nReported-by: syzbot+ac0bc3a70282b4d586cc@syzkaller.appspotmail.com\n\
  Closes: https://lore.kernel.org/all/67598fb9.050a0220.17f54a.003b.GAE@google.com\n\
  Debugged-by: James Houghton <jthoughton@google.com>\nTested-by: James Houghton <jthoughton@google.com>\n\
  Link: https://lore.kernel.org/r/20250224171409.2348647-1-seanjc@google.com\nSigned-off-by:\
  \ Sean Christopherson <seanjc@google.com>\n"
submodule:
- arch/x86/kvm/vmx
hunk_count: 3
covered_count: 0
