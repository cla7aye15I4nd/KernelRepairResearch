id: 32c3706ebf5d95046ea1
bug_link: https://syzkaller.appspot.com/bug?extid=32c3706ebf5d95046ea1
title: kernel BUG in nilfs_delete_entry
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 28097f7ba18753f7120bbd460bb2d099276dec8b
fix_commit: ee70999a988b8abc3490609142f50ebaa8344432
datetime: '2025-01-24T22:47:25-08:00'
fix_commit_message: 'nilfs2: handle errors that nilfs_prepare_chunk() may return


  Patch series "nilfs2: fix issues with rename operations".


  This series fixes BUG_ON check failures reported by syzbot around rename

  operations, and a minor behavioral issue where the mtime of a child

  directory changes when it is renamed instead of moved.



  This patch (of 2):


  The directory manipulation routines nilfs_set_link() and

  nilfs_delete_entry() rewrite the directory entry in the folio/page

  previously read by nilfs_find_entry(), so error handling is omitted on the

  assumption that nilfs_prepare_chunk(), which prepares the buffer for

  rewriting, will always succeed for these.  And if an error is returned, it

  triggers the legacy BUG_ON() checks in each routine.


  This assumption is wrong, as proven by syzbot: the buffer layer called by

  nilfs_prepare_chunk() may call nilfs_get_block() if necessary, which may

  fail due to metadata corruption or other reasons.  This has been there all

  along, but improved sanity checks and error handling may have made it more

  reproducible in fuzzing tests.


  Fix this issue by adding missing error paths in nilfs_set_link(),

  nilfs_delete_entry(), and their caller nilfs_rename().


  Link: https://lkml.kernel.org/r/20250111143518.7901-1-konishi.ryusuke@gmail.com

  Link: https://lkml.kernel.org/r/20250111143518.7901-2-konishi.ryusuke@gmail.com

  Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>

  Reported-by: syzbot+32c3706ebf5d95046ea1@syzkaller.appspotmail.com

  Closes: https://syzkaller.appspot.com/bug?extid=32c3706ebf5d95046ea1

  Reported-by: syzbot+1097e95f134f37d9395c@syzkaller.appspotmail.com

  Closes: https://syzkaller.appspot.com/bug?extid=1097e95f134f37d9395c

  Fixes: 2ba466d74ed7 ("nilfs2: directory entry operations")

  Signed-off-by: Andrew Morton <akpm@linux-foundation.org>

  '
submodule:
- fs/nilfs2
hunk_count: 6
covered_count: 3
