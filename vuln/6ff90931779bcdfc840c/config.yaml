id: 6ff90931779bcdfc840c
bug_link: https://syzkaller.appspot.com/bug?extid=6ff90931779bcdfc840c
title: possible deadlock in __mmap_lock_do_trace_start_locking
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: b1a80f4be7691a1ea007e24ebb3c8ca2e4a20f00
fix_commit: 7d6be67cfdd4a53cea7147313ca13c531e3a470f
datetime: '2024-07-03T19:30:26-07:00'
fix_commit_message: "mm: mmap_lock: replace get_memcg_path_buf() with on-stack buffer\n\
  \nCommit 2b5067a8143e (\"mm: mmap_lock: add tracepoints around lock\nacquisition\"\
  ) introduced TRACE_MMAP_LOCK_EVENT() macro using\npreempt_disable() in order to\
  \ let get_mm_memcg_path() return a percpu\nbuffer exclusively used by normal, softirq,\
  \ irq and NMI contexts\nrespectively.\n\nCommit 832b50725373 (\"mm: mmap_lock: use\
  \ local locks instead of disabling\npreemption\") replaced preempt_disable() with\
  \ local_lock(&memcg_paths.lock)\nbased on an argument that preempt_disable() has\
  \ to be avoided because\nget_mm_memcg_path() might sleep if PREEMPT_RT=y.\n\nBut\
  \ syzbot started reporting\n\n  inconsistent {HARDIRQ-ON-W} -> {IN-HARDIRQ-W} usage.\n\
  \nand\n\n  inconsistent {SOFTIRQ-ON-W} -> {IN-SOFTIRQ-W} usage.\n\nmessages, for\
  \ local_lock() does not disable IRQ.\n\nWe could replace local_lock() with local_lock_irqsave()\
  \ in order to\nsuppress these messages.  But this patch instead replaces percpu\
  \ buffers\nwith on-stack buffer, for the size of each buffer returned by\nget_memcg_path_buf()\
  \ is only 256 bytes which is tolerable for allocating\nfrom current thread's kernel\
  \ stack memory.\n\nLink: https://lkml.kernel.org/r/ef22d289-eadb-4ed9-863b-fbc922b33d8d@I-love.SAKURA.ne.jp\n\
  Reported-by: syzbot <syzbot+40905bca570ae6784745@syzkaller.appspotmail.com>\nCloses:\
  \ https://syzkaller.appspot.com/bug?extid=40905bca570ae6784745\nFixes: 832b50725373\
  \ (\"mm: mmap_lock: use local locks instead of disabling preemption\")\nSigned-off-by:\
  \ Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp>\nReviewed-by: Axel Rasmussen\
  \ <axelrasmussen@google.com>\nCc: Nicolas Saenz Julienne <nsaenzju@redhat.com>\n\
  Cc: <stable@vger.kernel.org>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\n"
submodule:
- mm
hunk_count: 3
covered_count: 3
