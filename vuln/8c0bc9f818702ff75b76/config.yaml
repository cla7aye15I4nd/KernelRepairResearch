id: 8c0bc9f818702ff75b76
bug_link: https://syzkaller.appspot.com/bug?extid=8c0bc9f818702ff75b76
title: WARNING in hfsplus_free_extents
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 4c831f30475a222046ded25560c3810117a6cff6
fix_commit: fcb96956c921f1aae7e7b477f2435c56f77a31b4
datetime: '2025-07-06T17:54:34-07:00'
fix_commit_message: "hfsplus: remove mutex_lock check in hfsplus_free_extents\n\n\
  Syzbot reported an issue in hfsplus filesystem:\n\n------------[ cut here ]------------\n\
  WARNING: CPU: 0 PID: 4400 at fs/hfsplus/extents.c:346\n\thfsplus_free_extents+0x700/0xad0\n\
  Call Trace:\n<TASK>\nhfsplus_file_truncate+0x768/0xbb0 fs/hfsplus/extents.c:606\n\
  hfsplus_write_begin+0xc2/0xd0 fs/hfsplus/inode.c:56\ncont_expand_zero fs/buffer.c:2383\
  \ [inline]\ncont_write_begin+0x2cf/0x860 fs/buffer.c:2446\nhfsplus_write_begin+0x86/0xd0\
  \ fs/hfsplus/inode.c:52\ngeneric_cont_expand_simple+0x151/0x250 fs/buffer.c:2347\n\
  hfsplus_setattr+0x168/0x280 fs/hfsplus/inode.c:263\nnotify_change+0xe38/0x10f0 fs/attr.c:420\n\
  do_truncate+0x1fb/0x2e0 fs/open.c:65\ndo_sys_ftruncate+0x2eb/0x380 fs/open.c:193\n\
  do_syscall_x64 arch/x86/entry/common.c:50 [inline]\ndo_syscall_64+0x3d/0xb0 arch/x86/entry/common.c:80\n\
  entry_SYSCALL_64_after_hwframe+0x63/0xcd\n\nTo avoid deadlock, Commit 31651c607151\
  \ (\"hfsplus: avoid deadlock\non file truncation\") unlock extree before hfsplus_free_extents(),\n\
  and add check wheather extree is locked in hfsplus_free_extents().\n\nHowever, when\
  \ operations such as hfsplus_file_release,\nhfsplus_setattr, hfsplus_unlink, and\
  \ hfsplus_get_block are executed\nconcurrently in different files, it is very likely\
  \ to trigger the\nWARN_ON, which will lead syzbot and xfstest to consider it as\
  \ an\nabnormality.\n\nThe comment above this warning also describes one of the easy\n\
  triggering situations, which can easily trigger and cause\nxfstest&syzbot to report\
  \ errors.\n\n[task A]\t\t\t[task B]\n->hfsplus_file_release\n  ->hfsplus_file_truncate\n\
  \    ->hfs_find_init\n      ->mutex_lock\n    ->mutex_unlock\n\t\t\t\t->hfsplus_write_begin\n\
  \t\t\t\t  ->hfsplus_get_block\n\t\t\t\t    ->hfsplus_file_extend\n\t\t\t\t     \
  \ ->hfsplus_ext_read_extent\n\t\t\t\t        ->hfs_find_init\n\t\t\t\t\t  ->mutex_lock\n\
  \    ->hfsplus_free_extents\n      WARN_ON(mutex_is_locked) !!!\n\nSeveral threads\
  \ could try to lock the shared extents tree.\nAnd warning can be triggered in one\
  \ thread when another thread\nhas locked the tree. This is the wrong behavior of\
  \ the code and\nwe need to remove the warning.\n\nFixes: 31651c607151f (\"hfsplus:\
  \ avoid deadlock on file truncation\")\nReported-by: syzbot+8c0bc9f818702ff75b76@syzkaller.appspotmail.com\n\
  Closes: https://lore.kernel.org/all/00000000000057fa4605ef101c4c@google.com/\nSigned-off-by:\
  \ Yangtao Li <frank.li@vivo.com>\nReviewed-by: Viacheslav Dubeyko <slava@dubeyko.com>\n\
  Signed-off-by: Viacheslav Dubeyko <slava@dubeyko.com>\nLink: https://lore.kernel.org/r/20250529061807.2213498-1-frank.li@vivo.com\n\
  Signed-off-by: Viacheslav Dubeyko <slava@dubeyko.com>\n"
submodule:
- fs/hfsplus
hunk_count: 1
covered_count: 1
