id: 27d62ee6f256b186883e
bug_link: https://syzkaller.appspot.com/bug?extid=27d62ee6f256b186883e
title: 'INFO: task hung in io_wqe_worker'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: f75d118349be055d47407b4ba4ceb98e6437e472
fix_commit: 1d5f5ea7cb7d15b9fb1cc82673ebb054f02cd7d2
datetime: '2021-10-29T09:49:33-06:00'
fix_commit_message: "io-wq: remove worker to owner tw dependency\n\nINFO: task iou-wrk-6609:6612\
  \ blocked for more than 143 seconds.\n      Not tainted 5.15.0-rc5-syzkaller #0\n\
  \"echo 0 > /proc/sys/kernel/hung_task_timeout_secs\" disables this message.\ntask:iou-wrk-6609\
  \    state:D stack:27944 pid: 6612 ppid:  6526 flags:0x00004006\nCall Trace:\n context_switch\
  \ kernel/sched/core.c:4940 [inline]\n __schedule+0xb44/0x5960 kernel/sched/core.c:6287\n\
  \ schedule+0xd3/0x270 kernel/sched/core.c:6366\n schedule_timeout+0x1db/0x2a0 kernel/time/timer.c:1857\n\
  \ do_wait_for_common kernel/sched/completion.c:85 [inline]\n __wait_for_common kernel/sched/completion.c:106\
  \ [inline]\n wait_for_common kernel/sched/completion.c:117 [inline]\n wait_for_completion+0x176/0x280\
  \ kernel/sched/completion.c:138\n io_worker_exit fs/io-wq.c:183 [inline]\n io_wqe_worker+0x66d/0xc40\
  \ fs/io-wq.c:597\n ret_from_fork+0x1f/0x30 arch/x86/entry/entry_64.S:295\n\nio-wq\
  \ worker may submit a task_work to the master task and upon\nio_worker_exit() wait\
  \ for the tw to get executed. The problem appears\nwhen the master task is waiting\
  \ in coredump.c:\n\n468                     freezer_do_not_count();\n469       \
  \              wait_for_completion(&core_state->startup);\n470                 \
  \    freezer_count();\n\nApparently having some dependency on children threads getting\
  \ everything\nstuck. Workaround it by cancelling the taks_work callback that causes\
  \ it\nbefore going into io_worker_exit() waiting.\n\np.s. probably a better option\
  \ is to not submit tw elevating the refcount\nin the first place, but let's leave\
  \ this excercise for the future.\n\nCc: stable@vger.kernel.org\nReported-and-tested-by:\
  \ syzbot+27d62ee6f256b186883e@syzkaller.appspotmail.com\nSigned-off-by: Pavel Begunkov\
  \ <asml.silence@gmail.com>\nLink: https://lore.kernel.org/r/142a716f4ed936feae868959059154362bfa8c19.1635509451.git.asml.silence@gmail.com\n\
  Signed-off-by: Jens Axboe <axboe@kernel.dk>\n"
submodule:
- fs
hunk_count: 3
covered_count: 2
