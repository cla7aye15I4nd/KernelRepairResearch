id: 8c469a2260132cd095c1
bug_link: https://syzkaller.appspot.com/bug?extid=8c469a2260132cd095c1
title: WARNING in udp_tunnel_update_gro_rcv
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: b65999e7238e6f2a48dc77c8c2109c48318ff41b
fix_commit: c26c192c3d486a2a7d83d254bae294c2f8f50abf
datetime: '2025-04-14T14:29:01-07:00'
fix_commit_message: "udp: properly deal with xfrm encap and ADDRFORM\n\nUDP GRO accounting\
  \ assumes that the GRO receive callback is always\nset when the UDP tunnel is enabled,\
  \ but syzkaller proved otherwise,\nleading tot the following splat:\n\nWARNING:\
  \ CPU: 0 PID: 5837 at net/ipv4/udp_offload.c:123 udp_tunnel_update_gro_rcv+0x28d/0x4c0\
  \ net/ipv4/udp_offload.c:123\nModules linked in:\nCPU: 0 UID: 0 PID: 5837 Comm:\
  \ syz-executor850 Not tainted 6.14.0-syzkaller-13320-g420aabef3ab5 #0 PREEMPT(full)\n\
  Hardware name: Google Compute Engine/Google Compute Engine, BIOS Google 02/12/2025\n\
  RIP: 0010:udp_tunnel_update_gro_rcv+0x28d/0x4c0 net/ipv4/udp_offload.c:123\nCode:\
  \ 00 00 e8 c6 5a 2f f7 48 c1 e5 04 48 8d b5 20 53 c7 9a ba 10\n      00 00 00 4c\
  \ 89 ff e8 ce 87 99 f7 e9 ce 00 00 00 e8 a4 5a 2f\n      f7 90 <0f> 0b 90 e9 de\
  \ fd ff ff bf 01 00 00 00 89 ee e8 cf\n      5e 2f f7 85 ed\nRSP: 0018:ffffc90003effa88\
  \ EFLAGS: 00010293\nRAX: ffffffff8a93fc9c RBX: 0000000000000000 RCX: ffff8880306f9e00\n\
  RDX: 0000000000000000 RSI: 0000000000000000 RDI: 0000000000000000\nRBP: 0000000000000000\
  \ R08: ffffffff8a93fabe R09: 1ffffffff20bfb2e\nR10: dffffc0000000000 R11: fffffbfff20bfb2f\
  \ R12: ffff88814ef21738\nR13: dffffc0000000000 R14: ffff88814ef21778 R15: 1ffff11029de42ef\n\
  FS:  0000000000000000(0000) GS:ffff888124f96000(0000) knlGS:0000000000000000\nCS:\
  \  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\nCR2: 00007f04eec760d0 CR3: 000000000eb38000\
  \ CR4: 00000000003526f0\nDR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000\n\
  DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400\nCall Trace:\n\
  \ <TASK>\n udp_tunnel_cleanup_gro include/net/udp_tunnel.h:205 [inline]\n udpv6_destroy_sock+0x212/0x270\
  \ net/ipv6/udp.c:1829\n sk_common_release+0x71/0x2e0 net/core/sock.c:3896\n inet_release+0x17d/0x200\
  \ net/ipv4/af_inet.c:435\n __sock_release net/socket.c:647 [inline]\n sock_close+0xbc/0x240\
  \ net/socket.c:1391\n __fput+0x3e9/0x9f0 fs/file_table.c:465\n task_work_run+0x251/0x310\
  \ kernel/task_work.c:227\n exit_task_work include/linux/task_work.h:40 [inline]\n\
  \ do_exit+0xa11/0x27f0 kernel/exit.c:953\n do_group_exit+0x207/0x2c0 kernel/exit.c:1102\n\
  \ __do_sys_exit_group kernel/exit.c:1113 [inline]\n __se_sys_exit_group kernel/exit.c:1111\
  \ [inline]\n __x64_sys_exit_group+0x3f/0x40 kernel/exit.c:1111\n x64_sys_call+0x26c3/0x26d0\
  \ arch/x86/include/generated/asm/syscalls_64.h:232\n do_syscall_x64 arch/x86/entry/syscall_64.c:63\
  \ [inline]\n do_syscall_64+0xf3/0x230 arch/x86/entry/syscall_64.c:94\n entry_SYSCALL_64_after_hwframe+0x77/0x7f\n\
  RIP: 0033:0x7f04eebfac79\nCode: Unable to access opcode bytes at 0x7f04eebfac4f.\n\
  RSP: 002b:00007fffdcaa34a8 EFLAGS: 00000246 ORIG_RAX: 00000000000000e7\nRAX: ffffffffffffffda\
  \ RBX: 0000000000000000 RCX: 00007f04eebfac79\nRDX: 000000000000003c RSI: 00000000000000e7\
  \ RDI: 0000000000000000\nRBP: 00007f04eec75270 R08: ffffffffffffffb8 R09: 00007fffdcaa36c8\n\
  R10: 0000200000000000 R11: 0000000000000246 R12: 00007f04eec75270\nR13: 0000000000000000\
  \ R14: 00007f04eec75cc0 R15: 00007f04eebcca70\n\nAddress the issue moving the accounting\
  \ hook into\nsetup_udp_tunnel_sock() and set_xfrm_gro_udp_encap_rcv(), where\nthe\
  \ GRO callback is actually set.\n\nset_xfrm_gro_udp_encap_rcv() is prone to races\
  \ with IPV6_ADDRFORM,\nrun the relevant setsockopt under the socket lock to ensure\
  \ using\nconsistent values of sk_family and up->encap_type.\n\nRefactor the GRO\
  \ callback selection code, to make it clear that\nthe function pointer is always\
  \ initialized.\n\nReported-by: syzbot+8c469a2260132cd095c1@syzkaller.appspotmail.com\n\
  Closes: https://syzkaller.appspot.com/bug?extid=8c469a2260132cd095c1\nFixes: 172bf009c18d\
  \ (\"xfrm: Support GRO for IPv4 ESP in UDP encapsulation\")\nFixes: 5d7f5b2f6b935\
  \ (\"udp_tunnel: use static call for GRO hooks when possible\")\nSigned-off-by:\
  \ Paolo Abeni <pabeni@redhat.com>\nReviewed-by: Sabrina Dubroca <sd@queasysnail.net>\n\
  Link: https://patch.msgid.link/92bcdb6899145a9a387c8fa9e3ca656642a43634.1744228733.git.pabeni@redhat.com\n\
  Signed-off-by: Jakub Kicinski <kuba@kernel.org>\n"
submodule:
- include/net
- net/ipv4
hunk_count: 6
covered_count: 1
