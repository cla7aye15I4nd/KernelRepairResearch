id: 3a0748c8f2f210c0ef9b
bug_link: https://syzkaller.appspot.com/bug?extid=3a0748c8f2f210c0ef9b
title: WARNING in smc_unhash_sk
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 000244d3dc1f8114e38fe9ee2d9a0986404d9cbe
fix_commit: e1bbdd57047454dad068dc36612dd60a57f4c58f
datetime: '2018-07-07T20:25:13+09:00'
fix_commit_message: 'net/smc: reduce sock_put() for fallback sockets


  smc_release() calls a sock_put() for smc fallback sockets to cover

  the passive closing sock_hold() in __smc_connect() and

  smc_tcp_listen_work(). This does not make sense for sockets in state

  SMC_LISTEN and SMC_INIT.

  An SMC socket stays in state SMC_INIT if connect fails. The sock_put

  in smc_connect_abort() does not cover all failures. Move it into

  smc_connect_decline_fallback().


  Fixes: ee9dfbef02d18 ("net/smc: handle sockopts forcing fallback")

  Reported-by: syzbot+3a0748c8f2f210c0ef9b@syzkaller.appspotmail.com

  Reported-by: syzbot+9e60d2428a42049a592a@syzkaller.appspotmail.com

  Signed-off-by: Ursula Braun <ubraun@linux.ibm.com>

  Signed-off-by: David S. Miller <davem@davemloft.net>

  '
submodule:
- net/smc
hunk_count: 4
covered_count: 1
