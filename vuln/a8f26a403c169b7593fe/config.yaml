id: a8f26a403c169b7593fe
bug_link: https://syzkaller.appspot.com/bug?extid=a8f26a403c169b7593fe
title: general protection fault in __d_add
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: e6c3cef24cb0d045f99d5cb039b344874e3cfd74
fix_commit: 254e69f284d7270e0abdc023ee53b71401c3ba0c
datetime: '2023-03-27T16:59:08+04:00'
fix_commit_message: "fs/ntfs3: Fix null-ptr-deref on inode->i_op in ntfs_lookup()\n\
  \nSyzbot reported a null-ptr-deref bug:\n\nntfs3: loop0: Different NTFS' sector\
  \ size (1024) and media sector size\n(512)\nntfs3: loop0: Mark volume as dirty due\
  \ to NTFS errors\ngeneral protection fault, probably for non-canonical address\n\
  0xdffffc0000000001: 0000 [#1] PREEMPT SMP KASAN\nKASAN: null-ptr-deref in range\
  \ [0x0000000000000008-0x000000000000000f]\nRIP: 0010:d_flags_for_inode fs/dcache.c:1980\
  \ [inline]\nRIP: 0010:__d_add+0x5ce/0x800 fs/dcache.c:2796\nCall Trace:\n <TASK>\n\
  \ d_splice_alias+0x122/0x3b0 fs/dcache.c:3191\n lookup_open fs/namei.c:3391 [inline]\n\
  \ open_last_lookups fs/namei.c:3481 [inline]\n path_openat+0x10e6/0x2df0 fs/namei.c:3688\n\
  \ do_filp_open+0x264/0x4f0 fs/namei.c:3718\n do_sys_openat2+0x124/0x4e0 fs/open.c:1310\n\
  \ do_sys_open fs/open.c:1326 [inline]\n __do_sys_open fs/open.c:1334 [inline]\n\
  \ __se_sys_open fs/open.c:1330 [inline]\n __x64_sys_open+0x221/0x270 fs/open.c:1330\n\
  \ do_syscall_x64 arch/x86/entry/common.c:50 [inline]\n do_syscall_64+0x3d/0xb0 arch/x86/entry/common.c:80\n\
  \ entry_SYSCALL_64_after_hwframe+0x63/0xcd\n\nIf the MFT record of ntfs inode is\
  \ not a base record, inode->i_op can be\nNULL. And a null-ptr-deref may happen:\n\
  \nntfs_lookup()\n    dir_search_u() # inode->i_op is set to NULL\n    d_splice_alias()\n\
  \        __d_add()\n            d_flags_for_inode() # inode->i_op->get_link null-ptr-deref\n\
  \nFix this by adding a Check on inode->i_op before calling the\nd_splice_alias()\
  \ function.\n\nFixes: 4342306f0f0d (\"fs/ntfs3: Add file operations and implementation\"\
  )\nReported-by: syzbot+a8f26a403c169b7593fe@syzkaller.appspotmail.com\nSigned-off-by:\
  \ ZhangPeng <zhangpeng362@huawei.com>\nSigned-off-by: Konstantin Komarov <almaz.alexandrovich@paragon-software.com>\n"
submodule:
- fs/ntfs3
hunk_count: 1
covered_count: 0
