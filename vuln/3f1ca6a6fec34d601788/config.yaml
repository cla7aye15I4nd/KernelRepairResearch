id: 3f1ca6a6fec34d601788
bug_link: https://syzkaller.appspot.com/bug?extid=3f1ca6a6fec34d601788
title: 'KASAN: out-of-bounds Read in ath9k_hif_usb_rx_cb (3)'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 8b3046abc99eefe11438090bcc4ec3a3994b55d0
fix_commit: 6ce708f54cc8d73beca213cec66ede5ce100a781
datetime: '2021-12-20T18:09:25+02:00'
fix_commit_message: "ath9k: Fix out-of-bound memcpy in ath9k_hif_usb_rx_stream\n\n\
  Large pkt_len can lead to out-out-bound memcpy. Current\nath9k_hif_usb_rx_stream\
  \ allows combining the content of two urb\ninputs to one pkt. The first input can\
  \ indicate the size of the\npkt. Any remaining size is saved in hif_dev->rx_remain_len.\n\
  While processing the next input, memcpy is used with rx_remain_len.\n\n4-byte pkt_len\
  \ can go up to 0xffff, while a single input is 0x4000\nmaximum in size (MAX_RX_BUF_SIZE).\
  \ Thus, the patch adds a check for\npkt_len which must not exceed 2 * MAX_RX_BUG_SIZE.\n\
  \nBUG: KASAN: slab-out-of-bounds in ath9k_hif_usb_rx_cb+0x490/0xed7 [ath9k_htc]\n\
  Read of size 46393 at addr ffff888018798000 by task kworker/0:1/23\n\nCPU: 0 PID:\
  \ 23 Comm: kworker/0:1 Not tainted 5.6.0 #63\nHardware name: QEMU Standard PC (i440FX\
  \ + PIIX, 1996),\nBIOS rel-1.10.2-0-g5f4c7b1-prebuilt.qemu-project.org 04/01/2014\n\
  Workqueue: events request_firmware_work_func\nCall Trace:\n <IRQ>\n dump_stack+0x76/0xa0\n\
  \ print_address_description.constprop.0+0x16/0x200\n ? ath9k_hif_usb_rx_cb+0x490/0xed7\
  \ [ath9k_htc]\n ? ath9k_hif_usb_rx_cb+0x490/0xed7 [ath9k_htc]\n __kasan_report.cold+0x37/0x7c\n\
  \ ? ath9k_hif_usb_rx_cb+0x490/0xed7 [ath9k_htc]\n kasan_report+0xe/0x20\n check_memory_region+0x15a/0x1d0\n\
  \ memcpy+0x20/0x50\n ath9k_hif_usb_rx_cb+0x490/0xed7 [ath9k_htc]\n ? hif_usb_mgmt_cb+0x2d9/0x2d9\
  \ [ath9k_htc]\n ? _raw_spin_lock_irqsave+0x7b/0xd0\n ? _raw_spin_trylock_bh+0x120/0x120\n\
  \ ? __usb_unanchor_urb+0x12f/0x210\n __usb_hcd_giveback_urb+0x1e4/0x380\n usb_giveback_urb_bh+0x241/0x4f0\n\
  \ ? __hrtimer_run_queues+0x316/0x740\n ? __usb_hcd_giveback_urb+0x380/0x380\n tasklet_action_common.isra.0+0x135/0x330\n\
  \ __do_softirq+0x18c/0x634\n irq_exit+0x114/0x140\n smp_apic_timer_interrupt+0xde/0x380\n\
  \ apic_timer_interrupt+0xf/0x20\n\nI found the bug using a custome USBFuzz port.\
  \ It's a research work\nto fuzz USB stack/drivers. I modified it to fuzz ath9k driver\
  \ only,\nproviding hand-crafted usb descriptors to QEMU.\n\nAfter fixing the value\
  \ of pkt_tag to ATH_USB_RX_STREAM_MODE_TAG in QEMU\nemulation, I found the KASAN\
  \ report. The bug is triggerable whenever\npkt_len is above two MAX_RX_BUG_SIZE.\
  \ I used the same input that crashes\nto test the driver works when applying the\
  \ patch.\n\nSigned-off-by: Zekun Shen <bruceshenzk@gmail.com>\nSigned-off-by: Kalle\
  \ Valo <quic_kvalo@quicinc.com>\nLink: https://lore.kernel.org/r/YXsidrRuK6zBJicZ@10-18-43-117.dynapool.wireless.nyu.edu\n"
submodule:
- drivers/net/wireless/ath/ath9k
hunk_count: 1
covered_count: 1
