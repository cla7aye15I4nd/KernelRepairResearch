id: 860268315ba86ea6b96b
bug_link: https://syzkaller.appspot.com/bug?extid=860268315ba86ea6b96b
title: 'KASAN: null-ptr-deref Write in rhashtable_free_and_destroy (2)'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 68a18ad71378a56858141c4449e02a30c829763e
fix_commit: 8b5cb7e41d9d77ffca036b0239177de123394a55
datetime: '2022-01-04T15:11:49+01:00'
fix_commit_message: 'mac80211: mesh: embedd mesh_paths and mpp_paths into ieee80211_if_mesh


  Syzbot hit NULL deref in rhashtable_free_and_destroy(). The problem was

  in mesh_paths and mpp_paths being NULL.


  mesh_pathtbl_init() could fail in case of memory allocation failure, but

  nobody cared, since ieee80211_mesh_init_sdata() returns void. It led to

  leaving 2 pointers as NULL. Syzbot has found null deref on exit path,

  but it could happen anywhere else, because code assumes these pointers are

  valid.


  Since all ieee80211_*_setup_sdata functions are void and do not fail,

  let''s embedd mesh_paths and mpp_paths into parent struct to avoid

  adding error handling on higher levels and follow the pattern of others

  setup_sdata functions


  Fixes: 60854fd94573 ("mac80211: mesh: convert path table to rhashtable")

  Reported-and-tested-by: syzbot+860268315ba86ea6b96b@syzkaller.appspotmail.com

  Signed-off-by: Pavel Skripkin <paskripkin@gmail.com>

  Link: https://lore.kernel.org/r/20211230195547.23977-1-paskripkin@gmail.com

  Signed-off-by: Johannes Berg <johannes.berg@intel.com>

  '
submodule:
- net/mac80211
hunk_count: 19
covered_count: 3
