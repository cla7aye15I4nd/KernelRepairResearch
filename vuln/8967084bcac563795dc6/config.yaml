id: 8967084bcac563795dc6
bug_link: https://syzkaller.appspot.com/bug?extid=8967084bcac563795dc6
title: 'KASAN: use-after-free Read in __rhashtable_lookup (2)'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 6ad569019999300afd8e614d296fdc356550b77f
fix_commit: cc4dfb7f70a344f24c1c71e298deea0771dadcb2
datetime: '2018-09-12T00:09:19-07:00'
fix_commit_message: 'rds: fix two RCU related problems


  When a rds sock is bound, it is inserted into the bind_hash_table

  which is protected by RCU. But when releasing rds sock, after it

  is removed from this hash table, it is freed immediately without

  respecting RCU grace period. This could cause some use-after-free

  as reported by syzbot.


  Mark the rds sock with SOCK_RCU_FREE before inserting it into the

  bind_hash_table, so that it would be always freed after a RCU grace

  period.


  The other problem is in rds_find_bound(), the rds sock could be

  freed in between rhashtable_lookup_fast() and rds_sock_addref(),

  so we need to extend RCU read lock protection in rds_find_bound()

  to close this race condition.


  Reported-and-tested-by: syzbot+8967084bcac563795dc6@syzkaller.appspotmail.com

  Reported-by: syzbot+93a5839deb355537440f@syzkaller.appspotmail.com

  Cc: Sowmini Varadhan <sowmini.varadhan@oracle.com>

  Cc: Santosh Shilimkar <santosh.shilimkar@oracle.com>

  Cc: rds-devel@oss.oracle.com

  Signed-off-by: Cong Wang <xiyou.wangcong@gmail.com>

  Acked-by: Santosh Shilimkar <santosh.shilimkar@oarcle.com>

  Signed-off-by: David S. Miller <davem@davemloft.net>

  '
submodule:
- net/rds
hunk_count: 2
covered_count: 2
