id: 649e339fa6658ee623d3
bug_link: https://syzkaller.appspot.com/bug?extid=649e339fa6658ee623d3
title: 'KASAN: use-after-free Write in nft_ct_tmpl_put_pcpu'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 519133debcc19f5c834e7e28480b60bdc234fe02
fix_commit: e3245a7b7b34bd2e97f744fd79463add6e9d41f4
datetime: '2021-08-11T11:22:19+02:00'
fix_commit_message: 'netfilter: nft_ct: protect nft_ct_pcpu_template_refcnt with mutex


  Syzbot hit use-after-free in nf_tables_dump_sets. The problem was in

  missing lock protection for nft_ct_pcpu_template_refcnt.


  Before commit f102d66b335a ("netfilter: nf_tables: use dedicated

  mutex to guard transactions") all transactions were serialized by global

  mutex, but then global mutex was changed to local per netnamespace

  commit_mutex.


  This change causes use-after-free bug, when 2 netnamespaces concurently

  changing nft_ct_pcpu_template_refcnt without proper locking. Fix it by

  adding nft_ct_pcpu_mutex and protect all nft_ct_pcpu_template_refcnt

  changes with it.


  Fixes: f102d66b335a ("netfilter: nf_tables: use dedicated mutex to guard transactions")

  Reported-and-tested-by: syzbot+649e339fa6658ee623d3@syzkaller.appspotmail.com

  Signed-off-by: Pavel Skripkin <paskripkin@gmail.com>

  Acked-by: Florian Westphal <fw@strlen.de>

  Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

  '
submodule:
- net/netfilter
hunk_count: 3
covered_count: 3
