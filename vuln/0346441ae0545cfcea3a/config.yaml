id: 0346441ae0545cfcea3a
bug_link: https://syzkaller.appspot.com/bug?extid=0346441ae0545cfcea3a
title: WARNING in xt_cluster_mt
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 467697d289e7e6e1b15910d99096c0da08c56d5b
fix_commit: aebfa52a925d701114afd6af0def35bab16d4f47
datetime: '2018-03-22T12:56:10+01:00'
fix_commit_message: "netfilter: drop template ct when conntrack is skipped.\n\nThe\
  \ ipv4 nf_ct code currently skips the nf_conntrak_in() call\nfor fragmented packets.\
  \ As a results later matches/target can end\nup manipulating template ct entry instead\
  \ of 'real' ones.\n\nExploiting the above, syzbot found a way to trigger the following\n\
  splat:\n\nWARNING: CPU: 1 PID: 4242 at net/netfilter/xt_cluster.c:55\nxt_cluster_mt+0x6c1/0x840\
  \ net/netfilter/xt_cluster.c:127\nKernel panic - not syncing: panic_on_warn set\
  \ ...\n\nCPU: 1 PID: 4242 Comm: syzkaller027971 Not tainted 4.16.0-rc2+ #243\nHardware\
  \ name: Google Google Compute Engine/Google Compute Engine, BIOS\nGoogle 01/01/2011\n\
  Call Trace:\n  __dump_stack lib/dump_stack.c:17 [inline]\n  dump_stack+0x194/0x24d\
  \ lib/dump_stack.c:53\n  panic+0x1e4/0x41c kernel/panic.c:183\n  __warn+0x1dc/0x200\
  \ kernel/panic.c:547\n  report_bug+0x211/0x2d0 lib/bug.c:184\n  fixup_bug.part.11+0x37/0x80\
  \ arch/x86/kernel/traps.c:178\n  fixup_bug arch/x86/kernel/traps.c:247 [inline]\n\
  \  do_error_trap+0x2d7/0x3e0 arch/x86/kernel/traps.c:296\n  do_invalid_op+0x1b/0x20\
  \ arch/x86/kernel/traps.c:315\n  invalid_op+0x58/0x80 arch/x86/entry/entry_64.S:957\n\
  RIP: 0010:xt_cluster_hash net/netfilter/xt_cluster.c:55 [inline]\nRIP: 0010:xt_cluster_mt+0x6c1/0x840\
  \ net/netfilter/xt_cluster.c:127\nRSP: 0018:ffff8801d2f6f2d0 EFLAGS: 00010293\n\
  RAX: ffff8801af700540 RBX: 0000000000000000 RCX: ffffffff84a2d1e1\nRDX: 0000000000000000\
  \ RSI: ffff8801d2f6f478 RDI: ffff8801cafd336a\nRBP: ffff8801d2f6f2e8 R08: 0000000000000000\
  \ R09: 0000000000000001\nR10: 0000000000000000 R11: 0000000000000000 R12: ffff8801b03b3d18\n\
  R13: ffff8801cafd3300 R14: dffffc0000000000 R15: ffff8801d2f6f478\n  ipt_do_table+0xa91/0x19b0\
  \ net/ipv4/netfilter/ip_tables.c:296\n  iptable_filter_hook+0x65/0x80 net/ipv4/netfilter/iptable_filter.c:41\n\
  \  nf_hook_entry_hookfn include/linux/netfilter.h:120 [inline]\n  nf_hook_slow+0xba/0x1a0\
  \ net/netfilter/core.c:483\n  nf_hook include/linux/netfilter.h:243 [inline]\n \
  \ NF_HOOK include/linux/netfilter.h:286 [inline]\n  raw_send_hdrinc.isra.17+0xf39/0x1880\
  \ net/ipv4/raw.c:432\n  raw_sendmsg+0x14cd/0x26b0 net/ipv4/raw.c:669\n  inet_sendmsg+0x11f/0x5e0\
  \ net/ipv4/af_inet.c:763\n  sock_sendmsg_nosec net/socket.c:629 [inline]\n  sock_sendmsg+0xca/0x110\
  \ net/socket.c:639\n  SYSC_sendto+0x361/0x5c0 net/socket.c:1748\n  SyS_sendto+0x40/0x50\
  \ net/socket.c:1716\n  do_syscall_64+0x280/0x940 arch/x86/entry/common.c:287\n \
  \ entry_SYSCALL_64_after_hwframe+0x42/0xb7\nRIP: 0033:0x441b49\nRSP: 002b:00007ffff5ca8b18\
  \ EFLAGS: 00000216 ORIG_RAX: 000000000000002c\nRAX: ffffffffffffffda RBX: 00000000004002c8\
  \ RCX: 0000000000441b49\nRDX: 0000000000000030 RSI: 0000000020ff7000 RDI: 0000000000000003\n\
  RBP: 00000000006cc018 R08: 000000002066354c R09: 0000000000000010\nR10: 0000000000000000\
  \ R11: 0000000000000216 R12: 0000000000403470\nR13: 0000000000403500 R14: 0000000000000000\
  \ R15: 0000000000000000\nDumping ftrace buffer:\n    (ftrace buffer empty)\nKernel\
  \ Offset: disabled\nRebooting in 86400 seconds..\n\nInstead of adding checks for\
  \ template ct on every target/match\nmanipulating skb->_nfct, simply drop the template\
  \ ct when skipping\nnf_conntrack_in().\n\nFixes: 7b4fdf77a450ec (\"netfilter: don't\
  \ track fragmented packets\")\nReported-and-tested-by: syzbot+0346441ae0545cfcea3a@syzkaller.appspotmail.com\n\
  Signed-off-by: Paolo Abeni <pabeni@redhat.com>\nAcked-by: Florian Westphal <fw@strlen.de>\n\
  Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>\n"
submodule:
- net/ipv4
hunk_count: 1
covered_count: 0
