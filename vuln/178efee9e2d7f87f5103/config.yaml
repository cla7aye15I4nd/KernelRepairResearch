id: 178efee9e2d7f87f5103
bug_link: https://syzkaller.appspot.com/bug?extid=178efee9e2d7f87f5103
title: WARNING in nf_tables_exit_net
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 03832a32bf8ff0a8305d94ddd3979835a807248f
fix_commit: 03c1f1ef1584c981935fab2fa0c45d3e43e2c235
datetime: '2022-11-08T23:16:14+01:00'
fix_commit_message: "netfilter: Cleanup nft_net->module_list from nf_tables_exit_net()\n\
  \nsyzbot reported a warning like below [1]:\n\nWARNING: CPU: 3 PID: 9 at net/netfilter/nf_tables_api.c:10096\
  \ nf_tables_exit_net+0x71c/0x840\nModules linked in:\nCPU: 2 PID: 9 Comm: kworker/u8:0\
  \ Tainted: G        W          6.1.0-rc3-00072-g8e5423e991e8 #47\nHardware name:\
  \ QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.0-1.fc36 04/01/2014\nWorkqueue:\
  \ netns cleanup_net\nRIP: 0010:nf_tables_exit_net+0x71c/0x840\n...\nCall Trace:\n\
  \ <TASK>\n ? __nft_release_table+0xfc0/0xfc0\n ops_exit_list+0xb5/0x180\n cleanup_net+0x506/0xb10\n\
  \ ? unregister_pernet_device+0x80/0x80\n process_one_work+0xa38/0x1730\n ? pwq_dec_nr_in_flight+0x2b0/0x2b0\n\
  \ ? rwlock_bug.part.0+0x90/0x90\n ? _raw_spin_lock_irq+0x46/0x50\n worker_thread+0x67e/0x10e0\n\
  \ ? process_one_work+0x1730/0x1730\n kthread+0x2e5/0x3a0\n ? kthread_complete_and_exit+0x40/0x40\n\
  \ ret_from_fork+0x1f/0x30\n </TASK>\n\nIn nf_tables_exit_net(), there is a case\
  \ where nft_net->commit_list is\nempty but nft_net->module_list is not empty.  Such\
  \ a case occurs with\nthe following scenario:\n\n1. nfnetlink_rcv_batch() is called\n\
  2. nf_tables_newset() returns -EAGAIN and NFNL_BATCH_FAILURE bit is\n   set to status\n\
  3. nf_tables_abort() is called with NFNL_ABORT_AUTOLOAD\n   (nft_net->commit_list\
  \ is released, but nft_net->module_list is not\n   because of NFNL_ABORT_AUTOLOAD\
  \ flag)\n4. Jump to replay label\n5. netlink_skb_clone() fails and returns from\
  \ the function (this is\n   caused by fault injection in the reproducer of syzbot)\n\
  \nThis patch fixes this issue by calling __nf_tables_abort() when\nnft_net->module_list\
  \ is not empty in nf_tables_exit_net().\n\nFixes: eb014de4fd41 (\"netfilter: nf_tables:\
  \ autoload modules from the abort path\")\nLink: https://syzkaller.appspot.com/bug?id=802aba2422de4218ad0c01b46c9525cc9d4e4aa3\
  \ [1]\nReported-by: syzbot+178efee9e2d7f87f5103@syzkaller.appspotmail.com\nSigned-off-by:\
  \ Shigeru Yoshida <syoshida@redhat.com>\nSigned-off-by: Florian Westphal <fw@strlen.de>\n"
submodule:
- net/netfilter
hunk_count: 1
covered_count: 1
