id: da3b7677bb913dc1b737
bug_link: https://syzkaller.appspot.com/bug?extid=da3b7677bb913dc1b737
title: WARNING in blk_mq_sched_free_requests (2)
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: f41def397161053eb0d3ed6861ef65985efbf293
fix_commit: 284b94be1925dbe035ce5218d8b5c197321262c7
datetime: '2019-09-26T00:45:05-06:00'
fix_commit_message: "blk-mq: move lockdep_assert_held() into elevator_exit\n\nCommit\
  \ c48dac137a62 (\"block: don't hold q->sysfs_lock in elevator_init_mq\")\nremoves\
  \ q->sysfs_lock from elevator_init_mq(), but forgot to deal with\nlockdep_assert_held()\
  \ called in blk_mq_sched_free_requests() which is\nrun in failure path of elevator_init_mq().\n\
  \nblk_mq_sched_free_requests() is called in the following 3 functions:\n\n\televator_init_mq()\n\
  \televator_exit()\n\tblk_cleanup_queue()\n\nIn blk_cleanup_queue(), blk_mq_sched_free_requests()\
  \ is followed exactly\nby 'mutex_lock(&q->sysfs_lock)'.\n\nSo moving the lockdep_assert_held()\
  \ from blk_mq_sched_free_requests()\ninto elevator_exit() for fixing the report\
  \ by syzbot.\n\nReported-by: syzbot+da3b7677bb913dc1b737@syzkaller.appspotmail.com\n\
  Fixed: c48dac137a62 (\"block: don't hold q->sysfs_lock in elevator_init_mq\")\n\
  Reviewed-by: Bart Van Assche <bvanassche@acm.org>\nReviewed-by: Damien Le Moal <damien.lemoal@wdc.com>\n\
  Signed-off-by: Ming Lei <ming.lei@redhat.com>\nSigned-off-by: Jens Axboe <axboe@kernel.dk>\n"
submodule:
- block
hunk_count: 2
covered_count: 1
