id: cfafed3bb76d3e37581b
bug_link: https://syzkaller.appspot.com/bug?extid=cfafed3bb76d3e37581b
title: WARNING in vmx_queue_exception (2)
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 0c2c7c069285374fc8feacddc0498f8ab7627117
fix_commit: 053d2290c0307e3642e75e0185ddadf084dc36c1
datetime: '2022-05-06T13:08:06-04:00'
fix_commit_message: 'KVM: VMX: Exit to userspace if vCPU has injected exception and
  invalid state


  Exit to userspace with an emulation error if KVM encounters an injected

  exception with invalid guest state, in addition to the existing check of

  bailing if there''s a pending exception (KVM doesn''t support emulating

  exceptions except when emulating real mode via vm86).


  In theory, KVM should never get to such a situation as KVM is supposed to

  exit to userspace before injecting an exception with invalid guest state.

  But in practice, userspace can intervene and manually inject an exception

  and/or stuff registers to force invalid guest state while a previously

  injected exception is awaiting reinjection.


  Fixes: fc4fad79fc3d ("KVM: VMX: Reject KVM_RUN if emulation is required with pending
  exception")

  Reported-by: syzbot+cfafed3bb76d3e37581b@syzkaller.appspotmail.com

  Signed-off-by: Sean Christopherson <seanjc@google.com>

  Message-Id: <20220502221850.131873-1-seanjc@google.com>

  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>

  '
submodule:
- arch/x86/kvm/vmx
hunk_count: 1
covered_count: 0
