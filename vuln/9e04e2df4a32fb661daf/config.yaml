id: 9e04e2df4a32fb661daf
bug_link: https://syzkaller.appspot.com/bug?extid=9e04e2df4a32fb661daf
title: 'KASAN: use-after-free Read in service_outstanding_interrupt'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: a390bef7db1f192cc5b588dbcf8ed113406ec130
fix_commit: 5e5ff0b4b6bcb4d17b7a26ec8bcfc7dd4651684f
datetime: '2020-12-28T15:44:23+01:00'
fix_commit_message: "USB: cdc-wdm: Fix use after free in service_outstanding_interrupt().\n\
  \nsyzbot is reporting UAF at usb_submit_urb() [1], for\nservice_outstanding_interrupt()\
  \ is not checking WDM_DISCONNECTING\nbefore calling usb_submit_urb(). Close the\
  \ race by doing same checks\nwdm_read() does upon retry.\n\nAlso, while wdm_read()\
  \ checks WDM_DISCONNECTING with desc->rlock held,\nservice_interrupt_work() does\
  \ not hold desc->rlock. Thus, it is possible\nthat usb_submit_urb() is called from\
  \ service_outstanding_interrupt() from\nservice_interrupt_work() after WDM_DISCONNECTING\
  \ was set and kill_urbs()\n from wdm_disconnect() completed. Thus, move kill_urbs()\
  \ in\nwdm_disconnect() to after cancel_work_sync() (which makes sure that\nservice_interrupt_work()\
  \ is no longer running) completed.\n\nAlthough it seems to be safe to dereference\
  \ desc->intf->dev in\nservice_outstanding_interrupt() even if WDM_DISCONNECTING\
  \ was already set\nbecause desc->rlock or cancel_work_sync() prevents wdm_disconnect()\
  \ from\nreaching list_del() before service_outstanding_interrupt() completes,\n\
  let's not emit error message if WDM_DISCONNECTING is set by\nwdm_disconnect() while\
  \ usb_submit_urb() is in progress.\n\n[1] https://syzkaller.appspot.com/bug?extid=9e04e2df4a32fb661daf\n\
  \nReported-by: syzbot <syzbot+9e04e2df4a32fb661daf@syzkaller.appspotmail.com>\n\
  Signed-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp>\nCc: stable <stable@vger.kernel.org>\n\
  Link: https://lore.kernel.org/r/620e2ee0-b9a3-dbda-a25b-a93e0ed03ec5@i-love.sakura.ne.jp\n\
  Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>\n"
submodule:
- drivers/usb/class
hunk_count: 2
covered_count: 1
