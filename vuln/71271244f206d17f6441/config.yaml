id: 71271244f206d17f6441
bug_link: https://syzkaller.appspot.com/bug?extid=71271244f206d17f6441
title: WARNING in x86_emulate_instruction
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: e87e46d5f3182f82d997641d95db01a7feacef92
fix_commit: da6393cdd8aaa354b3a2437cd73ebb34cac958e3
datetime: '2021-05-28T12:59:09-04:00'
fix_commit_message: "KVM: X86: Fix warning caused by stale emulation context\n\nReported\
  \ by syzkaller:\n\n  WARNING: CPU: 7 PID: 10526 at linux/arch/x86/kvm//x86.c:7621\
  \ x86_emulate_instruction+0x41b/0x510 [kvm]\n  RIP: 0010:x86_emulate_instruction+0x41b/0x510\
  \ [kvm]\n  Call Trace:\n   kvm_mmu_page_fault+0x126/0x8f0 [kvm]\n   vmx_handle_exit+0x11e/0x680\
  \ [kvm_intel]\n   vcpu_enter_guest+0xd95/0x1b40 [kvm]\n   kvm_arch_vcpu_ioctl_run+0x377/0x6a0\
  \ [kvm]\n   kvm_vcpu_ioctl+0x389/0x630 [kvm]\n   __x64_sys_ioctl+0x8e/0xd0\n   do_syscall_64+0x3c/0xb0\n\
  \   entry_SYSCALL_64_after_hwframe+0x44/0xae\n\nCommit 4a1e10d5b5d8 (\"KVM: x86:\
  \ handle hardware breakpoints during emulation())\nadds hardware breakpoints check\
  \ before emulation the instruction and parts of\nemulation context initialization,\
  \ actually we don't have the EMULTYPE_NO_DECODE flag\nhere and the emulation context\
  \ will not be reused. Commit c8848cee74ff (\"KVM: x86:\nset ctxt->have_exception\
  \ in x86_decode_insn()) triggers the warning because it\ncatches the stale emulation\
  \ context has #UD, however, it is not during instruction\ndecoding which should\
  \ result in EMULATION_FAILED. This patch fixes it by moving\nthe second part emulation\
  \ context initialization into init_emulate_ctxt() and\nbefore hardware breakpoints\
  \ check. The ctxt->ud will be dropped by a follow-up\npatch.\n\nsyzkaller source:\
  \ https://syzkaller.appspot.com/x/repro.c?x=134683fdd00000\n\nReported-by: syzbot+71271244f206d17f6441@syzkaller.appspotmail.com\n\
  Fixes: 4a1e10d5b5d8 (KVM: x86: handle hardware breakpoints during emulation)\nSigned-off-by:\
  \ Wanpeng Li <wanpengli@tencent.com>\nReviewed-by: Sean Christopherson <seanjc@google.com>\n\
  Message-Id: <1622160097-37633-1-git-send-email-wanpengli@tencent.com>\n"
submodule:
- arch/x86/kvm
hunk_count: 2
covered_count: 1
