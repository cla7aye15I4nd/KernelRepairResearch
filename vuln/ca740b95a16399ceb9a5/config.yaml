id: ca740b95a16399ceb9a5
bug_link: https://syzkaller.appspot.com/bug?extid=ca740b95a16399ceb9a5
title: WARNING in hrtimer_forward
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: b9731062ce8afd35cf723bf3a8ad55d208f915a5
fix_commit: 313bbd1990b6ddfdaa7da098d0c56b098a833572
datetime: '2021-09-23T13:25:12+02:00'
fix_commit_message: "mac80211-hwsim: fix late beacon hrtimer handling\n\nThomas explained\
  \ in https://lore.kernel.org/r/87mtoeb4hb.ffs@tglx\nthat our handling of the hrtimer\
  \ here is wrong: If the timer fires\nlate (e.g. due to vCPU scheduling, as reported\
  \ by Dmitry/syzbot)\nthen it tries to actually rearm the timer at the next deadline,\n\
  which might be in the past already:\n\n 1          2          3          N     \
  \     N+1\n |          |          |   ...    |          |\n\n ^ intended to fire\
  \ here (1)\n            ^ next deadline here (2)\n                             \
  \         ^ actually fired here\n\nThe next time it fires, it's later, but will\
  \ still try to schedule\nfor the next deadline (now 3), etc. until it catches up\
  \ with N,\nbut that might take a long time, causing stalls etc.\n\nNow, all of this\
  \ is simulation, so we just have to fix it, but\nnote that the behaviour is wrong\
  \ even per spec, since there's no\nvalue then in sending all those beacons unaligned\
  \ - they should be\naligned to the TBTT (1, 2, 3, ... in the picture), and if we're\
  \ a\nbit (or a lot) late, then just resume at that point.\n\nTherefore, change the\
  \ code to use hrtimer_forward_now() which will\nensure that the next firing of the\
  \ timer would be at N+1 (in the\npicture), i.e. the next interval point after the\
  \ current time.\n\nSuggested-by: Thomas Gleixner <tglx@linutronix.de>\nReported-by:\
  \ Dmitry Vyukov <dvyukov@google.com>\nReported-by: syzbot+0e964fad69a9c462bc1e@syzkaller.appspotmail.com\n\
  Fixes: 01e59e467ecf (\"mac80211_hwsim: hrtimer beacon\")\nReviewed-by: Thomas Gleixner\
  \ <tglx@linutronix.de>\nLink: https://lore.kernel.org/r/20210915112936.544f383472eb.I3f9712009027aa09244b65399bf18bf482a8c4f1@changeid\n\
  Signed-off-by: Johannes Berg <johannes.berg@intel.com>\n"
submodule:
- drivers/net/wireless
hunk_count: 1
covered_count: 1
