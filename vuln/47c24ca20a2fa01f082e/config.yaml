id: 47c24ca20a2fa01f082e
bug_link: https://syzkaller.appspot.com/bug?extid=47c24ca20a2fa01f082e
title: general protection fault in sctp_outq_tail
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: e669ce46740a9815953bb4452a6bc5a7fdc21a50
fix_commit: 2584024b23552c00d95b50255e47bd18d306d31a
datetime: '2023-04-02T13:44:58+01:00'
fix_commit_message: "sctp: check send stream number after wait_for_sndbuf\n\nThis\
  \ patch fixes a corner case where the asoc out stream count may change\nafter wait_for_sndbuf.\n\
  \nWhen the main thread in the client starts a connection, if its out stream\ncount\
  \ is set to N while the in stream count in the server is set to N - 2,\nanother\
  \ thread in the client keeps sending the msgs with stream number\nN - 1, and waits\
  \ for sndbuf before processing INIT_ACK.\n\nHowever, after processing INIT_ACK,\
  \ the out stream count in the client is\nshrunk to N - 2, the same to the in stream\
  \ count in the server. The crash\noccurs when the thread waiting for sndbuf is awake\
  \ and sends the msg in a\nnon-existing stream(N - 1), the call trace is as below:\n\
  \n  KASAN: null-ptr-deref in range [0x0000000000000038-0x000000000000003f]\n  Call\
  \ Trace:\n   <TASK>\n   sctp_cmd_send_msg net/sctp/sm_sideeffect.c:1114 [inline]\n\
  \   sctp_cmd_interpreter net/sctp/sm_sideeffect.c:1777 [inline]\n   sctp_side_effects\
  \ net/sctp/sm_sideeffect.c:1199 [inline]\n   sctp_do_sm+0x197d/0x5310 net/sctp/sm_sideeffect.c:1170\n\
  \   sctp_primitive_SEND+0x9f/0xc0 net/sctp/primitive.c:163\n   sctp_sendmsg_to_asoc+0x10eb/0x1a30\
  \ net/sctp/socket.c:1868\n   sctp_sendmsg+0x8d4/0x1d90 net/sctp/socket.c:2026\n\
  \   inet_sendmsg+0x9d/0xe0 net/ipv4/af_inet.c:825\n   sock_sendmsg_nosec net/socket.c:722\
  \ [inline]\n   sock_sendmsg+0xde/0x190 net/socket.c:745\n\nThe fix is to add an\
  \ unlikely check for the send stream number after the\nthread wakes up from the\
  \ wait_for_sndbuf.\n\nFixes: 5bbbbe32a431 (\"sctp: introduce stream scheduler foundations\"\
  )\nReported-by: syzbot+47c24ca20a2fa01f082e@syzkaller.appspotmail.com\nSigned-off-by:\
  \ Xin Long <lucien.xin@gmail.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>\n"
submodule:
- net/sctp
hunk_count: 1
covered_count: 1
