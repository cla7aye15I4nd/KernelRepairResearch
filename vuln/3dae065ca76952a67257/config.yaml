id: 3dae065ca76952a67257
bug_link: https://syzkaller.appspot.com/bug?extid=3dae065ca76952a67257
title: kernel BUG in binder_inc_ref_for_node
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: d1009d04a0fefe4df86285cbb37c78aa0b7ab852
fix_commit: 11512c197d387b59569d3a93af93de204d3bdaa6
datetime: '2024-07-31T13:47:48+02:00'
fix_commit_message: "binder: fix descriptor lookup for context manager\n\nIn commit\
  \ 15d9da3f818c (\"binder: use bitmap for faster descriptor\nlookup\"), it was incorrectly\
  \ assumed that references to the context\nmanager node should always get descriptor\
  \ zero assigned to them.\n\nHowever, if the context manager dies and a new process\
  \ takes its place,\nthen assigning descriptor zero to the new context manager might\
  \ lead to\ncollisions, as there could still be references to the older node. This\n\
  issue was reported by syzbot with the following trace:\n\n  kernel BUG at drivers/android/binder.c:1173!\n\
  \  Internal error: Oops - BUG: 00000000f2000800 [#1] PREEMPT SMP\n  Modules linked\
  \ in:\n  CPU: 1 PID: 447 Comm: binder-util Not tainted 6.10.0-rc6-00348-g31643d84b8c3\
  \ #10\n  Hardware name: linux,dummy-virt (DT)\n  pstate: 60000005 (nZCv daif -PAN\
  \ -UAO -TCO -DIT -SSBS BTYPE=--)\n  pc : binder_inc_ref_for_node+0x500/0x544\n \
  \ lr : binder_inc_ref_for_node+0x1e4/0x544\n  sp : ffff80008112b940\n  x29: ffff80008112b940\
  \ x28: ffff0e0e40310780 x27: 0000000000000000\n  x26: 0000000000000001 x25: ffff0e0e40310738\
  \ x24: ffff0e0e4089ba34\n  x23: ffff0e0e40310b00 x22: ffff80008112bb50 x21: ffffaf7b8f246970\n\
  \  x20: ffffaf7b8f773f08 x19: ffff0e0e4089b800 x18: 0000000000000000\n  x17: 0000000000000000\
  \ x16: 0000000000000000 x15: 000000002de4aa60\n  x14: 0000000000000000 x13: 2de4acf000000000\
  \ x12: 0000000000000020\n  x11: 0000000000000018 x10: 0000000000000020 x9 : ffffaf7b90601000\n\
  \  x8 : ffff0e0e48739140 x7 : 0000000000000000 x6 : 000000000000003f\n  x5 : ffff0e0e40310b28\
  \ x4 : 0000000000000000 x3 : ffff0e0e40310720\n  x2 : ffff0e0e40310728 x1 : 0000000000000000\
  \ x0 : ffff0e0e40310710\n  Call trace:\n   binder_inc_ref_for_node+0x500/0x544\n\
  \   binder_transaction+0xf68/0x2620\n   binder_thread_write+0x5bc/0x139c\n   binder_ioctl+0xef4/0x10c8\n\
  \  [...]\n\nThis patch adds back the previous behavior of assigning the next\nnon-zero\
  \ descriptor if references to previous context managers still\nexist. It amends\
  \ both strategies, the newer dbitmap code and also the\nlegacy slow_desc_lookup_olocked(),\
  \ by allowing them to start looking\nfor available descriptors at a given offset.\n\
  \nFixes: 15d9da3f818c (\"binder: use bitmap for faster descriptor lookup\")\nCc:\
  \ stable@vger.kernel.org\nReported-and-tested-by: syzbot+3dae065ca76952a67257@syzkaller.appspotmail.com\n\
  Closes: https://lore.kernel.org/all/000000000000c1c0a0061d1e6979@google.com/\nReviewed-by:\
  \ Alice Ryhl <aliceryhl@google.com>\nSigned-off-by: Carlos Llamas <cmllamas@google.com>\n\
  Link: https://lore.kernel.org/r/20240722150512.4192473-1-cmllamas@google.com\nSigned-off-by:\
  \ Greg Kroah-Hartman <gregkh@linuxfoundation.org>\n"
submodule:
- drivers/android
hunk_count: 7
covered_count: 0
