id: 3b220254df55d8ca8a61
bug_link: https://syzkaller.appspot.com/bug?extid=3b220254df55d8ca8a61
title: kernel BUG in try_to_unmap_one (2)
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: db6cc3f4ac2e6cdc898fc9cbc8b32ae1bf56bdad
fix_commit: 9f1e8cd0b7c4c944e9921b52a6661b5eda2705ab
datetime: '2025-07-19T19:26:15-07:00'
fix_commit_message: "mm/vmscan: fix hwpoisoned large folio handling in shrink_folio_list\n\
  \nIn shrink_folio_list(), the hwpoisoned folio may be large folio, which\ncan't\
  \ be handled by unmap_poisoned_folio().  For THP, try_to_unmap_one()\nmust be passed\
  \ with TTU_SPLIT_HUGE_PMD to split huge PMD first and then\nretry.  Without TTU_SPLIT_HUGE_PMD,\
  \ we will trigger null-ptr deref of\npvmw.pte.  Even we passed TTU_SPLIT_HUGE_PMD,\
  \ we will trigger a\nWARN_ON_ONCE due to the page isn't in swapcache.\n\nSince UCE\
  \ is rare in real world, and race with reclaimation is more rare,\njust skipping\
  \ the hwpoisoned large folio is enough.  memory_failure() will\nhandle it if the\
  \ UCE is triggered again.\n\nThis happens when memory reclaim for large folio races\
  \ with\nmemory_failure(), and will lead to kernel panic.  The race is as\nfollows:\n\
  \ncpu0      cpu1\n shrink_folio_list memory_failure\n  TestSetPageHWPoison\n  unmap_poisoned_folio\n\
  \  --> trigger BUG_ON due to\n  unmap_poisoned_folio couldn't\n   handle large folio\n\
  \n[tujinjiang@huawei.com: add comment to unmap_poisoned_folio()]\n  Link: https://lkml.kernel.org/r/69fd4e00-1b13-d5f7-1c82-705c7d977ea4@huawei.com\n\
  Link: https://lkml.kernel.org/r/20250627125747.3094074-2-tujinjiang@huawei.com\n\
  Signed-off-by: Jinjiang Tu <tujinjiang@huawei.com>\nFixes: 1b0449544c64 (\"mm/vmscan:\
  \ don't try to reclaim hwpoison folio\")\nReported-by: syzbot+3b220254df55d8ca8a61@syzkaller.appspotmail.com\n\
  Closes: https://lore.kernel.org/all/68412d57.050a0220.2461cf.000e.GAE@google.com/\n\
  Acked-by: David Hildenbrand <david@redhat.com>\nReviewed-by: Miaohe Lin <linmiaohe@huawei.com>\n\
  Acked-by: Zi Yan <ziy@nvidia.com>\nReviewed-by: Oscar Salvador <osalvador@suse.de>\n\
  Cc: Kefeng Wang <wangkefeng.wang@huawei.com>\nCc: Michal Hocko <mhocko@kernel.org>\n\
  Cc: Oscar Salvador <osalvador@suse.de>\nCc: <stable@vger.kernel.org>\nSigned-off-by:\
  \ Andrew Morton <akpm@linux-foundation.org>\n"
submodule:
- mm
hunk_count: 2
covered_count: 2
