id: 0bf0519d6e0de15914fe
bug_link: https://syzkaller.appspot.com/bug?extid=0bf0519d6e0de15914fe
title: WARNING in xfrm_state_fini (2)
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 01ce31c57b3f07c91c9d45bbaf126124cce83a5d
fix_commit: dbb2483b2a46fbaf833cfb5deb5ed9cace9c7399
datetime: '2019-03-26T08:35:36+01:00'
fix_commit_message: 'xfrm: clean up xfrm protocol checks


  In commit 6a53b7593233 ("xfrm: check id proto in validate_tmpl()")

  I introduced a check for xfrm protocol, but according to Herbert

  IPSEC_PROTO_ANY should only be used as a wildcard for lookup, so

  it should be removed from validate_tmpl().


  And, IPSEC_PROTO_ANY is expected to only match 3 IPSec-specific

  protocols, this is why xfrm_state_flush() could still miss

  IPPROTO_ROUTING, which leads that those entries are left in

  net->xfrm.state_all before exit net. Fix this by replacing

  IPSEC_PROTO_ANY with zero.


  This patch also extracts the check from validate_tmpl() to

  xfrm_id_proto_valid() and uses it in parse_ipsecrequest().

  With this, no other protocols should be added into xfrm.


  Fixes: 6a53b7593233 ("xfrm: check id proto in validate_tmpl()")

  Reported-by: syzbot+0bf0519d6e0de15914fe@syzkaller.appspotmail.com

  Cc: Steffen Klassert <steffen.klassert@secunet.com>

  Cc: Herbert Xu <herbert@gondor.apana.org.au>

  Signed-off-by: Cong Wang <xiyou.wangcong@gmail.com>

  Acked-by: Herbert Xu <herbert@gondor.apana.org.au>

  Signed-off-by: Steffen Klassert <steffen.klassert@secunet.com>

  '
submodule:
- include/net
- net/ipv6
- net/key
- net/xfrm
hunk_count: 5
covered_count: 1
