id: 27b0b464864741b18b99
bug_link: https://syzkaller.appspot.com/bug?extid=27b0b464864741b18b99
title: WARNING in corrupted (3)
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: da4ede4b7fd6aa341b69e3a9d2517b8df5e744fd
fix_commit: 6f489a966fbeb0da63d45c2c66a8957eab604bf6
datetime: '2023-05-25T16:21:21+02:00'
fix_commit_message: "media: usb: siano: Fix warning due to null work_func_t function\
  \ pointer\n\nThe previous commit ebad8e731c1c (\"media: usb: siano: Fix use after\n\
  free bugs caused by do_submit_urb\") adds cancel_work_sync() in\nsmsusb_stop_streaming().\
  \ But smsusb_stop_streaming() may be called,\neven if the work_struct surb->wq has\
  \ not been initialized. As a result,\nthe warning will occur. One of the processes\
  \ that could lead to warning\nis shown below:\n\nsmsusb_probe()\n  smsusb_init_device()\n\
  \    if (!dev->in_ep || !dev->out_ep || align < 0) {\n         smsusb_term_device(intf);\n\
  \           smsusb_stop_streaming()\n             cancel_work_sync(&dev->surbs[i].wq);\n\
  \               __cancel_work_timer()\n                 __flush_work()\n       \
  \            if (WARN_ON(!work->func)) // work->func is null\n\nThe log reported\
  \ by syzbot is shown below:\n\nWARNING: CPU: 0 PID: 897 at kernel/workqueue.c:3066\
  \ __flush_work+0x798/0xa80 kernel/workqueue.c:3063\nModules linked in:\nCPU: 0 PID:\
  \ 897 Comm: kworker/0:2 Not tainted 6.2.0-rc1-syzkaller #0\nRIP: 0010:__flush_work+0x798/0xa80\
  \ kernel/workqueue.c:3066\n...\nRSP: 0018:ffffc9000464ebf8 EFLAGS: 00010246\nRAX:\
  \ 1ffff11002dbb420 RBX: 0000000000000021 RCX: 1ffffffff204fa4e\nRDX: dffffc0000000000\
  \ RSI: 0000000000000001 RDI: ffff888016dda0e8\nRBP: ffffc9000464ed98 R08: 0000000000000001\
  \ R09: ffffffff90253b2f\nR10: 0000000000000001 R11: 0000000000000000 R12: ffff888016dda0e8\n\
  R13: ffff888016dda0e8 R14: ffff888016dda100 R15: 0000000000000001\nFS:  0000000000000000(0000)\
  \ GS:ffff8880b9a00000(0000) knlGS:0000000000000000\nCS:  0010 DS: 0000 ES: 0000\
  \ CR0: 0000000080050033\nCR2: 00007ffd4331efe8 CR3: 000000000b48e000 CR4: 00000000003506f0\n\
  DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000\nDR3: 0000000000000000\
  \ DR6: 00000000fffe0ff0 DR7: 0000000000000400\nCall Trace:\n <TASK>\n __cancel_work_timer+0x315/0x460\
  \ kernel/workqueue.c:3160\n smsusb_stop_streaming drivers/media/usb/siano/smsusb.c:182\
  \ [inline]\n smsusb_term_device+0xda/0x2d0 drivers/media/usb/siano/smsusb.c:344\n\
  \ smsusb_init_device+0x400/0x9ce drivers/media/usb/siano/smsusb.c:419\n smsusb_probe+0xbbd/0xc55\
  \ drivers/media/usb/siano/smsusb.c:567\n...\n\nThis patch adds check before cancel_work_sync().\
  \ If surb->wq has not\nbeen initialized, the cancel_work_sync() will not be executed.\n\
  \nReported-by: syzbot+27b0b464864741b18b99@syzkaller.appspotmail.com\nFixes: ebad8e731c1c\
  \ (\"media: usb: siano: Fix use after free bugs caused by do_submit_urb\")\nSigned-off-by:\
  \ Duoming Zhou <duoming@zju.edu.cn>\nSigned-off-by: Hans Verkuil <hverkuil-cisco@xs4all.nl>\n"
submodule:
- drivers/media/usb/siano
hunk_count: 1
covered_count: 0
