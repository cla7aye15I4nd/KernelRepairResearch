id: 70e777a39907d6d5fd0a
bug_link: https://syzkaller.appspot.com/bug?extid=70e777a39907d6d5fd0a
title: 'KASAN: use-after-free Read in __snd_rawmidi_transmit_peek'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 0aea30a07ec6b50de0fc5f5b2ec34a68ead86b61
fix_commit: 0665886ad1392e6b5bae85d7a6ccbed48dca1522
datetime: '2022-04-20T15:13:45+02:00'
fix_commit_message: 'ALSA: usb-audio: Clear MIDI port active flag after draining


  When a rawmidi output stream is closed, it calls the drain at first,

  then does trigger-off only when the drain returns -ERESTARTSYS as a

  fallback.  It implies that each driver should turn off the stream

  properly after the drain.  Meanwhile, USB-audio MIDI interface didn''t

  change the port->active flag after the drain.  This may leave the

  output work picking up the port that is closed right now, which

  eventually leads to a use-after-free for the already released rawmidi

  object.


  This patch fixes the bug by properly clearing the port->active flag

  after the output drain.


  Reported-by: syzbot+70e777a39907d6d5fd0a@syzkaller.appspotmail.com

  Cc: <stable@vger.kernel.org>

  Link: https://lore.kernel.org/r/00000000000011555605dceaff03@google.com

  Link: https://lore.kernel.org/r/20220420130247.22062-1-tiwai@suse.de

  Signed-off-by: Takashi Iwai <tiwai@suse.de>

  '
submodule:
- sound/usb
hunk_count: 1
covered_count: 0
