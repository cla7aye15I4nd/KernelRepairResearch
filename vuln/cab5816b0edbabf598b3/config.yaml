id: cab5816b0edbabf598b3
bug_link: https://syzkaller.appspot.com/bug?extid=cab5816b0edbabf598b3
title: 'WARNING: kmalloc bug in bpf_prog_array_copy_info'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 7fc17e909edfb9bf421ee04e981d3d474175c7c7
fix_commit: 9c481b908b011398b1491752271cd1e2c9ad5758
datetime: '2018-02-14T08:59:37-08:00'
fix_commit_message: 'bpf: fix bpf_prog_array_copy_to_user warning from perf event
  prog query


  syzkaller tried to perform a prog query in perf_event_query_prog_array()

  where struct perf_event_query_bpf had an ids_len of 1,073,741,353 and

  thus causing a warning due to failed kcalloc() allocation out of the

  bpf_prog_array_copy_to_user() helper. Given we cannot attach more than

  64 programs to a perf event, there''s no point in allowing huge ids_len.

  Therefore, allow a buffer that would fix the maximum number of ids and

  also add a __GFP_NOWARN to the temporary ids buffer.


  Fixes: f371b304f12e ("bpf/tracing: allow user space to query prog array on the same
  tp")

  Fixes: 0911287ce32b ("bpf: fix bpf_prog_array_copy_to_user() issues")

  Reported-by: syzbot+cab5816b0edbabf598b3@syzkaller.appspotmail.com

  Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>

  Signed-off-by: Alexei Starovoitov <ast@kernel.org>

  '
submodule:
- kernel/bpf
- kernel/trace
hunk_count: 2
covered_count: 2
