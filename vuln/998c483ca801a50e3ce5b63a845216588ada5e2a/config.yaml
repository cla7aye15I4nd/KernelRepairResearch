id: 998c483ca801a50e3ce5b63a845216588ada5e2a
bug_link: https://syzkaller.appspot.com/bug?extid=998c483ca801a50e3ce5b63a845216588ada5e2a
title: 'KASAN: use-after-free Read in handle_userfault'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: d09cfbbfa0f761a97687828b5afb27b56cbf2e19
fix_commit: 0cbb4b4f4c44f54af268969b18d8deda63aded59
datetime: '2018-01-04T16:45:09-08:00'
fix_commit_message: 'userfaultfd: clear the vma->vm_userfaultfd_ctx if UFFD_EVENT_FORK
  fails


  The previous fix in commit 384632e67e08 ("userfaultfd: non-cooperative:

  fix fork use after free") corrected the refcounting in case of

  UFFD_EVENT_FORK failure for the fork userfault paths.


  That still didn''t clear the vma->vm_userfaultfd_ctx of the vmas that

  were set to point to the aborted new uffd ctx earlier in

  dup_userfaultfd.


  Link: http://lkml.kernel.org/r/20171223002505.593-2-aarcange@redhat.com

  Signed-off-by: Andrea Arcangeli <aarcange@redhat.com>

  Reported-by: syzbot <syzkaller@googlegroups.com>

  Reviewed-by: Mike Rapoport <rppt@linux.vnet.ibm.com>

  Cc: Eric Biggers <ebiggers3@gmail.com>

  Cc: Dmitry Vyukov <dvyukov@google.com>

  Cc: <stable@vger.kernel.org>

  Signed-off-by: Andrew Morton <akpm@linux-foundation.org>

  Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

  '
submodule:
- fs
hunk_count: 3
covered_count: 3
