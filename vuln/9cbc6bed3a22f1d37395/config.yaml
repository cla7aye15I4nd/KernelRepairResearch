id: 9cbc6bed3a22f1d37395
bug_link: https://syzkaller.appspot.com/bug?extid=9cbc6bed3a22f1d37395
title: 'WARNING: suspicious RCU usage (5)'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: c2162e13d6e2f43e5001a356196871642de070ba
fix_commit: f4e61f0c9add3b00bd5f2df3c814d688849b8707
datetime: '2021-03-18T13:58:14-04:00'
fix_commit_message: "x86/kvm: Fix broken irq restoration in kvm_wait\n\nAfter commit\
  \ 997acaf6b4b59c (lockdep: report broken irq restoration), the guest\nsplatting\
  \ below during boot:\n\n raw_local_irq_restore() called with IRQs enabled\n WARNING:\
  \ CPU: 1 PID: 169 at kernel/locking/irqflag-debug.c:10 warn_bogus_irq_restore+0x26/0x30\n\
  \ Modules linked in: hid_generic usbhid hid\n CPU: 1 PID: 169 Comm: systemd-udevd\
  \ Not tainted 5.11.0+ #25\n RIP: 0010:warn_bogus_irq_restore+0x26/0x30\n Call Trace:\n\
  \  kvm_wait+0x76/0x90\n  __pv_queued_spin_lock_slowpath+0x285/0x2e0\n  do_raw_spin_lock+0xc9/0xd0\n\
  \  _raw_spin_lock+0x59/0x70\n  lockref_get_not_dead+0xf/0x50\n  __legitimize_path+0x31/0x60\n\
  \  legitimize_root+0x37/0x50\n  try_to_unlazy_next+0x7f/0x1d0\n  lookup_fast+0xb0/0x170\n\
  \  path_openat+0x165/0x9b0\n  do_filp_open+0x99/0x110\n  do_sys_openat2+0x1f1/0x2e0\n\
  \  do_sys_open+0x5c/0x80\n  __x64_sys_open+0x21/0x30\n  do_syscall_64+0x32/0x50\n\
  \  entry_SYSCALL_64_after_hwframe+0x44/0xae\n\nThe new consistency checking,  expects\
  \ local_irq_save() and\nlocal_irq_restore() to be paired and sanely nested, and\
  \ therefore expects\nlocal_irq_restore() to be called with irqs disabled.\nThe irqflags\
  \ handling in kvm_wait() which ends up doing:\n\n\tlocal_irq_save(flags);\n\tsafe_halt();\n\
  \tlocal_irq_restore(flags);\n\ninstead triggers it.  This patch fixes it by using\n\
  local_irq_disable()/enable() directly.\n\nCc: Thomas Gleixner <tglx@linutronix.de>\n\
  Reported-by: Dmitry Vyukov <dvyukov@google.com>\nSigned-off-by: Wanpeng Li <wanpengli@tencent.com>\n\
  Message-Id: <1615791328-2735-1-git-send-email-wanpengli@tencent.com>\nSigned-off-by:\
  \ Paolo Bonzini <pbonzini@redhat.com>\n"
submodule:
- arch/x86/kernel
hunk_count: 1
covered_count: 0
