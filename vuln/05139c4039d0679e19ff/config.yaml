id: 05139c4039d0679e19ff
bug_link: https://syzkaller.appspot.com/bug?extid=05139c4039d0679e19ff
title: general protection fault in utf8_casefold
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 48046cb55d208eae67259887b29b3097bcf44caf
fix_commit: f6322f3f1212e005e7e6aa82ceb62be53030a64b
datetime: '2020-10-08T21:24:40-07:00'
fix_commit_message: "f2fs: reject CASEFOLD inode flag without casefold feature\n\n\
  syzbot reported:\n\n    general protection fault, probably for non-canonical address\
  \ 0xdffffc0000000001: 0000 [#1] PREEMPT SMP KASAN\n    KASAN: null-ptr-deref in\
  \ range [0x0000000000000008-0x000000000000000f]\n    CPU: 0 PID: 6860 Comm: syz-executor835\
  \ Not tainted 5.9.0-rc8-syzkaller #0\n    Hardware name: Google Google Compute Engine/Google\
  \ Compute Engine, BIOS Google 01/01/2011\n    RIP: 0010:utf8_casefold+0x43/0x1b0\
  \ fs/unicode/utf8-core.c:107\n    [...]\n    Call Trace:\n     f2fs_init_casefolded_name\
  \ fs/f2fs/dir.c:85 [inline]\n     __f2fs_setup_filename fs/f2fs/dir.c:118 [inline]\n\
  \     f2fs_prepare_lookup+0x3bf/0x640 fs/f2fs/dir.c:163\n     f2fs_lookup+0x10d/0x920\
  \ fs/f2fs/namei.c:494\n     __lookup_hash+0x115/0x240 fs/namei.c:1445\n     filename_create+0x14b/0x630\
  \ fs/namei.c:3467\n     user_path_create fs/namei.c:3524 [inline]\n     do_mkdirat+0x56/0x310\
  \ fs/namei.c:3664\n     do_syscall_64+0x31/0x70 arch/x86/entry/common.c:46\n   \
  \  entry_SYSCALL_64_after_hwframe+0x44/0xa9\n    [...]\n\nThe problem is that an\
  \ inode has F2FS_CASEFOLD_FL set, but the\nfilesystem doesn't have the casefold\
  \ feature flag set, and therefore\nsuper_block::s_encoding is NULL.\n\nFix this\
  \ by making sanity_check_inode() reject inodes that have\nF2FS_CASEFOLD_FL when\
  \ the filesystem doesn't have the casefold feature.\n\nReported-by: syzbot+05139c4039d0679e19ff@syzkaller.appspotmail.com\n\
  Fixes: 2c2eb7a300cd (\"f2fs: Support case-insensitive file name lookups\")\nSigned-off-by:\
  \ Eric Biggers <ebiggers@google.com>\nReviewed-by: Gabriel Krisman Bertazi <krisman@collabora.com>\n\
  Reviewed-by: Chao Yu <yuchao0@huawei.com>\nSigned-off-by: Jaegeuk Kim <jaegeuk@kernel.org>\n"
submodule:
- fs/f2fs
hunk_count: 1
covered_count: 0
