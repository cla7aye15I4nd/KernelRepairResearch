id: e3f96c43d19782dd14a7
bug_link: https://syzkaller.appspot.com/bug?extid=e3f96c43d19782dd14a7
title: 'KASAN: use-after-free Read in ucma_destroy_private_ctx'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: d9e410ebbed9d091b97bdf45b8a3792e2878dc48
fix_commit: 36e8169ec973359f671f9ec7213547059cae972e
datetime: '2022-01-28T11:36:55-04:00'
fix_commit_message: "RDMA/ucma: Protect mc during concurrent multicast leaves\n\n\
  Partially revert the commit mentioned in the Fixes line to make sure that\nallocation\
  \ and erasing multicast struct are locked.\n\n  BUG: KASAN: use-after-free in ucma_cleanup_multicast\
  \ drivers/infiniband/core/ucma.c:491 [inline]\n  BUG: KASAN: use-after-free in ucma_destroy_private_ctx+0x914/0xb70\
  \ drivers/infiniband/core/ucma.c:579\n  Read of size 8 at addr ffff88801bb74b00\
  \ by task syz-executor.1/25529\n  CPU: 0 PID: 25529 Comm: syz-executor.1 Not tainted\
  \ 5.16.0-rc7-syzkaller #0\n  Hardware name: Google Google Compute Engine/Google\
  \ Compute Engine, BIOS Google 01/01/2011\n  Call Trace:\n   __dump_stack lib/dump_stack.c:88\
  \ [inline]\n   dump_stack_lvl+0xcd/0x134 lib/dump_stack.c:106\n   print_address_description.constprop.0.cold+0x8d/0x320\
  \ mm/kasan/report.c:247\n   __kasan_report mm/kasan/report.c:433 [inline]\n   kasan_report.cold+0x83/0xdf\
  \ mm/kasan/report.c:450\n   ucma_cleanup_multicast drivers/infiniband/core/ucma.c:491\
  \ [inline]\n   ucma_destroy_private_ctx+0x914/0xb70 drivers/infiniband/core/ucma.c:579\n\
  \   ucma_destroy_id+0x1e6/0x280 drivers/infiniband/core/ucma.c:614\n   ucma_write+0x25c/0x350\
  \ drivers/infiniband/core/ucma.c:1732\n   vfs_write+0x28e/0xae0 fs/read_write.c:588\n\
  \   ksys_write+0x1ee/0x250 fs/read_write.c:643\n   do_syscall_x64 arch/x86/entry/common.c:50\
  \ [inline]\n   do_syscall_64+0x35/0xb0 arch/x86/entry/common.c:80\n   entry_SYSCALL_64_after_hwframe+0x44/0xae\n\
  \nCurrently the xarray search can touch a concurrently freeing mc as the\nxa_for_each()\
  \ is not surrounded by any lock. Rather than hold the lock for\na full scan hold\
  \ it only for the effected items, which is usually an empty\nlist.\n\nFixes: 95fe51096b7a\
  \ (\"RDMA/ucma: Remove mc_list and rely on xarray\")\nLink: https://lore.kernel.org/r/1cda5fabb1081e8d16e39a48d3a4f8160cea88b8.1642491047.git.leonro@nvidia.com\n\
  Reported-by: syzbot+e3f96c43d19782dd14a7@syzkaller.appspotmail.com\nSuggested-by:\
  \ Jason Gunthorpe <jgg@nvidia.com>\nReviewed-by: Maor Gottlieb <maorg@nvidia.com>\n\
  Signed-off-by: Leon Romanovsky <leonro@nvidia.com>\nSigned-off-by: Jason Gunthorpe\
  \ <jgg@nvidia.com>\n"
submodule:
- drivers/infiniband/core
hunk_count: 7
covered_count: 7
