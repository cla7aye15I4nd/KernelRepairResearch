id: df47f81c226b31d89fb1
bug_link: https://syzkaller.appspot.com/bug?extid=df47f81c226b31d89fb1
title: WARNING in kernfs_add_one
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: cd4846c5a68da77705164924f47001af3b499dec
fix_commit: 84d0c27d6233a9ba0578b20f5a09701eb66cee42
datetime: '2018-05-14T16:37:46+02:00'
fix_commit_message: 'driver core: Don''t ignore class_dir_create_and_add() failure.


  syzbot is hitting WARN() at kernfs_add_one() [1].

  This is because kernfs_create_link() is confused by previous device_add()

  call which continued without setting dev->kobj.parent field when

  get_device_parent() failed by memory allocation fault injection.

  Fix this by propagating the error from class_dir_create_and_add() to

  the calllers of get_device_parent().


  [1] https://syzkaller.appspot.com/bug?id=fae0fb607989ea744526d1c082a5b8de6529116f


  Signed-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp>

  Reported-by: syzbot <syzbot+df47f81c226b31d89fb1@syzkaller.appspotmail.com>

  Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

  Cc: stable <stable@vger.kernel.org>

  Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

  '
submodule:
- drivers/base
hunk_count: 5
covered_count: 1
