id: 59e0101c430934bc9a36
bug_link: https://syzkaller.appspot.com/bug?extid=59e0101c430934bc9a36
title: 'WARNING: ODEBUG bug in ext4_fill_super (4)'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: bd8daa7717d94752ecd4a60b67a928d7159c2825
fix_commit: 0ce160c5bdb67081a62293028dc85758a8efb22a
datetime: '2024-08-26T21:20:57-04:00'
fix_commit_message: 'ext4: fix timer use-after-free on failed mount


  Syzbot has found an ODEBUG bug in ext4_fill_super


  The del_timer_sync function cancels the s_err_report timer,

  which reminds about filesystem errors daily. We should

  guarantee the timer is no longer active before kfree(sbi).


  When filesystem mounting fails, the flow goes to failed_mount3,

  where an error occurs when ext4_stop_mmpd is called, causing

  a read I/O failure. This triggers the ext4_handle_error function

  that ultimately re-arms the timer,

  leaving the s_err_report timer active before kfree(sbi) is called.


  Fix the issue by canceling the s_err_report timer after calling ext4_stop_mmpd.


  Signed-off-by: Xiaxi Shen <shenxiaxi26@gmail.com>

  Reported-and-tested-by: syzbot+59e0101c430934bc9a36@syzkaller.appspotmail.com

  Closes: https://syzkaller.appspot.com/bug?extid=59e0101c430934bc9a36

  Link: https://patch.msgid.link/20240715043336.98097-1-shenxiaxi26@gmail.com

  Signed-off-by: Theodore Ts''o <tytso@mit.edu>

  Cc: stable@kernel.org

  '
submodule:
- fs/ext4
hunk_count: 1
covered_count: 0
