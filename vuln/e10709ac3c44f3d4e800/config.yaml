id: e10709ac3c44f3d4e800
bug_link: https://syzkaller.appspot.com/bug?extid=e10709ac3c44f3d4e800
title: WARNING in restore_regulatory_settings (3)
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 8c3170628a9ce24a59647bd24f897e666af919b8
fix_commit: 59b348be7597c4a9903cb003c69e37df20c04a30
datetime: '2025-03-03T09:46:19+01:00'
fix_commit_message: "wifi: cfg80211: regulatory: improve invalid hints checking\n\n\
  Syzbot keeps reporting an issue [1] that occurs when erroneous symbols\nsent from\
  \ userspace get through into user_alpha2[] via\nregulatory_hint_user() call. Such\
  \ invalid regulatory hints should be\nrejected.\n\nWhile a sanity check from commit\
  \ 47caf685a685 (\"cfg80211: regulatory:\nreject invalid hints\") looks to be enough\
  \ to deter these very cases,\nthere is a way to get around it due to 2 reasons.\n\
  \n1) The way isalpha() works, symbols other than latin lower and\nupper letters\
  \ may be used to determine a country/domain.\nFor instance, greek letters will also\
  \ be considered upper/lower\nletters and for such characters isalpha() will return\
  \ true as well.\nHowever, ISO-3166-1 alpha2 codes should only hold latin\ncharacters.\n\
  \n2) While processing a user regulatory request, between\nreg_process_hint_user()\
  \ and regulatory_hint_user() there happens to\nbe a call to queue_regulatory_request()\
  \ which modifies letters in\nrequest->alpha2[] with toupper(). This works fine for\
  \ latin symbols,\nless so for weird letter characters from the second part of _ctype[].\n\
  \nSyzbot triggers a warning in is_user_regdom_saved() by first sending\nover an\
  \ unexpected non-latin letter that gets malformed by toupper()\ninto a character\
  \ that ends up failing isalpha() check.\n\nPrevent this by enhancing is_an_alpha2()\
  \ to ensure that incoming\nsymbols are latin letters and nothing else.\n\n[1] Syzbot\
  \ report:\n------------[ cut here ]------------\nUnexpected user alpha2: Aï¿½\nWARNING:\
  \ CPU: 1 PID: 964 at net/wireless/reg.c:442 is_user_regdom_saved net/wireless/reg.c:440\
  \ [inline]\nWARNING: CPU: 1 PID: 964 at net/wireless/reg.c:442 restore_alpha2 net/wireless/reg.c:3424\
  \ [inline]\nWARNING: CPU: 1 PID: 964 at net/wireless/reg.c:442 restore_regulatory_settings+0x3c0/0x1e50\
  \ net/wireless/reg.c:3516\nModules linked in:\nCPU: 1 UID: 0 PID: 964 Comm: kworker/1:2\
  \ Not tainted 6.12.0-rc5-syzkaller-00044-gc1e939a21eb1 #0\nHardware name: Google\
  \ Google Compute Engine/Google Compute Engine, BIOS Google 09/13/2024\nWorkqueue:\
  \ events_power_efficient crda_timeout_work\nRIP: 0010:is_user_regdom_saved net/wireless/reg.c:440\
  \ [inline]\nRIP: 0010:restore_alpha2 net/wireless/reg.c:3424 [inline]\nRIP: 0010:restore_regulatory_settings+0x3c0/0x1e50\
  \ net/wireless/reg.c:3516\n...\nCall Trace:\n <TASK>\n crda_timeout_work+0x27/0x50\
  \ net/wireless/reg.c:542\n process_one_work kernel/workqueue.c:3229 [inline]\n process_scheduled_works+0xa65/0x1850\
  \ kernel/workqueue.c:3310\n worker_thread+0x870/0xd30 kernel/workqueue.c:3391\n\
  \ kthread+0x2f2/0x390 kernel/kthread.c:389\n ret_from_fork+0x4d/0x80 arch/x86/kernel/process.c:147\n\
  \ ret_from_fork_asm+0x1a/0x30 arch/x86/entry/entry_64.S:244\n </TASK>\n\nReported-by:\
  \ syzbot+e10709ac3c44f3d4e800@syzkaller.appspotmail.com\nCloses: https://syzkaller.appspot.com/bug?extid=e10709ac3c44f3d4e800\n\
  Fixes: 09d989d179d0 (\"cfg80211: add regulatory hint disconnect support\")\nCc:\
  \ stable@kernel.org\nSigned-off-by: Nikita Zhandarovich <n.zhandarovich@fintech.ru>\n\
  Link: https://patch.msgid.link/20250228134659.1577656-1-n.zhandarovich@fintech.ru\n\
  Signed-off-by: Johannes Berg <johannes.berg@intel.com>\n"
submodule:
- net/wireless
hunk_count: 1
covered_count: 1
