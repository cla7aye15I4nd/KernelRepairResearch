id: cf4f2b6c24aff0a3edf6
bug_link: https://syzkaller.appspot.com/bug?extid=cf4f2b6c24aff0a3edf6
title: 'INFO: trying to register non-static key in ni6501_detach'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: f4e97f5d4c9ece362b9379d3158cf5e4c02404dc
fix_commit: 660cf4ce9d0f3497cc7456eaa6d74c8b71d6282c
datetime: '2019-04-17T11:59:24+02:00'
fix_commit_message: "staging: comedi: ni_usb6501: Fix use of uninitialized mutex\n\
  \nIf `ni6501_auto_attach()` returns an error, the core comedi module code\nwill\
  \ call `ni6501_detach()` to clean up.  If `ni6501_auto_attach()`\nsuccessfully allocated\
  \ the comedi device private data, `ni6501_detach()`\nassumes that a `struct mutex\
  \ mut` contained in the private data has been\ninitialized and uses it.  Unfortunately,\
  \ there are a couple of places\nwhere `ni6501_auto_attach()` can return an error\
  \ after allocating the\ndevice private data but before initializing the mutex, so\
  \ this\nassumption is invalid.  Fix it by initializing the mutex just after\nallocating\
  \ the private data in `ni6501_auto_attach()` before any other\nerrors can be retturned.\
  \  Also move the call to `usb_set_intfdata()`\njust to keep the code a bit neater\
  \ (either position for the call is\nfine).\n\nI believe this was the cause of the\
  \ following syzbot crash report\n<https://syzkaller.appspot.com/bug?extid=cf4f2b6c24aff0a3edf6>:\n\
  \nusb 1-1: New USB device strings: Mfr=0, Product=0, SerialNumber=0\nusb 1-1: config\
  \ 0 descriptor??\nusb 1-1: string descriptor 0 read error: -71\ncomedi comedi0:\
  \ Wrong number of endpoints\nni6501 1-1:0.233: driver 'ni6501' failed to auto-configure\
  \ device.\nINFO: trying to register non-static key.\nthe code is fine but needs\
  \ lockdep annotation.\nturning off the locking correctness validator.\nCPU: 0 PID:\
  \ 585 Comm: kworker/0:3 Not tainted 5.1.0-rc4-319354-g9a33b36 #3\nHardware name:\
  \ Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011\nWorkqueue:\
  \ usb_hub_wq hub_event\nCall Trace:\n __dump_stack lib/dump_stack.c:77 [inline]\n\
  \ dump_stack+0xe8/0x16e lib/dump_stack.c:113\n assign_lock_key kernel/locking/lockdep.c:786\
  \ [inline]\n register_lock_class+0x11b8/0x1250 kernel/locking/lockdep.c:1095\n __lock_acquire+0xfb/0x37c0\
  \ kernel/locking/lockdep.c:3582\n lock_acquire+0x10d/0x2f0 kernel/locking/lockdep.c:4211\n\
  \ __mutex_lock_common kernel/locking/mutex.c:925 [inline]\n __mutex_lock+0xfe/0x12b0\
  \ kernel/locking/mutex.c:1072\n ni6501_detach+0x5b/0x110 drivers/staging/comedi/drivers/ni_usb6501.c:567\n\
  \ comedi_device_detach+0xed/0x800 drivers/staging/comedi/drivers.c:204\n comedi_device_cleanup.part.0+0x68/0x140\
  \ drivers/staging/comedi/comedi_fops.c:156\n comedi_device_cleanup drivers/staging/comedi/comedi_fops.c:187\
  \ [inline]\n comedi_free_board_dev.part.0+0x16/0x90 drivers/staging/comedi/comedi_fops.c:190\n\
  \ comedi_free_board_dev drivers/staging/comedi/comedi_fops.c:189 [inline]\n comedi_release_hardware_device+0x111/0x140\
  \ drivers/staging/comedi/comedi_fops.c:2880\n comedi_auto_config.cold+0x124/0x1b0\
  \ drivers/staging/comedi/drivers.c:1068\n usb_probe_interface+0x31d/0x820 drivers/usb/core/driver.c:361\n\
  \ really_probe+0x2da/0xb10 drivers/base/dd.c:509\n driver_probe_device+0x21d/0x350\
  \ drivers/base/dd.c:671\n __device_attach_driver+0x1d8/0x290 drivers/base/dd.c:778\n\
  \ bus_for_each_drv+0x163/0x1e0 drivers/base/bus.c:454\n __device_attach+0x223/0x3a0\
  \ drivers/base/dd.c:844\n bus_probe_device+0x1f1/0x2a0 drivers/base/bus.c:514\n\
  \ device_add+0xad2/0x16e0 drivers/base/core.c:2106\n usb_set_configuration+0xdf7/0x1740\
  \ drivers/usb/core/message.c:2021\n generic_probe+0xa2/0xda drivers/usb/core/generic.c:210\n\
  \ usb_probe_device+0xc0/0x150 drivers/usb/core/driver.c:266\n really_probe+0x2da/0xb10\
  \ drivers/base/dd.c:509\n driver_probe_device+0x21d/0x350 drivers/base/dd.c:671\n\
  \ __device_attach_driver+0x1d8/0x290 drivers/base/dd.c:778\n bus_for_each_drv+0x163/0x1e0\
  \ drivers/base/bus.c:454\n __device_attach+0x223/0x3a0 drivers/base/dd.c:844\n bus_probe_device+0x1f1/0x2a0\
  \ drivers/base/bus.c:514\n device_add+0xad2/0x16e0 drivers/base/core.c:2106\n usb_new_device.cold+0x537/0xccf\
  \ drivers/usb/core/hub.c:2534\n hub_port_connect drivers/usb/core/hub.c:5089 [inline]\n\
  \ hub_port_connect_change drivers/usb/core/hub.c:5204 [inline]\n port_event drivers/usb/core/hub.c:5350\
  \ [inline]\n hub_event+0x138e/0x3b00 drivers/usb/core/hub.c:5432\n process_one_work+0x90f/0x1580\
  \ kernel/workqueue.c:2269\n worker_thread+0x9b/0xe20 kernel/workqueue.c:2415\n kthread+0x313/0x420\
  \ kernel/kthread.c:253\n ret_from_fork+0x3a/0x50 arch/x86/entry/entry_64.S:352\n\
  \nReported-by: syzbot+cf4f2b6c24aff0a3edf6@syzkaller.appspotmail.com\nSigned-off-by:\
  \ Ian Abbott <abbotti@mev.co.uk>\nCc: stable <stable@vger.kernel.org>\nSigned-off-by:\
  \ Greg Kroah-Hartman <gregkh@linuxfoundation.org>\n"
submodule:
- drivers/staging/comedi/drivers
hunk_count: 2
covered_count: 2
