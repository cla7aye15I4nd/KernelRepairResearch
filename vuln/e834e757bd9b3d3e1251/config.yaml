id: e834e757bd9b3d3e1251
bug_link: https://syzkaller.appspot.com/bug?extid=e834e757bd9b3d3e1251
title: 'UBSAN: array-index-out-of-bounds in ieee80211_request_ibss_scan (2)'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 2aec790e666bf1f11d39bb50aa9df8febd58a548
fix_commit: 444020f4bf06fb86805ee7e7ceec0375485fd94d
datetime: '2025-07-15T10:27:21+02:00'
fix_commit_message: 'wifi: cfg80211: remove scan request n_channels counted_by


  This reverts commit e3eac9f32ec0 ("wifi: cfg80211: Annotate struct

  cfg80211_scan_request with __counted_by").


  This really has been a completely failed experiment. There were

  no actual bugs found, and yet at this point we already have four

  "fixes" to it, with nothing to show for but code churn, and it

  never even made the code any safer.


  In all of the cases that ended up getting "fixed", the structure

  is also internally inconsistent after the n_channels setting as

  the channel list isn''t actually filled yet. You cannot scan with

  such a structure, that''s just wrong. In mac80211, the struct is

  also reused multiple times, so initializing it once is no good.


  Some previous "fixes" (e.g. one in brcm80211) are also just setting

  n_channels before accessing the array, under the assumption that the

  code is correct and the array can be accessed, further showing that

  the whole thing is just pointless when the allocation count and use

  count are not separate.


  If we really wanted to fix it, we''d need to separately track the

  number of channels allocated and the number of channels currently

  used, but given that no bugs were found despite the numerous syzbot

  reports, that''d just be a waste of time.


  Remove the __counted_by() annotation. We really should also remove

  a number of the n_channels settings that are setting up a structure

  that''s inconsistent, but that can wait.


  Reported-by: syzbot+e834e757bd9b3d3e1251@syzkaller.appspotmail.com

  Closes: https://syzkaller.appspot.com/bug?extid=e834e757bd9b3d3e1251

  Fixes: e3eac9f32ec0 ("wifi: cfg80211: Annotate struct cfg80211_scan_request with
  __counted_by")

  Link: https://patch.msgid.link/20250714142130.9b0bbb7e1f07.I09112ccde72d445e11348fc2bef68942cb2ffc94@changeid

  Signed-off-by: Johannes Berg <johannes.berg@intel.com>

  '
submodule:
- include/net
hunk_count: 1
covered_count: 0
