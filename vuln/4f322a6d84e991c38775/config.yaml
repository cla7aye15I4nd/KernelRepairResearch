id: 4f322a6d84e991c38775
bug_link: https://syzkaller.appspot.com/bug?extid=4f322a6d84e991c38775
title: 'BUG: sleeping function called from invalid context in smc_pnet_apply_ib'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: e13ad1443684f7afaff24cf207e85e97885256bd
fix_commit: 7ff57e98fb78ad94edafbdc7435f2d745e9e6bb5
datetime: '2022-02-24T09:09:33-08:00'
fix_commit_message: 'net/smc: Use a mutex for locking "struct smc_pnettable"


  smc_pnetid_by_table_ib() uses read_lock() and then it calls smc_pnet_apply_ib()

  which, in turn, calls mutex_lock(&smc_ib_devices.mutex).


  read_lock() disables preemption. Therefore, the code acquires a mutex while in

  atomic context and it leads to a SAC bug.


  Fix this bug by replacing the rwlock with a mutex.


  Reported-and-tested-by: syzbot+4f322a6d84e991c38775@syzkaller.appspotmail.com

  Fixes: 64e28b52c7a6 ("net/smc: add pnet table namespace support")

  Confirmed-by: Tony Lu <tonylu@linux.alibaba.com>

  Signed-off-by: Fabio M. De Francesco <fmdefrancesco@gmail.com>

  Acked-by: Karsten Graul <kgraul@linux.ibm.com>

  Link: https://lore.kernel.org/r/20220223100252.22562-1-fmdefrancesco@gmail.com

  Signed-off-by: Jakub Kicinski <kuba@kernel.org>

  '
submodule:
- net/smc
hunk_count: 20
covered_count: 9
