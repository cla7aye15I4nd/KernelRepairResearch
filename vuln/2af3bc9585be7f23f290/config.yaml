id: 2af3bc9585be7f23f290
bug_link: https://syzkaller.appspot.com/bug?extid=2af3bc9585be7f23f290
title: WARNING in mark_buffer_dirty (4)
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: d824ec2a154677f63c56cc71ffe4578274f6e32e
fix_commit: 28a65b49eb53e172d23567005465019658bfdb4d
datetime: '2023-05-06T10:10:07-07:00'
fix_commit_message: "nilfs2: do not write dirty data after degenerating to read-only\n\
  \nAccording to syzbot's report, mark_buffer_dirty() called from\nnilfs_segctor_do_construct()\
  \ outputs a warning with some patterns after\nnilfs2 detects metadata corruption\
  \ and degrades to read-only mode.\n\nAfter such read-only degeneration, page cache\
  \ data may be cleared through\nnilfs_clear_dirty_page() which may also clear the\
  \ uptodate flag for their\nbuffer heads.  However, even after the degeneration,\
  \ log writes are still\nperformed by unmount processing etc., which causes mark_buffer_dirty()\
  \ to\nbe called for buffer heads without the \"uptodate\" flag and causes the\n\
  warning.\n\nSince any writes should not be done to a read-only file system in the\n\
  first place, this fixes the warning in mark_buffer_dirty() by letting\nnilfs_segctor_do_construct()\
  \ abort early if in read-only mode.\n\nThis also changes the retry check of nilfs_segctor_write_out()\
  \ to avoid\nunnecessary log write retries if it detects -EROFS that\nnilfs_segctor_do_construct()\
  \ returned.\n\nLink: https://lkml.kernel.org/r/20230427011526.13457-1-konishi.ryusuke@gmail.com\n\
  Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>\nTested-by: Ryusuke Konishi\
  \ <konishi.ryusuke@gmail.com>\nReported-by: syzbot+2af3bc9585be7f23f290@syzkaller.appspotmail.com\n\
  \  Link: https://syzkaller.appspot.com/bug?extid=2af3bc9585be7f23f290\nCc: <stable@vger.kernel.org>\n\
  Signed-off-by: Andrew Morton <akpm@linux-foundation.org>\n"
submodule:
- fs/nilfs2
hunk_count: 2
covered_count: 0
