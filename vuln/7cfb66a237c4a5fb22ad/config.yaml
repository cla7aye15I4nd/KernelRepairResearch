id: 7cfb66a237c4a5fb22ad
bug_link: https://syzkaller.appspot.com/bug?extid=7cfb66a237c4a5fb22ad
title: possible deadlock in posix_clock_unregister
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: c04fdca8a98af5fc4eeb6569917f159cfa56b923
fix_commit: 2efe41234dbd0a83fdb7cd38226c2f70039a2cd3
datetime: '2025-08-12T14:17:35-07:00'
fix_commit_message: "ptp: prevent possible ABBA deadlock in ptp_clock_freerun()\n\n\
  syzbot reported the following ABBA deadlock:\n\n       CPU0                    \
  \       CPU1\n       ----                           ----\n  n_vclocks_store()\n\
  \    lock(&ptp->n_vclocks_mux) [1]\n        (physical clock)\n                 \
  \                    pc_clock_adjtime()\n                                      \
  \ lock(&clk->rwsem) [2]\n                                        (physical clock)\n\
  \                                       ...\n                                  \
  \     ptp_clock_freerun()\n                                         ptp_vclock_in_use()\n\
  \                                           lock(&ptp->n_vclocks_mux) [3]\n    \
  \                                          (physical clock)\n    ptp_clock_unregister()\n\
  \      posix_clock_unregister()\n        lock(&clk->rwsem) [4]\n          (virtual\
  \ clock)\n\nSince ptp virtual clock is registered only under ptp physical clock,\
  \ both\nptp_clock and posix_clock must be physical clocks for ptp_vclock_in_use()\n\
  to lock &ptp->n_vclocks_mux and check ptp->n_vclocks.\n\nHowever, when unregistering\
  \ vclocks in n_vclocks_store(), the locking\nptp->n_vclocks_mux is a physical clock\
  \ lock, but clk->rwsem of\nptp_clock_unregister() called through device_for_each_child_reverse()\n\
  is a virtual clock lock.\n\nTherefore, clk->rwsem used in CPU0 and clk->rwsem used\
  \ in CPU1 are\ndifferent locks, but in lockdep, a false positive occurs because\
  \ the\npossibility of deadlock is determined through lock-class.\n\nTo solve this,\
  \ lock subclass annotation must be added to the posix_clock\nrwsem of the vclock.\n\
  \nReported-by: syzbot+7cfb66a237c4a5fb22ad@syzkaller.appspotmail.com\nCloses: https://syzkaller.appspot.com/bug?extid=7cfb66a237c4a5fb22ad\n\
  Fixes: 73f37068d540 (\"ptp: support ptp physical/virtual clocks conversion\")\n\
  Signed-off-by: Jeongjun Park <aha310510@gmail.com>\nAcked-by: Richard Cochran <richardcochran@gmail.com>\n\
  Reviewed-by: Vladimir Oltean <vladimir.oltean@nxp.com>\nLink: https://patch.msgid.link/20250728062649.469882-1-aha310510@gmail.com\n\
  Signed-off-by: Jakub Kicinski <kuba@kernel.org>\n"
submodule:
- drivers/ptp
hunk_count: 3
covered_count: 2
