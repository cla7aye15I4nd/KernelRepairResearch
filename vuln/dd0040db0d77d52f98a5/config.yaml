id: dd0040db0d77d52f98a5
bug_link: https://syzkaller.appspot.com/bug?extid=dd0040db0d77d52f98a5
title: 'KASAN: use-after-free Read in devlink_health_reporter_destroy'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: c15841dd15af3ccbdc87031245ad1aee6d4362bb
fix_commit: 5d037b4d3df7b77ecd22fa8e10f5000bdc42cc8b
datetime: '2020-07-13T17:29:59-07:00'
fix_commit_message: "devlink: Fix use-after-free when destroying health reporters\n\
  \nDereferencing the reporter after it was destroyed in order to unlock the\nreporters\
  \ lock results in a use-after-free [1].\n\nFix this by storing a pointer to the\
  \ lock in a local variable before\ndestroying the reporter.\n\n[1]\n==================================================================\n\
  BUG: KASAN: use-after-free in devlink_health_reporter_destroy+0x15c/0x1b0 net/core/devlink.c:5476\n\
  Read of size 8 at addr ffff8880650fd020 by task syz-executor.1/904\n\nCPU: 0 PID:\
  \ 904 Comm: syz-executor.1 Not tainted 5.8.0-rc2+ #35\nHardware name: QEMU Standard\
  \ PC (i440FX + PIIX, 1996), BIOS rel-1.12.1-0-ga5cab58e9a3f-prebuilt.qemu.org 04/01/2014\n\
  Call Trace:\n __dump_stack lib/dump_stack.c:77 [inline]\n dump_stack+0xf6/0x16e\
  \ lib/dump_stack.c:118\n print_address_description.constprop.0+0x1c/0x250 mm/kasan/report.c:383\n\
  \ __kasan_report mm/kasan/report.c:513 [inline]\n kasan_report.cold+0x1f/0x37 mm/kasan/report.c:530\n\
  \ devlink_health_reporter_destroy+0x15c/0x1b0 net/core/devlink.c:5476\n nsim_dev_health_exit+0x8b/0xe0\
  \ drivers/net/netdevsim/health.c:317\n nsim_dev_reload_destroy+0x7f/0x110 drivers/net/netdevsim/dev.c:1134\n\
  \ nsim_dev_reload_down+0x6e/0xd0 drivers/net/netdevsim/dev.c:712\n devlink_reload+0xc6/0x3b0\
  \ net/core/devlink.c:2952\n devlink_nl_cmd_reload+0x2f1/0x7c0 net/core/devlink.c:2987\n\
  \ genl_family_rcv_msg_doit net/netlink/genetlink.c:691 [inline]\n genl_family_rcv_msg\
  \ net/netlink/genetlink.c:736 [inline]\n genl_rcv_msg+0x611/0x9d0 net/netlink/genetlink.c:753\n\
  \ netlink_rcv_skb+0x152/0x440 net/netlink/af_netlink.c:2469\n genl_rcv+0x24/0x40\
  \ net/netlink/genetlink.c:764\n netlink_unicast_kernel net/netlink/af_netlink.c:1303\
  \ [inline]\n netlink_unicast+0x53a/0x750 net/netlink/af_netlink.c:1329\n netlink_sendmsg+0x850/0xd90\
  \ net/netlink/af_netlink.c:1918\n sock_sendmsg_nosec net/socket.c:652 [inline]\n\
  \ sock_sendmsg+0x150/0x190 net/socket.c:672\n ____sys_sendmsg+0x6d8/0x840 net/socket.c:2363\n\
  \ ___sys_sendmsg+0xff/0x170 net/socket.c:2417\n __sys_sendmsg+0xe5/0x1b0 net/socket.c:2450\n\
  \ do_syscall_64+0x56/0xa0 arch/x86/entry/common.c:359\n entry_SYSCALL_64_after_hwframe+0x44/0xa9\n\
  RIP: 0033:0x4748ad\nCode: Bad RIP value.\nRSP: 002b:00007fd0358adc38 EFLAGS: 00000246\
  \ ORIG_RAX: 000000000000002e\nRAX: ffffffffffffffda RBX: 000000000056bf00 RCX: 00000000004748ad\n\
  RDX: 0000000000000000 RSI: 00000000200000c0 RDI: 0000000000000003\nRBP: 00000000ffffffff\
  \ R08: 0000000000000000 R09: 0000000000000000\nR10: 0000000000000000 R11: 0000000000000246\
  \ R12: 0000000000000000\nR13: 00000000004d1a4b R14: 00007fd0358ae6b4 R15: 00007fd0358add80\n\
  \nAllocated by task 539:\n save_stack+0x1b/0x40 mm/kasan/common.c:48\n set_track\
  \ mm/kasan/common.c:56 [inline]\n __kasan_kmalloc mm/kasan/common.c:494 [inline]\n\
  \ __kasan_kmalloc.constprop.0+0xc2/0xd0 mm/kasan/common.c:467\n kmalloc include/linux/slab.h:555\
  \ [inline]\n kzalloc include/linux/slab.h:669 [inline]\n __devlink_health_reporter_create+0x91/0x2f0\
  \ net/core/devlink.c:5359\n devlink_health_reporter_create+0xa1/0x170 net/core/devlink.c:5431\n\
  \ nsim_dev_health_init+0x95/0x3a0 drivers/net/netdevsim/health.c:279\n nsim_dev_probe+0xb1e/0xeb0\
  \ drivers/net/netdevsim/dev.c:1086\n really_probe+0x287/0x6d0 drivers/base/dd.c:525\n\
  \ driver_probe_device+0xfe/0x1d0 drivers/base/dd.c:701\n __device_attach_driver+0x21e/0x290\
  \ drivers/base/dd.c:807\n bus_for_each_drv+0x161/0x1e0 drivers/base/bus.c:431\n\
  \ __device_attach+0x21a/0x360 drivers/base/dd.c:873\n bus_probe_device+0x1e6/0x290\
  \ drivers/base/bus.c:491\n device_add+0xaf2/0x1b00 drivers/base/core.c:2680\n nsim_bus_dev_new\
  \ drivers/net/netdevsim/bus.c:336 [inline]\n new_device_store+0x374/0x590 drivers/net/netdevsim/bus.c:215\n\
  \ bus_attr_store+0x75/0xa0 drivers/base/bus.c:122\n sysfs_kf_write+0x113/0x170 fs/sysfs/file.c:138\n\
  \ kernfs_fop_write+0x25d/0x480 fs/kernfs/file.c:315\n __vfs_write+0x7c/0x100 fs/read_write.c:495\n\
  \ vfs_write+0x265/0x5e0 fs/read_write.c:559\n ksys_write+0x12d/0x250 fs/read_write.c:612\n\
  \ do_syscall_64+0x56/0xa0 arch/x86/entry/common.c:359\n entry_SYSCALL_64_after_hwframe+0x44/0xa9\n\
  \nFreed by task 904:\n save_stack+0x1b/0x40 mm/kasan/common.c:48\n set_track mm/kasan/common.c:56\
  \ [inline]\n kasan_set_free_info mm/kasan/common.c:316 [inline]\n __kasan_slab_free+0x12c/0x170\
  \ mm/kasan/common.c:455\n slab_free_hook mm/slub.c:1474 [inline]\n slab_free_freelist_hook\
  \ mm/slub.c:1507 [inline]\n slab_free mm/slub.c:3072 [inline]\n kfree+0xe6/0x320\
  \ mm/slub.c:4063\n devlink_health_reporter_free net/core/devlink.c:5449 [inline]\n\
  \ devlink_health_reporter_put+0xb7/0xf0 net/core/devlink.c:5456\n __devlink_health_reporter_destroy\
  \ net/core/devlink.c:5463 [inline]\n devlink_health_reporter_destroy+0x11b/0x1b0\
  \ net/core/devlink.c:5475\n nsim_dev_health_exit+0x8b/0xe0 drivers/net/netdevsim/health.c:317\n\
  \ nsim_dev_reload_destroy+0x7f/0x110 drivers/net/netdevsim/dev.c:1134\n nsim_dev_reload_down+0x6e/0xd0\
  \ drivers/net/netdevsim/dev.c:712\n devlink_reload+0xc6/0x3b0 net/core/devlink.c:2952\n\
  \ devlink_nl_cmd_reload+0x2f1/0x7c0 net/core/devlink.c:2987\n genl_family_rcv_msg_doit\
  \ net/netlink/genetlink.c:691 [inline]\n genl_family_rcv_msg net/netlink/genetlink.c:736\
  \ [inline]\n genl_rcv_msg+0x611/0x9d0 net/netlink/genetlink.c:753\n netlink_rcv_skb+0x152/0x440\
  \ net/netlink/af_netlink.c:2469\n genl_rcv+0x24/0x40 net/netlink/genetlink.c:764\n\
  \ netlink_unicast_kernel net/netlink/af_netlink.c:1303 [inline]\n netlink_unicast+0x53a/0x750\
  \ net/netlink/af_netlink.c:1329\n netlink_sendmsg+0x850/0xd90 net/netlink/af_netlink.c:1918\n\
  \ sock_sendmsg_nosec net/socket.c:652 [inline]\n sock_sendmsg+0x150/0x190 net/socket.c:672\n\
  \ ____sys_sendmsg+0x6d8/0x840 net/socket.c:2363\n ___sys_sendmsg+0xff/0x170 net/socket.c:2417\n\
  \ __sys_sendmsg+0xe5/0x1b0 net/socket.c:2450\n do_syscall_64+0x56/0xa0 arch/x86/entry/common.c:359\n\
  \ entry_SYSCALL_64_after_hwframe+0x44/0xa9\n\nThe buggy address belongs to the object\
  \ at ffff8880650fd000\n which belongs to the cache kmalloc-512 of size 512\nThe\
  \ buggy address is located 32 bytes inside of\n 512-byte region [ffff8880650fd000,\
  \ ffff8880650fd200)\nThe buggy address belongs to the page:\npage:ffffea0001943f00\
  \ refcount:1 mapcount:0 mapping:0000000000000000 index:0xffff8880650ff800 head:ffffea0001943f00\
  \ order:2 compound_mapcount:0 compound_pincount:0\nflags: 0x100000000010200(slab|head)\n\
  raw: 0100000000010200 ffffea0001a06a08 ffffea00010ad308 ffff88806c402500\nraw: ffff8880650ff800\
  \ 0000000000100009 00000001ffffffff 0000000000000000\npage dumped because: kasan:\
  \ bad access detected\n\nMemory state around the buggy address:\n ffff8880650fcf00:\
  \ fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc\n ffff8880650fcf80: fc fc fc fc\
  \ fc fc fc fc fc fc fc fc fc fc fc fc\n>ffff8880650fd000: fb fb fb fb fb fb fb fb\
  \ fb fb fb fb fb fb fb fb\n                               ^\n ffff8880650fd080:\
  \ fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb\n ffff8880650fd100: fb fb fb fb\
  \ fb fb fb fb fb fb fb fb fb fb fb fb\n==================================================================\n\
  \nFixes: 3c5584bf0a04 (\"devlink: Rework devlink health reporter destructor\")\n\
  Fixes: 15c724b997a8 (\"devlink: Add devlink health port reporters API\")\nSigned-off-by:\
  \ Ido Schimmel <idosch@mellanox.com>\nReviewed-by: Moshe Shemesh <moshe@mellanox.com>\n\
  Reviewed-by: Jiri Pirko <jiri@mellanox.com>\nReviewed-by: Jakub Kicinski <kuba@kernel.org>\n\
  Signed-off-by: David S. Miller <davem@davemloft.net>\n"
submodule:
- net/core
hunk_count: 2
covered_count: 2
