id: e149f7d1328c26f9c12f
bug_link: https://syzkaller.appspot.com/bug?extid=e149f7d1328c26f9c12f
title: 'BUG: sleeping function called from invalid context at ./include/linux/percpu-rwsem.h:LINE'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: bcfd09f7837f5240c30fd2f52ee7293516641faa
fix_commit: b1bdcb59b64f806ef08d25a85c39ffb3ad841ce6
datetime: '2018-01-08T10:16:40+01:00'
fix_commit_message: 'xfrm: don''t call xfrm_policy_cache_flush while holding spinlock


  xfrm_policy_cache_flush can sleep, so it cannot be called while holding

  a spinlock.  We could release the lock first, but I don''t see why we need

  to invoke this function here in first place, the packet path won''t reuse

  an xdst entry unless its still valid.


  While at it, add an annotation to xfrm_policy_cache_flush, it would

  have probably caught this bug sooner.


  Fixes: ec30d78c14a813 ("xfrm: add xdst pcpu cache")

  Reported-by: syzbot+e149f7d1328c26f9c12f@syzkaller.appspotmail.com

  Signed-off-by: Florian Westphal <fw@strlen.de>

  Signed-off-by: Steffen Klassert <steffen.klassert@secunet.com>

  '
submodule:
- net/xfrm
hunk_count: 2
covered_count: 2
