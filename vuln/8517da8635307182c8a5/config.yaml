id: 8517da8635307182c8a5
bug_link: https://syzkaller.appspot.com/bug?extid=8517da8635307182c8a5
title: 'KASAN: slab-use-after-free Read in btrfs_cow_block'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: d29662695ed7c015521e5fc9387df25aab192a2e
fix_commit: 44f52bbe96dfdbe4aca3818a2534520082a07040
datetime: '2024-12-23T21:59:32+01:00'
fix_commit_message: 'btrfs: fix use-after-free when COWing tree bock and tracing is
  enabled


  When a COWing a tree block, at btrfs_cow_block(), and we have the

  tracepoint trace_btrfs_cow_block() enabled and preemption is also enabled

  (CONFIG_PREEMPT=y), we can trigger a use-after-free in the COWed extent

  buffer while inside the tracepoint code. This is because in some paths

  that call btrfs_cow_block(), such as btrfs_search_slot(), we are holding

  the last reference on the extent buffer @buf so btrfs_force_cow_block()

  drops the last reference on the @buf extent buffer when it calls

  free_extent_buffer_stale(buf), which schedules the release of the extent

  buffer with RCU. This means that if we are on a kernel with preemption,

  the current task may be preempted before calling trace_btrfs_cow_block()

  and the extent buffer already released by the time trace_btrfs_cow_block()

  is called, resulting in a use-after-free.


  Fix this by moving the trace_btrfs_cow_block() from btrfs_cow_block() to

  btrfs_force_cow_block() before the COWed extent buffer is freed.

  This also has a side effect of invoking the tracepoint in the tree defrag

  code, at defrag.c:btrfs_realloc_node(), since btrfs_force_cow_block() is

  called there, but this is fine and it was actually missing there.


  Reported-by: syzbot+8517da8635307182c8a5@syzkaller.appspotmail.com

  Link: https://lore.kernel.org/linux-btrfs/6759a9b9.050a0220.1ac542.000d.GAE@google.com/

  CC: stable@vger.kernel.org # 5.4+

  Reviewed-by: Qu Wenruo <wqu@suse.com>

  Signed-off-by: Filipe Manana <fdmanana@suse.com>

  Signed-off-by: David Sterba <dsterba@suse.com>

  '
submodule:
- fs/btrfs
hunk_count: 3
covered_count: 3
