id: aae069be1de40fb11825
bug_link: https://syzkaller.appspot.com/bug?extid=aae069be1de40fb11825
title: 'BUG: sleeping function called from invalid context in copy_huge_page'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 74c42e1baacf206338b1dd6b6199ac964512b5bb
fix_commit: a4aeaa06d45e90f9b279f0b09de84bd00006e733
datetime: '2021-10-28T17:18:55-07:00'
fix_commit_message: 'mm: khugepaged: skip huge page collapse for special files


  The read-only THP for filesystems will collapse THP for files opened

  readonly and mapped with VM_EXEC.  The intended usecase is to avoid TLB

  misses for large text segments.  But it doesn''t restrict the file types

  so a THP could be collapsed for a non-regular file, for example, block

  device, if it is opened readonly and mapped with EXEC permission.  This

  may cause bugs, like [1] and [2].


  This is definitely not the intended usecase, so just collapse THP for

  regular files in order to close the attack surface.


  [shy828301@gmail.com: fix vm_file check [3]]


  Link: https://lore.kernel.org/lkml/CACkBjsYwLYLRmX8GpsDpMthagWOjWWrNxqY6ZLNQVr6yx+f5vA@mail.gmail.com/
  [1]

  Link: https://lore.kernel.org/linux-mm/000000000000c6a82505ce284e4c@google.com/
  [2]

  Link: https://lkml.kernel.org/r/CAHbLzkqTW9U3VvTu1Ki5v_cLRC9gHW+znBukg_ycergE0JWj-A@mail.gmail.com
  [3]

  Link: https://lkml.kernel.org/r/20211027195221.3825-1-shy828301@gmail.com

  Fixes: 99cb0dbd47a1 ("mm,thp: add read-only THP support for (non-shmem) FS")

  Signed-off-by: Hugh Dickins <hughd@google.com>

  Signed-off-by: Yang Shi <shy828301@gmail.com>

  Reported-by: Hao Sun <sunhao.th@gmail.com>

  Reported-by: syzbot+aae069be1de40fb11825@syzkaller.appspotmail.com

  Cc: Matthew Wilcox <willy@infradead.org>

  Cc: Kirill A. Shutemov <kirill.shutemov@linux.intel.com>

  Cc: Song Liu <songliubraving@fb.com>

  Cc: Andrea Righi <andrea.righi@canonical.com>

  Cc: <stable@vger.kernel.org>

  Signed-off-by: Andrew Morton <akpm@linux-foundation.org>

  Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

  '
submodule:
- mm
hunk_count: 1
covered_count: 0
