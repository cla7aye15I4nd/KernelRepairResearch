id: 352e553a86e0d75f5120
bug_link: https://syzkaller.appspot.com/bug?extid=352e553a86e0d75f5120
title: possible deadlock in kvm_arch_pm_notifier
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: a64dcfb451e254085a7daee5fe51bf22959d52d3
fix_commit: d9c5ed0a9b529ee1103a4b68cec86112b26380e0
datetime: '2025-02-12T10:45:54-08:00'
fix_commit_message: 'KVM: x86: Don''t take kvm->lock when iterating over vCPUs in
  suspend notifier


  When queueing vCPU PVCLOCK updates in response to SUSPEND or HIBERNATE,

  don''t take kvm->lock as doing so can trigger a largely theoretical

  deadlock, it is perfectly safe to iterate over the xarray of vCPUs without

  holding kvm->lock, and kvm->lock doesn''t protect kvm_set_guest_paused() in

  any way (pv_time.active and pvclock_set_guest_stopped_request are

  protected by vcpu->mutex, not kvm->lock).


  Reported-by: syzbot+352e553a86e0d75f5120@syzkaller.appspotmail.com

  Closes: https://lore.kernel.org/all/677c0f36.050a0220.3b3668.0014.GAE@google.com

  Fixes: 7d62874f69d7 ("kvm: x86: implement KVM PM-notifier")

  Reviewed-by: Paul Durrant <paul@xen.org>

  Link: https://lore.kernel.org/r/20250201013827.680235-2-seanjc@google.com

  Signed-off-by: Sean Christopherson <seanjc@google.com>

  '
submodule:
- arch/x86/kvm
hunk_count: 2
covered_count: 2
