id: c4f4d25859c2e5859988
bug_link: https://syzkaller.appspot.com/bug?extid=c4f4d25859c2e5859988
title: possible deadlock in rcu_report_exp_cpu_mult
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 8c3fe029d79ada599fa558fdf3da0322fc38de36
fix_commit: ff91059932401894e6c86341915615c5eb0eca48
datetime: '2024-04-02T16:31:05+02:00'
fix_commit_message: "bpf, sockmap: Prevent lock inversion deadlock in map delete elem\n\
  \nsyzkaller started using corpuses where a BPF tracing program deletes\nelements\
  \ from a sockmap/sockhash map. Because BPF tracing programs can be\ninvoked from\
  \ any interrupt context, locks taken during a map_delete_elem\noperation must be\
  \ hardirq-safe. Otherwise a deadlock due to lock inversion\nis possible, as reported\
  \ by lockdep:\n\n       CPU0                    CPU1\n       ----              \
  \      ----\n  lock(&htab->buckets[i].lock);\n                               local_irq_disable();\n\
  \                               lock(&host->lock);\n                           \
  \    lock(&htab->buckets[i].lock);\n  <Interrupt>\n    lock(&host->lock);\n\nLocks\
  \ in sockmap are hardirq-unsafe by design. We expects elements to be\ndeleted from\
  \ sockmap/sockhash only in task (normal) context with interrupts\nenabled, or in\
  \ softirq context.\n\nDetect when map_delete_elem operation is invoked from a context\
  \ which is\n_not_ hardirq-unsafe, that is interrupts are disabled, and bail out\
  \ with an\nerror.\n\nNote that map updates are not affected by this issue. BPF verifier\
  \ does not\nallow updating sockmap/sockhash from a BPF tracing program today.\n\n\
  Fixes: 604326b41a6f (\"bpf, sockmap: convert to generic sk_msg interface\")\nReported-by:\
  \ xingwei lee <xrivendell7@gmail.com>\nReported-by: yue sun <samsun1006219@gmail.com>\n\
  Reported-by: syzbot+bc922f476bd65abbd466@syzkaller.appspotmail.com\nReported-by:\
  \ syzbot+d4066896495db380182e@syzkaller.appspotmail.com\nSigned-off-by: Jakub Sitnicki\
  \ <jakub@cloudflare.com>\nSigned-off-by: Daniel Borkmann <daniel@iogearbox.net>\n\
  Tested-by: syzbot+d4066896495db380182e@syzkaller.appspotmail.com\nAcked-by: John\
  \ Fastabend <john.fastabend@gmail.com>\nCloses: https://syzkaller.appspot.com/bug?extid=d4066896495db380182e\n\
  Closes: https://syzkaller.appspot.com/bug?extid=bc922f476bd65abbd466\nLink: https://lore.kernel.org/bpf/20240402104621.1050319-1-jakub@cloudflare.com\n"
submodule:
- net/core
hunk_count: 2
covered_count: 1
