id: 0a0596220218fcb603a8
bug_link: https://syzkaller.appspot.com/bug?extid=0a0596220218fcb603a8
title: WARNING in cbq_destroy_class
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 16b25d1a968e683eeef7523a4bbc4c8fd63aeedc
fix_commit: 2e24cd755552350b94a7617617c6877b8cbcb701
datetime: '2020-01-27T10:51:43+01:00'
fix_commit_message: 'net_sched: fix ops->bind_class() implementations


  The current implementations of ops->bind_class() are merely

  searching for classid and updating class in the struct tcf_result,

  without invoking either of cl_ops->bind_tcf() or

  cl_ops->unbind_tcf(). This breaks the design of them as qdisc''s

  like cbq use them to count filters too. This is why syzbot triggered

  the warning in cbq_destroy_class().


  In order to fix this, we have to call cl_ops->bind_tcf() and

  cl_ops->unbind_tcf() like the filter binding path. This patch does

  so by refactoring out two helper functions __tcf_bind_filter()

  and __tcf_unbind_filter(), which are lockless and accept a Qdisc

  pointer, then teaching each implementation to call them correctly.


  Note, we merely pass the Qdisc pointer as an opaque pointer to

  each filter, they only need to pass it down to the helper

  functions without understanding it at all.


  Fixes: 07d79fc7d94e ("net_sched: add reverse binding for tc class")

  Reported-and-tested-by: syzbot+0a0596220218fcb603a8@syzkaller.appspotmail.com

  Reported-and-tested-by: syzbot+63bdb6006961d8c917c6@syzkaller.appspotmail.com

  Cc: Jamal Hadi Salim <jhs@mojatatu.com>

  Cc: Jiri Pirko <jiri@resnulli.us>

  Signed-off-by: Cong Wang <xiyou.wangcong@gmail.com>

  Signed-off-by: David S. Miller <davem@davemloft.net>

  '
submodule:
- include/net
- net/sched
hunk_count: 15
covered_count: 0
