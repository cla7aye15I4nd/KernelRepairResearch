id: d3fe2dc5ffe9380b714b
bug_link: https://syzkaller.appspot.com/bug?extid=d3fe2dc5ffe9380b714b
title: kernel BUG in __vma_reservation_common
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: c2dc78b86e0821ecf9a9d0c35dba2618279a5bb6
fix_commit: 8daf9c702ee7f825f0de8600abff764acfedea13
datetime: '2024-06-05T19:19:26-07:00'
fix_commit_message: 'mm/hugetlb: do not call vma_add_reservation upon ENOMEM


  sysbot reported a splat [1] on __unmap_hugepage_range().  This is because

  vma_needs_reservation() can return -ENOMEM if

  allocate_file_region_entries() fails to allocate the file_region struct

  for the reservation.


  Check for that and do not call vma_add_reservation() if that is the case,

  otherwise region_abort() and region_del() will see that we do not have any

  file_regions.


  If we detect that vma_needs_reservation() returned -ENOMEM, we clear the

  hugetlb_restore_reserve flag as if this reservation was still consumed, so

  free_huge_folio() will not increment the resv count.


  [1] https://lore.kernel.org/linux-mm/0000000000004096100617c58d54@google.com/T/#ma5983bc1ab18a54910da83416b3f89f3c7ee43aa


  Link: https://lkml.kernel.org/r/20240528205323.20439-1-osalvador@suse.de

  Fixes: df7a6d1f6405 ("mm/hugetlb: restore the reservation if needed")

  Signed-off-by: Oscar Salvador <osalvador@suse.de>

  Reported-and-tested-by: syzbot+d3fe2dc5ffe9380b714b@syzkaller.appspotmail.com

  Closes: https://lore.kernel.org/linux-mm/0000000000004096100617c58d54@google.com/

  Cc: Breno Leitao <leitao@debian.org>

  Cc: Muchun Song <muchun.song@linux.dev>

  Cc: <stable@vger.kernel.org>

  Signed-off-by: Andrew Morton <akpm@linux-foundation.org>

  '
submodule:
- mm
hunk_count: 1
covered_count: 1
