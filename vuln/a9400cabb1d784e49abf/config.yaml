id: a9400cabb1d784e49abf
bug_link: https://syzkaller.appspot.com/bug?extid=a9400cabb1d784e49abf
title: 'KCSAN: data-race in ipv6_mc_down / mld_ifc_work (2)'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: bc9291dea7eca74b4a24bbdc173d7fde99c78718
fix_commit: 2e7ef287f07c74985f1bf2858bedc62bd9ebf155
datetime: '2024-01-18T09:52:30-08:00'
fix_commit_message: "ipv6: mcast: fix data-race in ipv6_mc_down / mld_ifc_work\n\n\
  idev->mc_ifc_count can be written over without proper locking.\n\nOriginally found\
  \ by syzbot [1], fix this issue by encapsulating calls\nto mld_ifc_stop_work() (and\
  \ mld_gq_stop_work() for good measure) with\nmutex_lock() and mutex_unlock() accordingly\
  \ as these functions\nshould only be called with mc_lock per their declarations.\n\
  \n[1]\nBUG: KCSAN: data-race in ipv6_mc_down / mld_ifc_work\n\nwrite to 0xffff88813a80c832\
  \ of 1 bytes by task 3771 on cpu 0:\n mld_ifc_stop_work net/ipv6/mcast.c:1080 [inline]\n\
  \ ipv6_mc_down+0x10a/0x280 net/ipv6/mcast.c:2725\n addrconf_ifdown+0xe32/0xf10 net/ipv6/addrconf.c:3949\n\
  \ addrconf_notify+0x310/0x980\n notifier_call_chain kernel/notifier.c:93 [inline]\n\
  \ raw_notifier_call_chain+0x6b/0x1c0 kernel/notifier.c:461\n __dev_notify_flags+0x205/0x3d0\n\
  \ dev_change_flags+0xab/0xd0 net/core/dev.c:8685\n do_setlink+0x9f6/0x2430 net/core/rtnetlink.c:2916\n\
  \ rtnl_group_changelink net/core/rtnetlink.c:3458 [inline]\n __rtnl_newlink net/core/rtnetlink.c:3717\
  \ [inline]\n rtnl_newlink+0xbb3/0x1670 net/core/rtnetlink.c:3754\n rtnetlink_rcv_msg+0x807/0x8c0\
  \ net/core/rtnetlink.c:6558\n netlink_rcv_skb+0x126/0x220 net/netlink/af_netlink.c:2545\n\
  \ rtnetlink_rcv+0x1c/0x20 net/core/rtnetlink.c:6576\n netlink_unicast_kernel net/netlink/af_netlink.c:1342\
  \ [inline]\n netlink_unicast+0x589/0x650 net/netlink/af_netlink.c:1368\n netlink_sendmsg+0x66e/0x770\
  \ net/netlink/af_netlink.c:1910\n ...\n\nwrite to 0xffff88813a80c832 of 1 bytes\
  \ by task 22 on cpu 1:\n mld_ifc_work+0x54c/0x7b0 net/ipv6/mcast.c:2653\n process_one_work\
  \ kernel/workqueue.c:2627 [inline]\n process_scheduled_works+0x5b8/0xa30 kernel/workqueue.c:2700\n\
  \ worker_thread+0x525/0x730 kernel/workqueue.c:2781\n ...\n\nFixes: 2d9a93b4902b\
  \ (\"mld: convert from timer to delayed work\")\nReported-by: syzbot+a9400cabb1d784e49abf@syzkaller.appspotmail.com\n\
  Link: https://lore.kernel.org/all/000000000000994e09060ebcdffb@google.com/\nSigned-off-by:\
  \ Nikita Zhandarovich <n.zhandarovich@fintech.ru>\nAcked-by: Taehee Yoo <ap420073@gmail.com>\n\
  Reviewed-by: Eric Dumazet <edumazet@google.com>\nReviewed-by: Hangbin Liu <liuhangbin@gmail.com>\n\
  Link: https://lore.kernel.org/r/20240117172102.12001-1-n.zhandarovich@fintech.ru\n\
  Signed-off-by: Jakub Kicinski <kuba@kernel.org>\n"
submodule:
- net/ipv6
hunk_count: 1
covered_count: 1
