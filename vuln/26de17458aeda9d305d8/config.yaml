id: 26de17458aeda9d305d8
bug_link: https://syzkaller.appspot.com/bug?extid=26de17458aeda9d305d8
title: WARNING in rds_message_alloc_sgs
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: c6f4075e2f14a91f2180c98bc7715946f791cbe6
fix_commit: ea010070d0a7497253d5a6f919f6dd107450b31a
datetime: '2018-12-19T10:27:58-08:00'
fix_commit_message: "net/rds: fix warn in rds_message_alloc_sgs\n\nredundant copy_from_user\
  \ in rds_sendmsg system call expose rds\nto issue where rds_rdma_extra_size walk\
  \ the rds iovec and and\ncalculate the number pf pages (sgs) it need to add to the\
  \ tail of\nrds message and later rds_cmsg_rdma_args copy the rds iovec again\nand\
  \ re calculate the same number and get different result causing\nWARN_ON in rds_message_alloc_sgs.\n\
  \nfix this by doing the copy_from_user only once per rds_sendmsg\nsystem call.\n\
  \nWhen issue occur the below dump is seen:\n\nWARNING: CPU: 0 PID: 19789 at net/rds/message.c:316\
  \ rds_message_alloc_sgs+0x10c/0x160 net/rds/message.c:316\nKernel panic - not syncing:\
  \ panic_on_warn set ...\nCPU: 0 PID: 19789 Comm: syz-executor827 Not tainted 4.19.0-next-20181030+\
  \ #101\nHardware name: Google Google Compute Engine/Google Compute Engine, BIOS\
  \ Google 01/01/2011\nCall Trace:\n __dump_stack lib/dump_stack.c:77 [inline]\n dump_stack+0x244/0x39d\
  \ lib/dump_stack.c:113\n panic+0x2ad/0x55c kernel/panic.c:188\n __warn.cold.8+0x20/0x45\
  \ kernel/panic.c:540\n report_bug+0x254/0x2d0 lib/bug.c:186\n fixup_bug arch/x86/kernel/traps.c:178\
  \ [inline]\n do_error_trap+0x11b/0x200 arch/x86/kernel/traps.c:271\n do_invalid_op+0x36/0x40\
  \ arch/x86/kernel/traps.c:290\n invalid_op+0x14/0x20 arch/x86/entry/entry_64.S:969\n\
  RIP: 0010:rds_message_alloc_sgs+0x10c/0x160 net/rds/message.c:316\nCode: c0 74 04\
  \ 3c 03 7e 6c 44 01 ab 78 01 00 00 e8 2b 9e 35 fa 4c 89 e0 48 83 c4 08 5b 41 5c\
  \ 41 5d 41 5e 41 5f 5d c3 e8 14 9e 35 fa <0f> 0b 31 ff 44 89 ee e8 18 9f 35 fa 45\
  \ 85 ed 75 1b e8 fe 9d 35 fa\nRSP: 0018:ffff8801c51b7460 EFLAGS: 00010293\nRAX:\
  \ ffff8801bc412080 RBX: ffff8801d7bf4040 RCX: ffffffff8749c9e6\nRDX: 0000000000000000\
  \ RSI: ffffffff8749ca5c RDI: 0000000000000004\nRBP: ffff8801c51b7490 R08: ffff8801bc412080\
  \ R09: ffffed003b5c5b67\nR10: ffffed003b5c5b67 R11: ffff8801dae2db3b R12: 0000000000000000\n\
  R13: 000000000007165c R14: 000000000007165c R15: 0000000000000005\n rds_cmsg_rdma_args+0x82d/0x1510\
  \ net/rds/rdma.c:623\n rds_cmsg_send net/rds/send.c:971 [inline]\n rds_sendmsg+0x19a2/0x3180\
  \ net/rds/send.c:1273\n sock_sendmsg_nosec net/socket.c:622 [inline]\n sock_sendmsg+0xd5/0x120\
  \ net/socket.c:632\n ___sys_sendmsg+0x7fd/0x930 net/socket.c:2117\n __sys_sendmsg+0x11d/0x280\
  \ net/socket.c:2155\n __do_sys_sendmsg net/socket.c:2164 [inline]\n __se_sys_sendmsg\
  \ net/socket.c:2162 [inline]\n __x64_sys_sendmsg+0x78/0xb0 net/socket.c:2162\n do_syscall_64+0x1b9/0x820\
  \ arch/x86/entry/common.c:290\n entry_SYSCALL_64_after_hwframe+0x49/0xbe\nRIP: 0033:0x44a859\n\
  Code: e8 dc e6 ff ff 48 83 c4 18 c3 0f 1f 80 00 00 00 00 48 89 f8 48 89 f7 48 89\
  \ d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 0f 83 6b\
  \ cb fb ff c3 66 2e 0f 1f 84 00 00 00 00\nRSP: 002b:00007f1d4710ada8 EFLAGS: 00000297\
  \ ORIG_RAX: 000000000000002e\nRAX: ffffffffffffffda RBX: 00000000006dcc28 RCX: 000000000044a859\n\
  RDX: 0000000000000000 RSI: 0000000020001600 RDI: 0000000000000003\nRBP: 00000000006dcc20\
  \ R08: 0000000000000000 R09: 0000000000000000\nR10: 0000000000000000 R11: 0000000000000297\
  \ R12: 00000000006dcc2c\nR13: 646e732f7665642f R14: 00007f1d4710b9c0 R15: 00000000006dcd2c\n\
  Kernel Offset: disabled\nRebooting in 86400 seconds..\n\nReported-by: syzbot+26de17458aeda9d305d8@syzkaller.appspotmail.com\n\
  Acked-by: Santosh Shilimkar <santosh.shilimkar@oracle.com>\nSigned-off-by: shamir\
  \ rabinovitch <shamir.rabinovitch@oracle.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>\n"
submodule:
- net/rds
hunk_count: 18
covered_count: 7
