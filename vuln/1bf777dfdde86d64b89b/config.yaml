id: 1bf777dfdde86d64b89b
bug_link: https://syzkaller.appspot.com/bug?extid=1bf777dfdde86d64b89b
title: general protection fault in __apic_accept_irq (2)
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 0a1ef9c81e9194c4faa5686bdd80c66d03ec31ef
fix_commit: 9d3c447c72fb2337ca39f245c6ae89f2369de216
datetime: '2020-06-29T11:03:52-04:00'
fix_commit_message: "KVM: X86: Fix async pf caused null-ptr-deref\n\nSyzbot reported\
  \ that:\n\n  CPU: 1 PID: 6780 Comm: syz-executor153 Not tainted 5.7.0-syzkaller\
  \ #0\n  Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS\
  \ Google 01/01/2011\n  RIP: 0010:__apic_accept_irq+0x46/0xb80\n  Call Trace:\n \
  \  kvm_arch_async_page_present+0x7de/0x9e0\n   kvm_check_async_pf_completion+0x18d/0x400\n\
  \   kvm_arch_vcpu_ioctl_run+0x18bf/0x69f0\n   kvm_vcpu_ioctl+0x46a/0xe20\n   ksys_ioctl+0x11a/0x180\n\
  \   __x64_sys_ioctl+0x6f/0xb0\n   do_syscall_64+0xf6/0x7d0\n   entry_SYSCALL_64_after_hwframe+0x49/0xb3\n\
  \nThe testcase enables APF mechanism in MSR_KVM_ASYNC_PF_EN with ASYNC_PF_INT\n\
  enabled w/o setting MSR_KVM_ASYNC_PF_INT before, what's worse, interrupt\nbased\
  \ APF 'page ready' event delivery depends on in kernel lapic, however,\nwe didn't\
  \ bail out when lapic is not in kernel during guest setting\nMSR_KVM_ASYNC_PF_EN\
  \ which causes the null-ptr-deref in host later.\nThis patch fixes it.\n\nReported-by:\
  \ syzbot+1bf777dfdde86d64b89b@syzkaller.appspotmail.com\nFixes: 2635b5c4a0 (KVM:\
  \ x86: interrupt based APF 'page ready' event delivery)\nSigned-off-by: Wanpeng\
  \ Li <wanpengli@tencent.com>\nMessage-Id: <1593426391-8231-1-git-send-email-wanpengli@tencent.com>\n\
  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>\n"
submodule:
- arch/x86/kvm
hunk_count: 1
covered_count: 0
