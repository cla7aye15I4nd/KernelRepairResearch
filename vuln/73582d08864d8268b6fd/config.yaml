id: 73582d08864d8268b6fd
bug_link: https://syzkaller.appspot.com/bug?extid=73582d08864d8268b6fd
title: 'INFO: task hung in snd_card_free'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: f69c2861b05e29c69abed6aafe0cefd224d9d4db
fix_commit: dafb28f02be407e07a6f679e922a626592b481b0
datetime: '2024-11-13T13:33:46+01:00'
fix_commit_message: 'ALSA: usx2y: Use snd_card_free_when_closed() at disconnection


  The USB disconnect callback is supposed to be short and not too-long

  waiting.  OTOH, the current code uses snd_card_free() at

  disconnection, but this waits for the close of all used fds, hence it

  can take long.  It eventually blocks the upper layer USB ioctls, which

  may trigger a soft lockup.


  An easy workaround is to replace snd_card_free() with

  snd_card_free_when_closed().  This variant returns immediately while

  the release of resources is done asynchronously by the card device

  release at the last close.


  Fixes: 230cd5e24853 ("[ALSA] prevent oops & dead keyboard on usb unplugging while
  the device is be ing used")

  Reported-by: syzbot+73582d08864d8268b6fd@syzkaller.appspotmail.com

  Closes: https://syzkaller.appspot.com/bug?extid=73582d08864d8268b6fd

  Signed-off-by: Takashi Iwai <tiwai@suse.de>

  Link: https://patch.msgid.link/20241113111042.15058-2-tiwai@suse.de

  '
submodule:
- sound/usb/usx2y
hunk_count: 1
covered_count: 1
