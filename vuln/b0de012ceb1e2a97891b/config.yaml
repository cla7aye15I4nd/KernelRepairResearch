id: b0de012ceb1e2a97891b
bug_link: https://syzkaller.appspot.com/bug?extid=b0de012ceb1e2a97891b
title: 'KASAN: use-after-free Read in usb_udc_uevent'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 26c6c2f8a907c9e3a2f24990552a4d77235791e6
fix_commit: 2191c00855b03aa59c20e698be713d952d51fc18
datetime: '2022-07-27T14:31:37+02:00'
fix_commit_message: "USB: gadget: Fix use-after-free Read in usb_udc_uevent()\n\n\
  The syzbot fuzzer found a race between uevent callbacks and gadget\ndriver unregistration\
  \ that can cause a use-after-free bug:\n\n---------------------------------------------------------------\n\
  BUG: KASAN: use-after-free in usb_udc_uevent+0x11f/0x130\ndrivers/usb/gadget/udc/core.c:1732\n\
  Read of size 8 at addr ffff888078ce2050 by task udevd/2968\n\nCPU: 1 PID: 2968 Comm:\
  \ udevd Not tainted 5.19.0-rc4-next-20220628-syzkaller #0\nHardware name: Google\
  \ Google Compute Engine/Google Compute Engine, BIOS Google\n06/29/2022\nCall Trace:\n\
  \ <TASK>\n __dump_stack lib/dump_stack.c:88 [inline]\n dump_stack_lvl+0xcd/0x134\
  \ lib/dump_stack.c:106\n print_address_description mm/kasan/report.c:317 [inline]\n\
  \ print_report.cold+0x2ba/0x719 mm/kasan/report.c:433\n kasan_report+0xbe/0x1f0\
  \ mm/kasan/report.c:495\n usb_udc_uevent+0x11f/0x130 drivers/usb/gadget/udc/core.c:1732\n\
  \ dev_uevent+0x290/0x770 drivers/base/core.c:2424\n---------------------------------------------------------------\n\
  \nThe bug occurs because usb_udc_uevent() dereferences udc->driver but\ndoes so\
  \ without acquiring the udc_lock mutex, which protects this\nfield.  If the gadget\
  \ driver is unbound from the udc concurrently with\nuevent processing, the driver\
  \ structure may be accessed after it has\nbeen deallocated.\n\nTo prevent the race,\
  \ we make sure that the routine holds the mutex\naround the racing accesses.\n\n\
  Link: <https://lore.kernel.org/all/0000000000004de90405a719c951@google.com>\nCC:\
  \ stable@vger.kernel.org # fc274c1e9973\nReported-and-tested-by: syzbot+b0de012ceb1e2a97891b@syzkaller.appspotmail.com\n\
  Signed-off-by: Alan Stern <stern@rowland.harvard.edu>\nLink: https://lore.kernel.org/r/YtlrnhHyrHsSky9m@rowland.harvard.edu\n\
  Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>\n"
submodule:
- drivers/usb/gadget/udc
hunk_count: 1
covered_count: 1
