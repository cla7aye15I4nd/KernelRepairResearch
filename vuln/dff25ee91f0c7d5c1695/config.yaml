id: dff25ee91f0c7d5c1695
bug_link: https://syzkaller.appspot.com/bug?extid=dff25ee91f0c7d5c1695
title: general protection fault in __apic_accept_irq
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 319109a2d0dde8672323efcf909740c2c6e98be4
fix_commit: a073d7e3ad687a7ef32b65affe80faa7ce89bf92
datetime: '2019-09-24T13:37:27+02:00'
fix_commit_message: "KVM: hyperv: Fix Direct Synthetic timers assert an interrupt\
  \ w/o lapic_in_kernel\n\nReported by syzkaller:\n\n\tkasan: GPF could be caused\
  \ by NULL-ptr deref or user memory access\n\tgeneral protection fault: 0000 [#1]\
  \ PREEMPT SMP KASAN\n\tRIP: 0010:__apic_accept_irq+0x46/0x740 arch/x86/kvm/lapic.c:1029\n\
  \tCall Trace:\n\tkvm_apic_set_irq+0xb4/0x140 arch/x86/kvm/lapic.c:558\n\tstimer_notify_direct\
  \ arch/x86/kvm/hyperv.c:648 [inline]\n\tstimer_expiration arch/x86/kvm/hyperv.c:659\
  \ [inline]\n\tkvm_hv_process_stimers+0x594/0x1650 arch/x86/kvm/hyperv.c:686\n\t\
  vcpu_enter_guest+0x2b2a/0x54b0 arch/x86/kvm/x86.c:7896\n\tvcpu_run+0x393/0xd40 arch/x86/kvm/x86.c:8152\n\
  \tkvm_arch_vcpu_ioctl_run+0x636/0x900 arch/x86/kvm/x86.c:8360\n\tkvm_vcpu_ioctl+0x6cf/0xaf0\
  \ arch/x86/kvm/../../../virt/kvm/kvm_main.c:2765\n\nThe testcase programs HV_X64_MSR_STIMERn_CONFIG/HV_X64_MSR_STIMERn_COUNT,\n\
  in addition, there is no lapic in the kernel, the counters value are small\nenough\
  \ in order that kvm_hv_process_stimers() inject this already-expired\ntimer interrupt\
  \ into the guest through lapic in the kernel which triggers\nthe NULL deferencing.\
  \ This patch fixes it by don't advertise direct mode\nsynthetic timers and discarding\
  \ the inject when lapic is not in kernel.\n\nsyzkaller source: https://syzkaller.appspot.com/x/repro.c?x=1752fe0a600000\n\
  \nReported-by: syzbot+dff25ee91f0c7d5c1695@syzkaller.appspotmail.com\nCc: Paolo\
  \ Bonzini <pbonzini@redhat.com>\nCc: Radim Krčmář <rkrcmar@redhat.com>\nSigned-off-by:\
  \ Wanpeng Li <wanpengli@tencent.com>\nReviewed-by: Vitaly Kuznetsov <vkuznets@redhat.com>\n\
  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>\n"
submodule:
- arch/x86/kvm
hunk_count: 2
covered_count: 1
