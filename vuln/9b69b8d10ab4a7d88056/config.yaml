id: 9b69b8d10ab4a7d88056
bug_link: https://syzkaller.appspot.com/bug?extid=9b69b8d10ab4a7d88056
title: 'BUG: corrupted list in p9_fd_cancel (2)'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: f0c4d9fc9cc9462659728d168387191387e903cc
fix_commit: 11c10956515b8ec44cf4f2a7b9d8bf8b9dc05ec4
datetime: '2022-11-18T22:28:32+09:00'
fix_commit_message: "9p/fd: fix issue of list_del corruption in p9_fd_cancel()\n\n\
  Syz reported the following issue:\nkernel BUG at lib/list_debug.c:53!\ninvalid opcode:\
  \ 0000 [#1] PREEMPT SMP KASAN\nRIP: 0010:__list_del_entry_valid.cold+0x5c/0x72\n\
  Call Trace:\n<TASK>\np9_fd_cancel+0xb1/0x270\np9_client_rpc+0x8ea/0xba0\np9_client_create+0x9c0/0xed0\n\
  v9fs_session_init+0x1e0/0x1620\nv9fs_mount+0xba/0xb80\nlegacy_get_tree+0x103/0x200\n\
  vfs_get_tree+0x89/0x2d0\npath_mount+0x4c0/0x1ac0\n__x64_sys_mount+0x33b/0x430\n\
  do_syscall_64+0x35/0x80\nentry_SYSCALL_64_after_hwframe+0x46/0xb0\n</TASK>\n\nThe\
  \ process is as follows:\nThread A:                       Thread B:\np9_poll_workfn()\
  \                p9_client_create()\n...                                 ...\n \
  \   p9_conn_cancel()                p9_fd_cancel()\n        list_del()         \
  \             ...\n        ...                             list_del()  //list_del\n\
  \                                                      corruption\nThere is no lock\
  \ protection when deleting list in p9_conn_cancel(). After\ndeleting list in Thread\
  \ A, thread B will delete the same list again. It\nwill cause issue of list_del\
  \ corruption.\n\nSetting req->status to REQ_STATUS_ERROR under lock prevents other\n\
  cleanup paths from trying to manipulate req_list.\nThe other thread can safely check\
  \ req->status because it still holds a\nreference to req at this point.\n\nLink:\
  \ https://lkml.kernel.org/r/20221110122606.383352-1-shaozhengchao@huawei.com\nFixes:\
  \ 52f1c45dde91 (\"9p: trans_fd/p9_conn_cancel: drop client lock earlier\")\nReported-by:\
  \ syzbot+9b69b8d10ab4a7d88056@syzkaller.appspotmail.com\nSigned-off-by: Zhengchao\
  \ Shao <shaozhengchao@huawei.com>\n[Dominique: add description of the fix in commit\
  \ message]\nSigned-off-by: Dominique Martinet <asmadeus@codewreck.org>\n"
submodule:
- net/9p
hunk_count: 1
covered_count: 0
