id: da54fa8d793ca89c741f
bug_link: https://syzkaller.appspot.com/bug?extid=da54fa8d793ca89c741f
title: WARNING in binder_alloc_vma_close
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: a43cfc87caaf46710c8027a8c23b8a55f1078f19
fix_commit: b0cab80ecd54ae3b2356bb081af0bffd538c8265
datetime: '2022-07-29T18:07:13-07:00'
fix_commit_message: 'android: binder: fix lockdep check on clearing vma


  When munmapping a vma, the mmap_lock can be degraded to a write before

  calling close() on the file handle.  The binder close() function calls

  binder_alloc_set_vma() to clear the vma address, which now has a lock dep

  check for writing on the mmap_lock.  Change the lockdep check to ensure

  the reading lock is held while clearing and keep the write check while

  writing.


  Link: https://lkml.kernel.org/r/20220627151857.2316964-1-Liam.Howlett@oracle.com

  Fixes: 472a68df605b ("android: binder: stop saving a pointer to the VMA")

  Signed-off-by: Liam R. Howlett <Liam.Howlett@oracle.com>

  Reported-by: syzbot+da54fa8d793ca89c741f@syzkaller.appspotmail.com

  Acked-by: Todd Kjos <tkjos@google.com>

  Cc: "Arve Hjønnevåg" <arve@android.com>

  Cc: Christian Brauner (Microsoft) <brauner@kernel.org>

  Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

  Cc: Hridya Valsaraju <hridya@google.com>

  Cc: Joel Fernandes <joel@joelfernandes.org>

  Cc: Martijn Coenen <maco@android.com>

  Cc: Suren Baghdasaryan <surenb@google.com>

  Signed-off-by: Andrew Morton <akpm@linux-foundation.org>

  '
submodule:
- drivers/android
hunk_count: 1
covered_count: 1
