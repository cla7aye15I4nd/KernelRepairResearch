id: 43475bf3cfbd6e41f5b7
bug_link: https://syzkaller.appspot.com/bug?extid=43475bf3cfbd6e41f5b7
title: WARNING in nci_send_cmd
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 24deec6b9e4a051635f75777844ffc184644fec9
fix_commit: 0ad6bded175e829c2ca261529c9dce39a32a042d
datetime: '2022-11-18T12:37:11+00:00'
fix_commit_message: 'nfc/nci: fix race with opening and closing


  Previously we leverage NCI_UNREG and the lock inside nci_close_device to

  prevent the race condition between opening a device and closing a

  device. However, it still has problem because a failed opening command

  will erase the NCI_UNREG flag and allow another opening command to

  bypass the status checking.


  This fix corrects that by making sure the NCI_UNREG is held.


  Reported-by: syzbot+43475bf3cfbd6e41f5b7@syzkaller.appspotmail.com

  Fixes: 48b71a9e66c2 ("NFC: add NCI_UNREG flag to eliminate the race")

  Signed-off-by: Lin Ma <linma@zju.edu.cn>

  Signed-off-by: David S. Miller <davem@davemloft.net>

  '
submodule:
- net/nfc
hunk_count: 1
covered_count: 1
