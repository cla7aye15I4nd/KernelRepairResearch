id: e9cc557752ab126c1b99
bug_link: https://syzkaller.appspot.com/bug?extid=e9cc557752ab126c1b99
title: 'KASAN: use-after-free Read in tipc_named_reinit'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: ef73476376444c7f891045ac5b1be3602355098c
fix_commit: fdeba99b1e58ecd18c2940c453e19e4ef20ff591
datetime: '2020-08-27T06:59:42-07:00'
fix_commit_message: "tipc: fix use-after-free in tipc_bcast_get_mode\n\nSyzbot has\
  \ reported those issues as:\n\n==================================================================\n\
  BUG: KASAN: use-after-free in tipc_bcast_get_mode+0x3ab/0x400 net/tipc/bcast.c:759\n\
  Read of size 1 at addr ffff88805e6b3571 by task kworker/0:6/3850\n\nCPU: 0 PID:\
  \ 3850 Comm: kworker/0:6 Not tainted 5.8.0-rc7-syzkaller #0\nHardware name: Google\
  \ Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011\nWorkqueue:\
  \ events tipc_net_finalize_work\n\nThread 1's call trace:\n[...]\n  kfree+0x103/0x2c0\
  \ mm/slab.c:3757 <- bcbase releasing\n  tipc_bcast_stop+0x1b0/0x2f0 net/tipc/bcast.c:721\n\
  \  tipc_exit_net+0x24/0x270 net/tipc/core.c:112\n[...]\n\nThread 2's call trace:\n\
  [...]\n  tipc_bcast_get_mode+0x3ab/0x400 net/tipc/bcast.c:759 <- bcbase\nhas already\
  \ been freed by Thread 1\n\n  tipc_node_broadcast+0x9e/0xcc0 net/tipc/node.c:1744\n\
  \  tipc_nametbl_publish+0x60b/0x970 net/tipc/name_table.c:752\n  tipc_net_finalize\
  \ net/tipc/net.c:141 [inline]\n  tipc_net_finalize+0x1fa/0x310 net/tipc/net.c:131\n\
  \  tipc_net_finalize_work+0x55/0x80 net/tipc/net.c:150\n[...]\n\n==================================================================\n\
  BUG: KASAN: use-after-free in tipc_named_reinit+0xef/0x290 net/tipc/name_distr.c:344\n\
  Read of size 8 at addr ffff888052ab2000 by task kworker/0:13/30628\nCPU: 0 PID:\
  \ 30628 Comm: kworker/0:13 Not tainted 5.8.0-syzkaller #0\nHardware name: Google\
  \ Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011\nWorkqueue:\
  \ events tipc_net_finalize_work\nCall Trace:\n __dump_stack lib/dump_stack.c:77\
  \ [inline]\n dump_stack+0x1f0/0x31e lib/dump_stack.c:118\n print_address_description+0x66/0x5a0\
  \ mm/kasan/report.c:383\n __kasan_report mm/kasan/report.c:513 [inline]\n kasan_report+0x132/0x1d0\
  \ mm/kasan/report.c:530\n tipc_named_reinit+0xef/0x290 net/tipc/name_distr.c:344\n\
  \ tipc_net_finalize+0x85/0xe0 net/tipc/net.c:138\n tipc_net_finalize_work+0x50/0x70\
  \ net/tipc/net.c:150\n process_one_work+0x789/0xfc0 kernel/workqueue.c:2269\n worker_thread+0xaa4/0x1460\
  \ kernel/workqueue.c:2415\n kthread+0x37e/0x3a0 drivers/block/aoe/aoecmd.c:1234\n\
  \ ret_from_fork+0x1f/0x30 arch/x86/entry/entry_64.S:293\n[...]\nFreed by task 14058:\n\
  \ save_stack mm/kasan/common.c:48 [inline]\n set_track mm/kasan/common.c:56 [inline]\n\
  \ kasan_set_free_info mm/kasan/common.c:316 [inline]\n __kasan_slab_free+0x114/0x170\
  \ mm/kasan/common.c:455\n __cache_free mm/slab.c:3426 [inline]\n kfree+0x10a/0x220\
  \ mm/slab.c:3757\n tipc_exit_net+0x29/0x50 net/tipc/core.c:113\n ops_exit_list net/core/net_namespace.c:186\
  \ [inline]\n cleanup_net+0x708/0xba0 net/core/net_namespace.c:603\n process_one_work+0x789/0xfc0\
  \ kernel/workqueue.c:2269\n worker_thread+0xaa4/0x1460 kernel/workqueue.c:2415\n\
  \ kthread+0x37e/0x3a0 drivers/block/aoe/aoecmd.c:1234\n ret_from_fork+0x1f/0x30\
  \ arch/x86/entry/entry_64.S:293\n\nFix it by calling flush_scheduled_work() to make\
  \ sure the\ntipc_net_finalize_work() stopped before releasing bcbase object.\n\n\
  Reported-by: syzbot+6ea1f7a8df64596ef4d7@syzkaller.appspotmail.com\nReported-by:\
  \ syzbot+e9cc557752ab126c1b99@syzkaller.appspotmail.com\nAcked-by: Jon Maloy <jmaloy@redhat.com>\n\
  Signed-off-by: Hoang Huu Le <hoang.h.le@dektech.com.au>\nSigned-off-by: David S.\
  \ Miller <davem@davemloft.net>\n"
submodule:
- net/tipc
hunk_count: 1
covered_count: 1
