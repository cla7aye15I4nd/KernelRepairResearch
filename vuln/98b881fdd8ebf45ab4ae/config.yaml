id: 98b881fdd8ebf45ab4ae
bug_link: https://syzkaller.appspot.com/bug?extid=98b881fdd8ebf45ab4ae
title: WARNING in ext4_xattr_set_entry
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 5dccdc5a1916d4266edd251f20bbbb113a5c495f
fix_commit: 6b22489911b726eebbf169caee52fea52013fbdd
datetime: '2021-03-21T00:09:17-04:00'
fix_commit_message: "ext4: do not try to set xattr into ea_inode if value is empty\n\
  \nSyzbot report a warning that ext4 may create an empty ea_inode if set\nan empty\
  \ extent attribute to a file on the file system which is no free\nblocks left.\n\
  \n  WARNING: CPU: 6 PID: 10667 at fs/ext4/xattr.c:1640 ext4_xattr_set_entry+0x10f8/0x1114\
  \ fs/ext4/xattr.c:1640\n  ...\n  Call trace:\n   ext4_xattr_set_entry+0x10f8/0x1114\
  \ fs/ext4/xattr.c:1640\n   ext4_xattr_block_set+0x1d0/0x1b1c fs/ext4/xattr.c:1942\n\
  \   ext4_xattr_set_handle+0x8a0/0xf1c fs/ext4/xattr.c:2390\n   ext4_xattr_set+0x120/0x1f0\
  \ fs/ext4/xattr.c:2491\n   ext4_xattr_trusted_set+0x48/0x5c fs/ext4/xattr_trusted.c:37\n\
  \   __vfs_setxattr+0x208/0x23c fs/xattr.c:177\n  ...\n\nNow, ext4 try to store extent\
  \ attribute into an external inode if\next4_xattr_block_set() return -ENOSPC, but\
  \ for the case of store an\nempty extent attribute, store the extent entry into\
  \ the extent\nattribute block is enough. A simple reproduce below.\n\n  fallocate\
  \ test.img -l 1M\n  mkfs.ext4 -F -b 2048 -O ea_inode test.img\n  mount test.img\
  \ /mnt\n  dd if=/dev/zero of=/mnt/foo bs=2048 count=500\n  setfattr -n \"user.test\"\
  \ /mnt/foo\n\nReported-by: syzbot+98b881fdd8ebf45ab4ae@syzkaller.appspotmail.com\n\
  Fixes: 9c6e7853c531 (\"ext4: reserve space for xattr entries/names\")\nCc: stable@kernel.org\n\
  Signed-off-by: zhangyi (F) <yi.zhang@huawei.com>\nLink: https://lore.kernel.org/r/20210305120508.298465-1-yi.zhang@huawei.com\n\
  Signed-off-by: Theodore Ts'o <tytso@mit.edu>\n"
submodule:
- fs/ext4
hunk_count: 1
covered_count: 1
