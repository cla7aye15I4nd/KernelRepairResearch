id: 9df43faf09bd400f2993
bug_link: https://syzkaller.appspot.com/bug?extid=9df43faf09bd400f2993
title: 'KASAN: use-after-free Read in pppol2tp_connect'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: d02ba2a6110c530a32926af8ad441111774d2893
fix_commit: 28f5bfb819195ad9c2eb9486babe7b0e4efe925f
datetime: '2018-02-26T12:20:37-05:00'
fix_commit_message: "l2tp: fix tunnel lookup use-after-free race\n\nl2tp_tunnel_get\
  \ walks the tunnel list to find a matching tunnel\ninstance and if a match is found,\
  \ its refcount is increased before\nreturning the tunnel pointer. But when tunnel\
  \ objects are destroyed,\nthey are on the tunnel list after their refcount hits\
  \ zero. Fix this\nby moving the code that removes the tunnel from the tunnel list\
  \ from\nthe tunnel socket destructor into in the l2tp_tunnel_delete path,\nbefore\
  \ the tunnel refcount is decremented.\n\nrefcount_t: increment on 0; use-after-free.\n\
  WARNING: CPU: 3 PID: 13507 at lib/refcount.c:153 refcount_inc+0x47/0x50\nModules\
  \ linked in:\nCPU: 3 PID: 13507 Comm: syzbot_6e6a5ec8 Not tainted 4.16.0-rc2+ #36\n\
  Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS VirtualBox 12/01/2006\n\
  RIP: 0010:refcount_inc+0x47/0x50\nRSP: 0018:ffff8800136ffb20 EFLAGS: 00010286\n\
  RAX: dffffc0000000008 RBX: ffff880017068e68 RCX: ffffffff814d3333\nRDX: 0000000000000000\
  \ RSI: ffff88001a59f6d8 RDI: ffff88001a59f6d8\nRBP: ffff8800136ffb28 R08: 0000000000000000\
  \ R09: 0000000000000000\nR10: ffff8800136ffab0 R11: 0000000000000000 R12: ffff880017068e50\n\
  R13: 0000000000000000 R14: ffff8800174da800 R15: 0000000000000004\nFS:  00007f403ab1e700(0000)\
  \ GS:ffff88001a580000(0000) knlGS:0000000000000000\nCS:  0010 DS: 0000 ES: 0000\
  \ CR0: 0000000080050033\nCR2: 00000000205fafd2 CR3: 0000000016770000 CR4: 00000000000006e0\n\
  Call Trace:\n l2tp_tunnel_get+0x2dd/0x4e0\n pppol2tp_connect+0x428/0x13c0\n ? pppol2tp_session_create+0x170/0x170\n\
  \ ? __might_fault+0x115/0x1d0\n ? lock_downgrade+0x860/0x860\n ? __might_fault+0xe5/0x1d0\n\
  \ ? security_socket_connect+0x8e/0xc0\n SYSC_connect+0x1b6/0x310\n ? SYSC_bind+0x280/0x280\n\
  \ ? __do_page_fault+0x5d1/0xca0\n ? up_read+0x1f/0x40\n ? __do_page_fault+0x3c8/0xca0\n\
  \ SyS_connect+0x29/0x30\n ? SyS_accept+0x40/0x40\n do_syscall_64+0x1e0/0x730\n ?\
  \ trace_hardirqs_off_thunk+0x1a/0x1c\n entry_SYSCALL_64_after_hwframe+0x42/0xb7\n\
  RIP: 0033:0x7f403a42f259\nRSP: 002b:00007f403ab1dee8 EFLAGS: 00000296 ORIG_RAX:\
  \ 000000000000002a\nRAX: ffffffffffffffda RBX: 00000000205fafe4 RCX: 00007f403a42f259\n\
  RDX: 000000000000002e RSI: 00000000205fafd2 RDI: 0000000000000004\nRBP: 00007f403ab1df20\
  \ R08: 00007f403ab1e700 R09: 0000000000000000\nR10: 00007f403ab1e700 R11: 0000000000000296\
  \ R12: 0000000000000000\nR13: 00007ffc81906cbf R14: 0000000000000000 R15: 00007f403ab2b040\n\
  Code: 3b ff 5b 5d c3 e8 ca 5f 3b ff 80 3d 49 8e 66 04 00 75 ea e8 bc 5f 3b ff 48\
  \ c7 c7 60 69 64 85 c6 05 34 8e 66 04 01 e8 59 49 15 ff <0f> 0b eb ce 0f 1f 44 00\
  \ 00 55 48 89 e5 41 56 41 55 41 54 53 49\n\nFixes: f8ccac0e44934 (\"l2tp: put tunnel\
  \ socket release on a workqueue\")\nReported-and-tested-by: syzbot+19c09769f14b48810113@syzkaller.appspotmail.com\n\
  Reported-and-tested-by: syzbot+347bd5acde002e353a36@syzkaller.appspotmail.com\n\
  Reported-and-tested-by: syzbot+6e6a5ec8de31a94cd015@syzkaller.appspotmail.com\n\
  Reported-and-tested-by: syzbot+9df43faf09bd400f2993@syzkaller.appspotmail.com\n\
  Signed-off-by: James Chapman <jchapman@katalix.com>\nSigned-off-by: David S. Miller\
  \ <davem@davemloft.net>\n"
submodule:
- net/l2tp
hunk_count: 4
covered_count: 0
