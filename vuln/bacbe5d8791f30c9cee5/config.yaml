id: bacbe5d8791f30c9cee5
bug_link: https://syzkaller.appspot.com/bug?extid=bacbe5d8791f30c9cee5
title: possible deadlock in get_user_pages_unlocked
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 1b4cfe3c0a30dde968fb43c577a8d7e262a145ee
fix_commit: 96312e61282ae3f6537a562625706498cbc75594
datetime: '2018-03-09T16:40:01-08:00'
fix_commit_message: 'mm/gup.c: teach get_user_pages_unlocked to handle FOLL_NOWAIT


  KVM is hanging during postcopy live migration with userfaultfd because

  get_user_pages_unlocked is not capable to handle FOLL_NOWAIT.


  Earlier FOLL_NOWAIT was only ever passed to get_user_pages.


  Specifically faultin_page (the callee of get_user_pages_unlocked caller)

  doesn''t know that if FAULT_FLAG_RETRY_NOWAIT was set in the page fault

  flags, when VM_FAULT_RETRY is returned, the mmap_sem wasn''t actually

  released (even if nonblocking is not NULL).  So it sets *nonblocking to

  zero and the caller won''t release the mmap_sem thinking it was already

  released, but it wasn''t because of FOLL_NOWAIT.


  Link: http://lkml.kernel.org/r/20180302174343.5421-2-aarcange@redhat.com

  Fixes: ce53053ce378c ("kvm: switch get_user_page_nowait() to get_user_pages_unlocked()")

  Signed-off-by: Andrea Arcangeli <aarcange@redhat.com>

  Reported-by: Dr. David Alan Gilbert <dgilbert@redhat.com>

  Tested-by: Dr. David Alan Gilbert <dgilbert@redhat.com>

  Cc: Al Viro <viro@zeniv.linux.org.uk>

  Signed-off-by: Andrew Morton <akpm@linux-foundation.org>

  Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

  '
submodule:
- mm
hunk_count: 2
covered_count: 2
