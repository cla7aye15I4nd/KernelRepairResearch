id: 7d6a57304857423318a5
bug_link: https://syzkaller.appspot.com/bug?extid=7d6a57304857423318a5
title: general protection fault in make_kuid
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: d1abaeb3be7b5fa6d7a1fbbd2e14e3310005c4c1
fix_commit: 1dd9bc08cf1420d466dd8dcfcc233777e61ca5d2
datetime: '2019-09-05T14:33:45-04:00'
fix_commit_message: "vfs: set fs_context::user_ns for reconfigure\n\nfs_context::user_ns\
  \ is used by fuse_parse_param(), even during remount,\nso it needs to be set to\
  \ the existing value for reconfigure.\n\nReproducer:\n\n\t#include <fcntl.h>\n\t\
  #include <sys/mount.h>\n\n\tint main()\n\t{\n\t\tchar opts[128];\n\t\tint fd = open(\"\
  /dev/fuse\", O_RDWR);\n\n\t\tsprintf(opts, \"fd=%d,rootmode=040000,user_id=0,group_id=0\"\
  , fd);\n\t\tmkdir(\"mnt\", 0777);\n\t\tmount(\"foo\",  \"mnt\", \"fuse.foo\", 0,\
  \ opts);\n\t\tmount(\"foo\", \"mnt\", \"fuse.foo\", MS_REMOUNT, opts);\n\t}\n\n\
  Crash:\n\tBUG: kernel NULL pointer dereference, address: 0000000000000000\n\t#PF:\
  \ supervisor read access in kernel mode\n\t#PF: error_code(0x0000) - not-present\
  \ page\n\tPGD 0 P4D 0\n\tOops: 0000 [#1] SMP\n\tCPU: 0 PID: 129 Comm: syz_make_kuid\
  \ Not tainted 5.3.0-rc5-next-20190821 #3\n\tHardware name: QEMU Standard PC (i440FX\
  \ + PIIX, 1996), BIOS 1.12.0-20181126_142135-anatol 04/01/2014\n\tRIP: 0010:map_id_range_down+0xb/0xc0\
  \ kernel/user_namespace.c:291\n\t[...]\n\tCall Trace:\n\t map_id_down kernel/user_namespace.c:312\
  \ [inline]\n\t make_kuid+0xe/0x10 kernel/user_namespace.c:389\n\t fuse_parse_param+0x116/0x210\
  \ fs/fuse/inode.c:523\n\t vfs_parse_fs_param+0xdb/0x1b0 fs/fs_context.c:145\n\t\
  \ vfs_parse_fs_string+0x6a/0xa0 fs/fs_context.c:188\n\t generic_parse_monolithic+0x85/0xc0\
  \ fs/fs_context.c:228\n\t parse_monolithic_mount_data+0x1b/0x20 fs/fs_context.c:708\n\
  \t do_remount fs/namespace.c:2525 [inline]\n\t do_mount+0x39a/0xa60 fs/namespace.c:3107\n\
  \t ksys_mount+0x7d/0xd0 fs/namespace.c:3325\n\t __do_sys_mount fs/namespace.c:3339\
  \ [inline]\n\t __se_sys_mount fs/namespace.c:3336 [inline]\n\t __x64_sys_mount+0x20/0x30\
  \ fs/namespace.c:3336\n\t do_syscall_64+0x4a/0x1a0 arch/x86/entry/common.c:290\n\
  \t entry_SYSCALL_64_after_hwframe+0x49/0xbe\n\nReported-by: syzbot+7d6a57304857423318a5@syzkaller.appspotmail.com\n\
  Fixes: 408cbe695350 (\"vfs: Convert fuse to use the new mount API\")\nCc: David\
  \ Howells <dhowells@redhat.com>\nCc: Miklos Szeredi <miklos@szeredi.hu>\nSigned-off-by:\
  \ Eric Biggers <ebiggers@google.com>\nReviewed-by: David Howells <dhowells@redhat.com>\n\
  Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>\n"
submodule:
- fs
hunk_count: 1
covered_count: 0
