id: 7f1c020f68dab95aab59
bug_link: https://syzkaller.appspot.com/bug?extid=7f1c020f68dab95aab59
title: WARNING in hsr_dev_finalize
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 6dbb89014dc303facc54d33ae64419d2f9c8ff32
fix_commit: ccfc9df1352be5b2f391091e18c4b2395d30ce78
datetime: '2020-07-04T18:02:48-07:00'
fix_commit_message: "hsr: fix interface leak in error path of hsr_dev_finalize()\n\
  \nTo release hsr(upper) interface, it should release\nits own lower interfaces first.\n\
  Then, hsr(upper) interface can be released safely.\nIn the current code of error\
  \ path of hsr_dev_finalize(), it releases hsr\ninterface before releasing a lower\
  \ interface.\nSo, a warning occurs, which warns about the leak of lower interfaces.\n\
  In order to fix this problem, changing the ordering of the error path of\nhsr_dev_finalize()\
  \ is needed.\n\nTest commands:\n    ip link add dummy0 type dummy\n    ip link add\
  \ dummy1 type dummy\n    ip link add dummy2 type dummy\n    ip link add hsr0 type\
  \ hsr slave1 dummy0 slave2 dummy1\n    ip link add hsr1 type hsr slave1 dummy2 slave2\
  \ dummy0\n\nSplat looks like:\n[  214.923127][    C2] WARNING: CPU: 2 PID: 1093\
  \ at net/core/dev.c:8992 rollback_registered_many+0x986/0xcf0\n[  214.923129][ \
  \   C2] Modules linked in: hsr dummy openvswitch nsh nf_conncount nf_nat nf_conntrack\
  \ nf_defrag_ipx\n[  214.923154][    C2] CPU: 2 PID: 1093 Comm: ip Not tainted 5.8.0-rc2+\
  \ #623\n[  214.923156][    C2] Hardware name: innotek GmbH VirtualBox/VirtualBox,\
  \ BIOS VirtualBox 12/01/2006\n[  214.923157][    C2] RIP: 0010:rollback_registered_many+0x986/0xcf0\n\
  [  214.923160][    C2] Code: 41 8b 4e cc 45 31 c0 31 d2 4c 89 ee 48 89 df e8 e0\
  \ 47 ff ff 85 c0 0f 84 cd fc ff ff 5\n[  214.923162][    C2] RSP: 0018:ffff8880c5156f28\
  \ EFLAGS: 00010287\n[  214.923165][    C2] RAX: ffff8880d1dad458 RBX: ffff8880bd1b9000\
  \ RCX: ffffffffb929d243\n[  214.923167][    C2] RDX: 1ffffffff77e63f0 RSI: 0000000000000008\
  \ RDI: ffffffffbbf31f80\n[  214.923168][    C2] RBP: dffffc0000000000 R08: fffffbfff77e63f1\
  \ R09: fffffbfff77e63f1\n[  214.923170][    C2] R10: ffffffffbbf31f87 R11: 0000000000000001\
  \ R12: ffff8880c51570a0\n[  214.923172][    C2] R13: ffff8880bd1b90b8 R14: ffff8880c5157048\
  \ R15: ffff8880d1dacc40\n[  214.923174][    C2] FS:  00007fdd257a20c0(0000) GS:ffff8880da200000(0000)\
  \ knlGS:0000000000000000\n[  214.923175][    C2] CS:  0010 DS: 0000 ES: 0000 CR0:\
  \ 0000000080050033\n[  214.923177][    C2] CR2: 00007ffd78beb038 CR3: 00000000be544005\
  \ CR4: 00000000000606e0\n[  214.923179][    C2] Call Trace:\n[  214.923180][   \
  \ C2]  ? netif_set_real_num_tx_queues+0x780/0x780\n[  214.923182][    C2]  ? dev_validate_mtu+0x140/0x140\n\
  [  214.923183][    C2]  ? synchronize_rcu.part.79+0x85/0xd0\n[  214.923185][   \
  \ C2]  ? synchronize_rcu_expedited+0xbb0/0xbb0\n[  214.923187][    C2]  rollback_registered+0xc8/0x170\n\
  [  214.923188][    C2]  ? rollback_registered_many+0xcf0/0xcf0\n[  214.923190][\
  \    C2]  unregister_netdevice_queue+0x18b/0x240\n[  214.923191][    C2]  hsr_dev_finalize+0x56e/0x6e0\
  \ [hsr]\n[  214.923192][    C2]  hsr_newlink+0x36b/0x450 [hsr]\n[  214.923194][\
  \    C2]  ? hsr_dellink+0x70/0x70 [hsr]\n[  214.923195][    C2]  ? rtnl_create_link+0x2e4/0xb00\n\
  [  214.923197][    C2]  ? __netlink_ns_capable+0xc3/0xf0\n[  214.923198][    C2]\
  \  __rtnl_newlink+0xbdb/0x1270\n[ ... ]\n\nFixes: e0a4b99773d3 (\"hsr: use upper/lower\
  \ device infrastructure\")\nReported-by: syzbot+7f1c020f68dab95aab59@syzkaller.appspotmail.com\n\
  Signed-off-by: Taehee Yoo <ap420073@gmail.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>\n"
submodule:
- net/hsr
hunk_count: 2
covered_count: 1
