id: f3a31fb909db9b2a5c4d
bug_link: https://syzkaller.appspot.com/bug?extid=f3a31fb909db9b2a5c4d
title: 'KASAN: slab-use-after-free Read in __timer_delete_sync'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 077ee7e6b13a2b6668196ed01a22023549e19381
fix_commit: b4cd80b0338945a94972ac3ed54f8338d2da2076
datetime: '2024-09-11T16:00:11-07:00'
fix_commit_message: "mptcp: pm: Fix uaf in __timer_delete_sync\n\nThere are two paths\
  \ to access mptcp_pm_del_add_timer, result in a race\ncondition:\n\n     CPU1\t\t\
  \t\tCPU2\n     ====                               ====\n     net_rx_action\n   \
  \  napi_poll                          netlink_sendmsg\n     __napi_poll        \
  \                netlink_unicast\n     process_backlog                    netlink_unicast_kernel\n\
  \     __netif_receive_skb                genl_rcv\n     __netif_receive_skb_one_core\
  \       netlink_rcv_skb\n     NF_HOOK                            genl_rcv_msg\n\
  \     ip_local_deliver_finish            genl_family_rcv_msg\n     ip_protocol_deliver_rcu\
  \            genl_family_rcv_msg_doit\n     tcp_v4_rcv                         mptcp_pm_nl_flush_addrs_doit\n\
  \     tcp_v4_do_rcv                      mptcp_nl_remove_addrs_list\n     tcp_rcv_established\
  \                mptcp_pm_remove_addrs_and_subflows\n     tcp_data_queue       \
  \              remove_anno_list_by_saddr\n     mptcp_incoming_options          \
  \   mptcp_pm_del_add_timer\n     mptcp_pm_del_add_timer             kfree(entry)\n\
  \nIn remove_anno_list_by_saddr(running on CPU2), after leaving the critical\nzone\
  \ protected by \"pm.lock\", the entry will be released, which leads to the\noccurrence\
  \ of uaf in the mptcp_pm_del_add_timer(running on CPU1).\n\nKeeping a reference\
  \ to add_timer inside the lock, and calling\nsk_stop_timer_sync() with this reference,\
  \ instead of \"entry->add_timer\".\n\nMove list_del(&entry->list) to mptcp_pm_del_add_timer\
  \ and inside the pm lock,\ndo not directly access any members of the entry outside\
  \ the pm lock, which\ncan avoid similar \"entry->x\" uaf.\n\nFixes: 00cfd77b9063\
  \ (\"mptcp: retransmit ADD_ADDR when timeout\")\nCc: stable@vger.kernel.org\nReported-and-tested-by:\
  \ syzbot+f3a31fb909db9b2a5c4d@syzkaller.appspotmail.com\nCloses: https://syzkaller.appspot.com/bug?extid=f3a31fb909db9b2a5c4d\n\
  Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>\nSigned-off-by: Edward\
  \ Adam Davis <eadavis@qq.com>\nAcked-by: Paolo Abeni <pabeni@redhat.com>\nLink:\
  \ https://patch.msgid.link/tencent_7142963A37944B4A74EF76CD66EA3C253609@qq.com\n\
  Signed-off-by: Jakub Kicinski <kuba@kernel.org>\n"
submodule:
- net/mptcp
hunk_count: 2
covered_count: 2
