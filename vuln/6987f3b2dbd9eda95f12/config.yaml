id: 6987f3b2dbd9eda95f12
bug_link: https://syzkaller.appspot.com/bug?extid=6987f3b2dbd9eda95f12
title: general protection fault in kvm_hv_irq_routing_update
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: ffe76c24c5c1851e5ef949d8726d57e78cd0cf34
fix_commit: 919f4ebc598701670e80e31573a58f1f2d2bf918
datetime: '2021-02-26T03:16:50-05:00'
fix_commit_message: "KVM: x86: hyper-v: Fix Hyper-V context null-ptr-deref\n\nReported\
  \ by syzkaller:\n\n    KASAN: null-ptr-deref in range [0x0000000000000140-0x0000000000000147]\n\
  \    CPU: 1 PID: 8370 Comm: syz-executor859 Not tainted 5.11.0-syzkaller #0\n  \
  \  RIP: 0010:synic_get arch/x86/kvm/hyperv.c:165 [inline]\n    RIP: 0010:kvm_hv_set_sint_gsi\
  \ arch/x86/kvm/hyperv.c:475 [inline]\n    RIP: 0010:kvm_hv_irq_routing_update+0x230/0x460\
  \ arch/x86/kvm/hyperv.c:498\n    Call Trace:\n     kvm_set_irq_routing+0x69b/0x940\
  \ arch/x86/kvm/../../../virt/kvm/irqchip.c:223\n     kvm_vm_ioctl+0x12d0/0x2800\
  \ arch/x86/kvm/../../../virt/kvm/kvm_main.c:3959\n     vfs_ioctl fs/ioctl.c:48 [inline]\n\
  \     __do_sys_ioctl fs/ioctl.c:753 [inline]\n     __se_sys_ioctl fs/ioctl.c:739\
  \ [inline]\n     __x64_sys_ioctl+0x193/0x200 fs/ioctl.c:739\n     do_syscall_64+0x2d/0x70\
  \ arch/x86/entry/common.c:46\n     entry_SYSCALL_64_after_hwframe+0x44/0xae\n\n\
  Hyper-V context is lazily allocated until Hyper-V specific MSRs are accessed\nor\
  \ SynIC is enabled. However, the syzkaller testcase sets irq routing table\ndirectly\
  \ w/o enabling SynIC. This results in null-ptr-deref when accessing\nSynIC Hyper-V\
  \ context. This patch fixes it.\n\nsyzkaller source: https://syzkaller.appspot.com/x/repro.c?x=163342ccd00000\n\
  \nReported-by: syzbot+6987f3b2dbd9eda95f12@syzkaller.appspotmail.com\nFixes: 8f014550dfb1\
  \ (\"KVM: x86: hyper-v: Make Hyper-V emulation enablement conditional\")\nSigned-off-by:\
  \ Wanpeng Li <wanpengli@tencent.com>\nMessage-Id: <1614326399-5762-1-git-send-email-wanpengli@tencent.com>\n\
  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>\n"
submodule:
- arch/x86/kvm
hunk_count: 1
covered_count: 1
