id: c80e9ef5d8bb45894db0
bug_link: https://syzkaller.appspot.com/bug?extid=c80e9ef5d8bb45894db0
title: general protection fault in release_udmabuf
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: b3be4520d81e7dc820de5fdab0d7d697231cf517
fix_commit: d9c04a1b7a15b5e74b2977461d9511e497f05d8f
datetime: '2022-08-25T11:56:22+02:00'
fix_commit_message: "udmabuf: Set ubuf->sg = NULL if the creation of sg table fails\n\
  \nWhen userspace tries to map the dmabuf and if for some reason\n(e.g. OOM) the\
  \ creation of the sg table fails, ubuf->sg needs to be\nset to NULL. Otherwise,\
  \ when the userspace subsequently closes the\ndmabuf fd, we'd try to erroneously\
  \ free the invalid sg table from\nrelease_udmabuf resulting in the following crash\
  \ reported by syzbot:\n\ngeneral protection fault, probably for non-canonical address\n\
  0xdffffc0000000000: 0000 [#1] PREEMPT SMP KASAN\nKASAN: null-ptr-deref in range\
  \ [0x0000000000000000-0x0000000000000007]\nCPU: 0 PID: 3609 Comm: syz-executor487\
  \ Not tainted\n5.19.0-syzkaller-13930-g7ebfc85e2cd7 #0\nHardware name: Google Google\
  \ Compute Engine/Google Compute Engine, BIOS\nGoogle 07/22/2022\nRIP: 0010:dma_unmap_sgtable\
  \ include/linux/dma-mapping.h:378 [inline]\nRIP: 0010:put_sg_table drivers/dma-buf/udmabuf.c:89\
  \ [inline]\nRIP: 0010:release_udmabuf+0xcb/0x4f0 drivers/dma-buf/udmabuf.c:114\n\
  Code: 48 89 fa 48 c1 ea 03 80 3c 02 00 0f 85 2b 04 00 00 48 8d 7d 0c 4c\n8b 63 30\
  \ 48 b8 00 00 00 00 00 fc ff df 48 89 fa 48 c1 ea 03 <0f> b6 14\n02 48 89 f8 83\
  \ e0 07 83 c0 03 38 d0 7c 08 84 d2 0f 85 e2\nRSP: 0018:ffffc900037efd30 EFLAGS:\
  \ 00010246\nRAX: dffffc0000000000 RBX: ffffffff8cb67800 RCX: 0000000000000000\n\
  RDX: 0000000000000000 RSI: ffffffff84ad27e0 RDI: 0000000000000000\nRBP: fffffffffffffff4\
  \ R08: 0000000000000005 R09: 0000000000000000\nR10: 0000000000000000 R11: 000000000008c07c\
  \ R12: ffff88801fa05000\nR13: ffff888073db07e8 R14: ffff888025c25440 R15: 0000000000000000\n\
  FS:  0000555555fc4300(0000) GS:ffff8880b9a00000(0000)\nknlGS:0000000000000000\n\
  CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\nCR2: 00007fc1c0ce06e4 CR3: 00000000715e6000\
  \ CR4: 00000000003506f0\nDR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000\n\
  DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400\nCall Trace:\n\
  \ <TASK>\n dma_buf_release+0x157/0x2d0 drivers/dma-buf/dma-buf.c:78\n __dentry_kill+0x42b/0x640\
  \ fs/dcache.c:612\n dentry_kill fs/dcache.c:733 [inline]\n dput+0x806/0xdb0 fs/dcache.c:913\n\
  \ __fput+0x39c/0x9d0 fs/file_table.c:333\n task_work_run+0xdd/0x1a0 kernel/task_work.c:177\n\
  \ ptrace_notify+0x114/0x140 kernel/signal.c:2353\n ptrace_report_syscall include/linux/ptrace.h:420\
  \ [inline]\n ptrace_report_syscall_exit include/linux/ptrace.h:482 [inline]\n syscall_exit_work\
  \ kernel/entry/common.c:249 [inline]\n syscall_exit_to_user_mode_prepare+0x129/0x280\
  \ kernel/entry/common.c:276\n __syscall_exit_to_user_mode_work kernel/entry/common.c:281\
  \ [inline]\n syscall_exit_to_user_mode+0x9/0x50 kernel/entry/common.c:294\n do_syscall_64+0x42/0xb0\
  \ arch/x86/entry/common.c:86\n entry_SYSCALL_64_after_hwframe+0x63/0xcd\nRIP: 0033:0x7fc1c0c35b6b\n\
  Code: 0f 05 48 3d 00 f0 ff ff 77 45 c3 0f 1f 40 00 48 83 ec 18 89 7c 24\n0c e8 63\
  \ fc ff ff 8b 7c 24 0c 41 89 c0 b8 03 00 00 00 0f 05 <48> 3d 00\nf0 ff ff 77 35\
  \ 44 89 c7 89 44 24 0c e8 a1 fc ff ff 8b 44\nRSP: 002b:00007ffd78a06090 EFLAGS:\
  \ 00000293 ORIG_RAX: 0000000000000003\nRAX: 0000000000000000 RBX: 0000000000000007\
  \ RCX: 00007fc1c0c35b6b\nRDX: 0000000020000280 RSI: 0000000040086200 RDI: 0000000000000006\n\
  RBP: 0000000000000007 R08: 0000000000000000 R09: 0000000000000000\nR10: 0000000000000000\
  \ R11: 0000000000000293 R12: 000000000000000c\nR13: 0000000000000003 R14: 00007fc1c0cfe4a0\
  \ R15: 00007ffd78a06140\n </TASK>\nModules linked in:\n---[ end trace 0000000000000000\
  \ ]---\nRIP: 0010:dma_unmap_sgtable include/linux/dma-mapping.h:378 [inline]\nRIP:\
  \ 0010:put_sg_table drivers/dma-buf/udmabuf.c:89 [inline]\nRIP: 0010:release_udmabuf+0xcb/0x4f0\
  \ drivers/dma-buf/udmabuf.c:114\n\nReported-by: syzbot+c80e9ef5d8bb45894db0@syzkaller.appspotmail.com\n\
  Cc: Gerd Hoffmann <kraxel@redhat.com>\nSigned-off-by: Vivek Kasireddy <vivek.kasireddy@intel.com>\n\
  Link: http://patchwork.freedesktop.org/patch/msgid/20220825063522.801264-1-vivek.kasireddy@intel.com\n\
  Signed-off-by: Gerd Hoffmann <kraxel@redhat.com>\n"
submodule:
- drivers/dma-buf
hunk_count: 1
covered_count: 1
