id: fba8e2116a12609b6c59
bug_link: https://syzkaller.appspot.com/bug?extid=fba8e2116a12609b6c59
title: 'KMSAN: uninit-value in btrfs_clean_tree_block (2)'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: db21370bffbc966253ba32edb112f4beec1531cc
fix_commit: cbddcc4fa3443fe8cfb2ff8e210deb1f6a0eea38
datetime: '2022-09-29T17:08:31+02:00'
fix_commit_message: 'btrfs: set generation before calling btrfs_clean_tree_block in
  btrfs_init_new_buffer


  syzbot is reporting uninit-value in btrfs_clean_tree_block() [1], for

  commit bc877d285ca3dba2 ("btrfs: Deduplicate extent_buffer init code")

  missed that btrfs_set_header_generation() in btrfs_init_new_buffer() must

  not be moved to after clean_tree_block() because clean_tree_block() is

  calling btrfs_header_generation() since commit 55c69072d6bd5be1 ("Btrfs:

  Fix extent_buffer usage when nodesize != leafsize").


  Since memzero_extent_buffer() will reset "struct btrfs_header" part, we

  can''t move btrfs_set_header_generation() to before memzero_extent_buffer().

  Just re-add btrfs_set_header_generation() before btrfs_clean_tree_block().


  Link: https://syzkaller.appspot.com/bug?extid=fba8e2116a12609b6c59 [1]

  Reported-by: syzbot <syzbot+fba8e2116a12609b6c59@syzkaller.appspotmail.com>

  Fixes: bc877d285ca3dba2 ("btrfs: Deduplicate extent_buffer init code")

  CC: stable@vger.kernel.org # 4.19+

  Signed-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp>

  Signed-off-by: David Sterba <dsterba@suse.com>

  '
submodule:
- fs/btrfs
hunk_count: 1
covered_count: 1
