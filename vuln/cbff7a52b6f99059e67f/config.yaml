id: cbff7a52b6f99059e67f
bug_link: https://syzkaller.appspot.com/bug?extid=cbff7a52b6f99059e67f
title: WARNING in nilfs_dat_commit_end
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: e89bd9e7d8eb63a183040eaf0c9640fdb34ec47a
fix_commit: 602ce7b8e1343b19c0cf93a3dd1926838ac5a1cc
datetime: '2023-02-02T22:50:10-08:00'
fix_commit_message: 'nilfs2: prevent WARNING in nilfs_dat_commit_end()


  If nilfs2 reads a corrupted disk image and its DAT metadata file contains

  invalid lifetime data for a virtual block number, a kernel warning can be

  generated by the WARN_ON check in nilfs_dat_commit_end() and can panic if

  the kernel is booted with panic_on_warn.


  This patch avoids the issue with a sanity check that treats it as an

  error.


  Since error return is not allowed in the execution phase of

  nilfs_dat_commit_end(), this inserts that sanity check in

  nilfs_dat_prepare_end(), which prepares for nilfs_dat_commit_end().


  As the error code, -EINVAL is returned to notify bmap layer of the

  metadata corruption.  When the bmap layer sees this code, it handles the

  abnormal situation and replaces the return code with -EIO as it should.


  Link: https://lkml.kernel.org/r/000000000000154d2c05e9ec7df6@google.com

  Link: https://lkml.kernel.org/r/20230127132202.6083-1-konishi.ryusuke@gmail.com

  Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>

  Reported-by: <syzbot+cbff7a52b6f99059e67f@syzkaller.appspotmail.com>

  Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>

  Signed-off-by: Andrew Morton <akpm@linux-foundation.org>

  '
submodule:
- fs/nilfs2
hunk_count: 3
covered_count: 3
