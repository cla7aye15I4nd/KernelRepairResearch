id: b191b5ccad8d7a986286
bug_link: https://syzkaller.appspot.com/bug?extid=b191b5ccad8d7a986286
title: 'BUG: sleeping function called from invalid context in team_change_rx_flags'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 32374234ab0101881e7d0c6a8ef7ebce566c46c9
fix_commit: d8d85ef0a631df9127f202e6371bb33a0b589952
datetime: '2025-05-27T11:36:26+02:00'
fix_commit_message: "af_packet: move notifier's packet_dev_mc out of rcu critical\
  \ section\n\nSyzkaller reports the following issue:\n\n BUG: sleeping function called\
  \ from invalid context at kernel/locking/mutex.c:578\n __mutex_lock+0x106/0xe80\
  \ kernel/locking/mutex.c:746\n team_change_rx_flags+0x38/0x220 drivers/net/team/team_core.c:1781\n\
  \ dev_change_rx_flags net/core/dev.c:9145 [inline]\n __dev_set_promiscuity+0x3f8/0x590\
  \ net/core/dev.c:9189\n netif_set_promiscuity+0x50/0xe0 net/core/dev.c:9201\n dev_set_promiscuity+0x126/0x260\
  \ net/core/dev_api.c:286 packet_dev_mc net/packet/af_packet.c:3698 [inline]\n packet_dev_mclist_delete\
  \ net/packet/af_packet.c:3722 [inline]\n packet_notifier+0x292/0xa60 net/packet/af_packet.c:4247\n\
  \ notifier_call_chain+0x1b3/0x3e0 kernel/notifier.c:85\n call_netdevice_notifiers_extack\
  \ net/core/dev.c:2214 [inline]\n call_netdevice_notifiers net/core/dev.c:2228 [inline]\n\
  \ unregister_netdevice_many_notify+0x15d8/0x2330 net/core/dev.c:11972\n rtnl_delete_link\
  \ net/core/rtnetlink.c:3522 [inline]\n rtnl_dellink+0x488/0x710 net/core/rtnetlink.c:3564\n\
  \ rtnetlink_rcv_msg+0x7cf/0xb70 net/core/rtnetlink.c:6955\n netlink_rcv_skb+0x219/0x490\
  \ net/netlink/af_netlink.c:2534\n\nCalling `PACKET_ADD_MEMBERSHIP` on an ops-locked\
  \ device can trigger\nthe `NETDEV_UNREGISTER` notifier, which may require disabling\
  \ promiscuous\nand/or allmulti mode. Both of these operations require acquiring\n\
  the netdev instance lock.\n\nMove the call to `packet_dev_mc` outside of the RCU\
  \ critical section.\nThe `mclist` modifications (add, del, flush, unregister) are\
  \ protected by\nthe RTNL, not the RCU. The RCU only protects the `sklist` and its\n\
  associated `sks`. The delayed operation on the `mclist` entry remains\nwithin the\
  \ RTNL.\n\nReported-by: syzbot+b191b5ccad8d7a986286@syzkaller.appspotmail.com\n\
  Closes: https://syzkaller.appspot.com/bug?extid=b191b5ccad8d7a986286\nFixes: ad7c7b2172c3\
  \ (\"net: hold netdev instance lock during sysfs operations\")\nSigned-off-by: Stanislav\
  \ Fomichev <stfomichev@gmail.com>\nReviewed-by: Willem de Bruijn <willemb@google.com>\n\
  Link: https://patch.msgid.link/20250522031129.3247266-1-stfomichev@gmail.com\nSigned-off-by:\
  \ Paolo Abeni <pabeni@redhat.com>\n\n"
submodule:
- net/packet
hunk_count: 6
covered_count: 5
