id: 243b7d89777f90f7613b
bug_link: https://syzkaller.appspot.com/bug?extid=243b7d89777f90f7613b
title: 'upstream test error: WARNING in __queue_work'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 2d2cb3066f2c90cd8ca540b36ba7a55e7f2406e0
fix_commit: deee93d13d385103205879a8a0915036ecd83261
datetime: '2022-09-19T10:24:24-07:00'
fix_commit_message: 'Bluetooth: use hdev->workqueue when queuing hdev->{cmd,ncmd}_timer
  works


  syzbot is reporting attempt to schedule hdev->cmd_work work from system_wq

  WQ into hdev->workqueue WQ which is under draining operation [1], for

  commit c8efcc2589464ac7 ("workqueue: allow chained queueing during

  destruction") does not allow such operation.


  The check introduced by commit 877afadad2dce8aa ("Bluetooth: When HCI work

  queue is drained, only queue chained work") was incomplete.


  Use hdev->workqueue WQ when queuing hdev->{cmd,ncmd}_timer works because

  hci_{cmd,ncmd}_timeout() calls queue_work(hdev->workqueue). Also, protect

  the queuing operation with RCU read lock in order to avoid calling

  queue_delayed_work() after cancel_delayed_work() completed.


  Link: https://syzkaller.appspot.com/bug?extid=243b7d89777f90f7613b [1]

  Reported-by: syzbot <syzbot+243b7d89777f90f7613b@syzkaller.appspotmail.com>

  Signed-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp>

  Fixes: 877afadad2dce8aa ("Bluetooth: When HCI work queue is drained, only queue
  chained work")

  Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>

  '
submodule:
- net/bluetooth
hunk_count: 3
covered_count: 0
