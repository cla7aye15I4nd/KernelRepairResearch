id: bf2c35fa302ebe3c7471
bug_link: https://syzkaller.appspot.com/bug?extid=bf2c35fa302ebe3c7471
title: WARNING in copy_huge_pmd
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 0665d7a39bdf92c8ac3dc390501f303907c87f62
fix_commit: 47fa30118f02dc50e1c57242c6b72542c871b178
datetime: '2024-10-09T12:47:19-07:00'
fix_commit_message: 'mm/huge_memory: check pmd_special() only after pmd_present()


  We should only check for pmd_special() after we made sure that we have a

  present PMD.  For example, if we have a migration PMD, pmd_special() might

  indicate that we have a special PMD although we really don''t.


  This fixes confusing migration entries as PFN mappings, and not doing what

  we are supposed to do in the "is_swap_pmd()" case further down in the

  function -- including messing up COW, page table handling and accounting.


  Link: https://lkml.kernel.org/r/20240926154234.2247217-1-david@redhat.com

  Fixes: bc02afbd4d73 ("mm/fork: accept huge pfnmap entries")

  Signed-off-by: David Hildenbrand <david@redhat.com>

  Reported-by: syzbot+bf2c35fa302ebe3c7471@syzkaller.appspotmail.com

  Closes: https://lore.kernel.org/lkml/66f15c8d.050a0220.c23dd.000f.GAE@google.com/

  Reviewed-by: Peter Xu <peterx@redhat.com>

  Signed-off-by: Andrew Morton <akpm@linux-foundation.org>

  '
submodule:
- mm
hunk_count: 1
covered_count: 1
