id: 74a15f02ccb51f398601
bug_link: https://syzkaller.appspot.com/bug?extid=74a15f02ccb51f398601
title: general protection fault in fuse_test_super
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: c191cd07ee948c93081d8e4cba43d23b18b2f3da
fix_commit: 80019f1138324b6f35ae728b4f25eeb08899b452
datetime: '2021-10-21T10:01:39+02:00'
fix_commit_message: 'fuse: always initialize sb->s_fs_info


  Syzkaller reports a null pointer dereference in fuse_test_super() that is

  caused by sb->s_fs_info being NULL.


  This is due to the fact that fuse_fill_super() is initializing s_fs_info,

  which is too late, it''s already on the fs_supers list.  The initialization

  needs to be done in sget_fc() with the sb_lock held.


  Move allocation of fuse_mount and fuse_conn from fuse_fill_super() into

  fuse_get_tree().


  After this ->kill_sb() will always be called with non-NULL ->s_fs_info,

  hence fuse_mount_destroy() can drop the test for non-NULL "fm".


  Reported-by: syzbot+74a15f02ccb51f398601@syzkaller.appspotmail.com

  Fixes: 5d5b74aa9c76 ("fuse: allow sharing existing sb")

  Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>

  '
submodule:
- fs/fuse
hunk_count: 5
covered_count: 3
