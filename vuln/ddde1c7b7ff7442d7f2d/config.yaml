id: ddde1c7b7ff7442d7f2d
bug_link: https://syzkaller.appspot.com/bug?extid=ddde1c7b7ff7442d7f2d
title: possible deadlock in rtnl_lock (4)
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: b3e456fce9f51d6276e576d00271e2813c1b8b67
fix_commit: 01ea306f2ac2baff98d472da719193e738759d93
datetime: '2018-02-14T20:44:42+01:00'
fix_commit_message: "netfilter: drop outermost socket lock in getsockopt()\n\nThe\
  \ Syzbot reported a possible deadlock in the netfilter area caused by\nrtnl lock,\
  \ xt lock and socket lock being acquired with a different order\non different code\
  \ paths, leading to the following backtrace:\nReviewed-by: Xin Long <lucien.xin@gmail.com>\n\
  \n======================================================\nWARNING: possible circular\
  \ locking dependency detected\n4.15.0+ #301 Not tainted\n------------------------------------------------------\n\
  syzkaller233489/4179 is trying to acquire lock:\n  (rtnl_mutex){+.+.}, at: [<0000000048e996fd>]\
  \ rtnl_lock+0x17/0x20\nnet/core/rtnetlink.c:74\n\nbut task is already holding lock:\n\
  \  (&xt[i].mutex){+.+.}, at: [<00000000328553a2>]\nxt_find_table_lock+0x3e/0x3e0\
  \ net/netfilter/x_tables.c:1041\n\nwhich lock already depends on the new lock.\n\
  ===\n\nSince commit 3f34cfae1230 (\"netfilter: on sockopt() acquire sock lock\n\
  only in the required scope\"), we already acquire the socket lock in\nthe innermost\
  \ scope, where needed. In such commit I forgot to remove\nthe outer-most socket\
  \ lock from the getsockopt() path, this commit\naddresses the issues dropping it\
  \ now.\n\nv1 -> v2: fix bad subj, added relavant 'fixes' tag\n\nFixes: 22265a5c3c10\
  \ (\"netfilter: xt_TEE: resolve oif using netdevice notifiers\")\nFixes: 202f59afd441\
  \ (\"netfilter: ipt_CLUSTERIP: do not hold dev\")\nFixes: 3f34cfae1230 (\"netfilter:\
  \ on sockopt() acquire sock lock only in the required scope\")\nReported-by: syzbot+ddde1c7b7ff7442d7f2d@syzkaller.appspotmail.com\n\
  Suggested-by: Florian Westphal <fw@strlen.de>\nSigned-off-by: Paolo Abeni <pabeni@redhat.com>\n\
  Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>\n"
submodule:
- net/ipv4
- net/ipv6
hunk_count: 4
covered_count: 2
