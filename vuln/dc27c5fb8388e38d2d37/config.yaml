id: dc27c5fb8388e38d2d37
bug_link: https://syzkaller.appspot.com/bug?extid=dc27c5fb8388e38d2d37
title: 'WARNING: kernel/bpf/verifier.c:LINE at do_check, CPU: syz.NUM.NUM/NUM'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 0f626c98fd10330da0420029a1c4fa35e39fb873
fix_commit: dadb59104c6441f54d0c42bba3e4bd11e25fc6d9
datetime: '2025-07-07T08:32:34-07:00'
fix_commit_message: 'bpf: Fix aux usage after do_check_insn()


  We must terminate the speculative analysis if the just-analyzed insn had

  nospec_result set. Using cur_aux() here is wrong because insn_idx might

  have been incremented by do_check_insn(). Therefore, introduce and use

  insn_aux variable.


  Also change cur_aux(env)->nospec in case do_check_insn() ever manages to

  increment insn_idx but still fail.


  Change the warning to check the insn class (which prevents it from

  triggering for ldimm64, for which nospec_result would not be

  problematic) and use verifier_bug_if().


  In line with Eduard''s suggestion, do not introduce prev_aux() because

  that requires one to understand that after do_check_insn() call what was

  current became previous. This would at-least require a comment.


  Fixes: d6f1c85f2253 ("bpf: Fall back to nospec for Spectre v1")

  Reported-by: Paul Chaignon <paul.chaignon@gmail.com>

  Reported-by: Eduard Zingerman <eddyz87@gmail.com>

  Reported-by: syzbot+dc27c5fb8388e38d2d37@syzkaller.appspotmail.com

  Link: https://lore.kernel.org/bpf/685b3c1b.050a0220.2303ee.0010.GAE@google.com/

  Link: https://lore.kernel.org/bpf/4266fd5de04092aa4971cbef14f1b4b96961f432.camel@gmail.com/

  Suggested-by: Eduard Zingerman <eddyz87@gmail.com>

  Signed-off-by: Luis Gerhorst <luis.gerhorst@fau.de>

  Acked-by: Eduard Zingerman <eddyz87@gmail.com>

  Link: https://lore.kernel.org/r/20250705190908.1756862-2-luis.gerhorst@fau.de

  Signed-off-by: Alexei Starovoitov <ast@kernel.org>

  '
submodule:
- kernel/bpf
hunk_count: 6
covered_count: 2
