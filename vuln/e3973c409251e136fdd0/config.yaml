id: e3973c409251e136fdd0
bug_link: https://syzkaller.appspot.com/bug?extid=e3973c409251e136fdd0
title: 'INFO: task hung in nilfs_detach_log_writer'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 936184eadd82906992ff1f5ab3aada70cce44cee
fix_commit: eb85dace897c5986bc2f36b3c783c6abb8a4292e
datetime: '2024-05-24T11:55:07-07:00'
fix_commit_message: "nilfs2: fix potential hang in nilfs_detach_log_writer()\n\nSyzbot\
  \ has reported a potential hang in nilfs_detach_log_writer() called\nduring nilfs2\
  \ unmount.\n\nAnalysis revealed that this is because nilfs_segctor_sync(), which\n\
  synchronizes with the log writer thread, can be called after\nnilfs_segctor_destroy()\
  \ terminates that thread, as shown in the call trace\nbelow:\n\nnilfs_detach_log_writer\n\
  \  nilfs_segctor_destroy\n    nilfs_segctor_kill_thread  --> Shut down log writer\
  \ thread\n    flush_work\n      nilfs_iput_work_func\n        nilfs_dispose_list\n\
  \          iput\n            nilfs_evict_inode\n              nilfs_transaction_commit\n\
  \                nilfs_construct_segment (if inode needs sync)\n               \
  \   nilfs_segctor_sync  --> Attempt to synchronize with\n                      \
  \                    log writer thread\n                           *** DEADLOCK\
  \ ***\n\nFix this issue by changing nilfs_segctor_sync() so that the log writer\n\
  thread returns normally without synchronizing after it terminates, and by\nforcing\
  \ tasks that are already waiting to complete once after the thread\nterminates.\n\
  \nThe skipped inode metadata flushout will then be processed together in the\nsubsequent\
  \ cleanup work in nilfs_segctor_destroy().\n\nLink: https://lkml.kernel.org/r/20240520132621.4054-4-konishi.ryusuke@gmail.com\n\
  Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>\nReported-by: syzbot+e3973c409251e136fdd0@syzkaller.appspotmail.com\n\
  Closes: https://syzkaller.appspot.com/bug?extid=e3973c409251e136fdd0\nTested-by:\
  \ Ryusuke Konishi <konishi.ryusuke@gmail.com>\nCc: <stable@vger.kernel.org>\nCc:\
  \ \"Bai, Shuangpeng\" <sjb7183@psu.edu>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\n"
submodule:
- fs/nilfs2
hunk_count: 5
covered_count: 1
