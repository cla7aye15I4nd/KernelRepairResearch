id: 28a66a9fbc621c939000
bug_link: https://syzkaller.appspot.com/bug?extid=28a66a9fbc621c939000
title: 'KASAN: use-after-free Read in disk_release_events'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 37e11c3616f6182b6bd7f95a04df035b43464f39
fix_commit: 99d8690aae4b2f0d1d90075de355ac087f820a66
datetime: '2021-12-21T09:31:51-07:00'
fix_commit_message: 'block: fix error unwinding in device_add_disk


  One device_add is called disk->ev will be freed by disk_release, so we

  should free it twice.  Fix this by allocating disk->ev after device_add

  so that the extra local unwinding can be removed entirely.


  Based on an earlier patch from Tetsuo Handa.


  Reported-by: syzbot <syzbot+28a66a9fbc621c939000@syzkaller.appspotmail.com>

  Tested-by: syzbot <syzbot+28a66a9fbc621c939000@syzkaller.appspotmail.com>

  Fixes: 83cbce9574462c6b ("block: add error handling for device_add_disk / add_disk")

  Signed-off-by: Christoph Hellwig <hch@lst.de>

  Link: https://lore.kernel.org/r/20211221161851.788424-1-hch@lst.de

  Signed-off-by: Jens Axboe <axboe@kernel.dk>

  '
submodule:
- block
hunk_count: 3
covered_count: 3
