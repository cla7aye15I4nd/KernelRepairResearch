id: 121be635a7a35ddb7dcb
bug_link: https://syzkaller.appspot.com/bug?extid=121be635a7a35ddb7dcb
title: kernel BUG at fs/userfaultfd.c:LINE! (2)
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: eec3636ad198d4ac61e574cb122cb67e9bef5492
fix_commit: 31e810aa1033a7db50a2746cd34a2432237f6420
datetime: '2018-08-02T16:03:40-07:00'
fix_commit_message: 'userfaultfd: remove uffd flags from vma->vm_flags if UFFD_EVENT_FORK
  fails


  The fix in commit 0cbb4b4f4c44 ("userfaultfd: clear the

  vma->vm_userfaultfd_ctx if UFFD_EVENT_FORK fails") cleared the

  vma->vm_userfaultfd_ctx but kept userfaultfd flags in vma->vm_flags

  that were copied from the parent process VMA.


  As the result, there is an inconsistency between the values of

  vma->vm_userfaultfd_ctx.ctx and vma->vm_flags which triggers BUG_ON

  in userfaultfd_release().


  Clearing the uffd flags from vma->vm_flags in case of UFFD_EVENT_FORK

  failure resolves the issue.


  Link: http://lkml.kernel.org/r/1532931975-25473-1-git-send-email-rppt@linux.vnet.ibm.com

  Fixes: 0cbb4b4f4c44 ("userfaultfd: clear the vma->vm_userfaultfd_ctx if UFFD_EVENT_FORK
  fails")

  Signed-off-by: Mike Rapoport <rppt@linux.vnet.ibm.com>

  Reported-by: syzbot+121be635a7a35ddb7dcb@syzkaller.appspotmail.com

  Cc: Andrea Arcangeli <aarcange@redhat.com>

  Cc: Eric Biggers <ebiggers3@gmail.com>

  Cc: <stable@vger.kernel.org>

  Signed-off-by: Andrew Morton <akpm@linux-foundation.org>

  Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

  '
submodule:
- fs
hunk_count: 1
covered_count: 0
