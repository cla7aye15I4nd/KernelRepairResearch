id: b5d82a651b71cd8a75ab
bug_link: https://syzkaller.appspot.com/bug?extid=b5d82a651b71cd8a75ab
title: WARNING in static_key_slow_try_dec (3)
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 76b907ee00c4a5cdd5d0adbacdaa1c1989385615
fix_commit: 921ebde3c0d22c8cba74ce8eb3cc4626abff1ccd
datetime: '2022-09-20T23:50:03+02:00'
fix_commit_message: 'netfilter: nf_tables: fix nft_counters_enabled underflow at nf_tables_addchain()


  syzbot is reporting underflow of nft_counters_enabled counter at

  nf_tables_addchain() [1], for commit 43eb8949cfdffa76 ("netfilter:

  nf_tables: do not leave chain stats enabled on error") missed that

  nf_tables_chain_destroy() after nft_basechain_init() in the error path of

  nf_tables_addchain() decrements the counter because nft_basechain_init()

  makes nft_is_base_chain() return true by setting NFT_CHAIN_BASE flag.


  Increment the counter immediately after returning from

  nft_basechain_init().


  Link:  https://syzkaller.appspot.com/bug?extid=b5d82a651b71cd8a75ab [1]

  Reported-by: syzbot <syzbot+b5d82a651b71cd8a75ab@syzkaller.appspotmail.com>

  Signed-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp>

  Tested-by: syzbot <syzbot+b5d82a651b71cd8a75ab@syzkaller.appspotmail.com>

  Fixes: 43eb8949cfdffa76 ("netfilter: nf_tables: do not leave chain stats enabled
  on error")

  Signed-off-by: Florian Westphal <fw@strlen.de>

  '
submodule:
- net/netfilter
hunk_count: 4
covered_count: 1
