id: c946805b5ce6ab87df0b
bug_link: https://syzkaller.appspot.com/bug?extid=c946805b5ce6ab87df0b
title: 'bpf-next boot error: WARNING in bpf_prog_pack_free'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: d56c9fe6a06820d5ef8188d96bf4345c7bdba249
fix_commit: 96805674e5624b3c79780a2b41c7a3d6bc38dc76
datetime: '2022-03-21T13:53:45-07:00'
fix_commit_message: 'bpf: Fix bpf_prog_pack for multi-node setup


  module_alloc requires num_online_nodes * PMD_SIZE to allocate huge pages.

  bpf_prog_pack uses pack of size num_online_nodes * PMD_SIZE.

  OTOH, module_alloc returns addresses that are PMD_SIZE aligned (instead of

  num_online_nodes * PMD_SIZE aligned). Therefore, PMD_MASK should be used

  to calculate pack_ptr in bpf_prog_pack_free().


  Fixes: ef078600eec2 ("bpf: Select proper size for bpf_prog_pack")

  Reported-by: syzbot+c946805b5ce6ab87df0b@syzkaller.appspotmail.com

  Signed-off-by: Song Liu <song@kernel.org>

  Signed-off-by: Alexei Starovoitov <ast@kernel.org>

  Link: https://lore.kernel.org/bpf/20220321180009.1944482-2-song@kernel.org

  '
submodule:
- kernel/bpf
hunk_count: 3
covered_count: 1
