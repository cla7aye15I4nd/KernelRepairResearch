id: f342ea16c9d06d80b585
bug_link: https://syzkaller.appspot.com/bug?extid=f342ea16c9d06d80b585
title: 'INFO: task hung in usb_port_suspend'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 9499327714de7bc5cf6c792112c1474932d8ad31
fix_commit: 5189df7b8088268012882c220d6aca4e64981348
datetime: '2024-10-17T08:45:10+02:00'
fix_commit_message: 'USB: gadget: dummy-hcd: Fix "task hung" problem


  The syzbot fuzzer has been encountering "task hung" problems ever

  since the dummy-hcd driver was changed to use hrtimers instead of

  regular timers.  It turns out that the problems are caused by a subtle

  difference between the timer_pending() and hrtimer_active() APIs.


  The changeover blindly replaced the first by the second.  However,

  timer_pending() returns True when the timer is queued but not when its

  callback is running, whereas hrtimer_active() returns True when the

  hrtimer is queued _or_ its callback is running.  This difference

  occasionally caused dummy_urb_enqueue() to think that the callback

  routine had not yet started when in fact it was almost finished.  As a

  result the hrtimer was not restarted, which made it impossible for the

  driver to dequeue later the URB that was just enqueued.  This caused

  usb_kill_urb() to hang, and things got worse from there.


  Since hrtimers have no API for telling when they are queued and the

  callback isn''t running, the driver must keep track of this for itself.

  That''s what this patch does, adding a new "timer_pending" flag and

  setting or clearing it at the appropriate times.


  Reported-by: syzbot+f342ea16c9d06d80b585@syzkaller.appspotmail.com

  Closes: https://lore.kernel.org/linux-usb/6709234e.050a0220.3e960.0011.GAE@google.com/

  Tested-by: syzbot+f342ea16c9d06d80b585@syzkaller.appspotmail.com

  Signed-off-by: Alan Stern <stern@rowland.harvard.edu>

  Fixes: a7f3813e589f ("usb: gadget: dummy_hcd: Switch to hrtimer transfer scheduler")

  Cc: Marcello Sylvester Bauer <sylv@sylv.io>

  Cc: stable@vger.kernel.org

  Link: https://lore.kernel.org/r/2dab644e-ef87-4de8-ac9a-26f100b2c609@rowland.harvard.edu

  Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

  '
submodule:
- drivers/usb/gadget/udc
hunk_count: 7
covered_count: 0
