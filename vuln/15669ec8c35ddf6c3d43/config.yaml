id: 15669ec8c35ddf6c3d43
bug_link: https://syzkaller.appspot.com/bug?extid=15669ec8c35ddf6c3d43
title: kernel BUG in new_curseg (2)
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 5f95c1812a65e4e8a6b89b6c0bafd654e8bc03de
fix_commit: 48ea8b200414ac69ea96f4c231f5c7ef1fbeffef
datetime: '2025-02-12T02:30:50+00:00'
fix_commit_message: "f2fs: fix to avoid panic once fallocation fails for pinfile\n\
  \nsyzbot reports a f2fs bug as below:\n\n------------[ cut here ]------------\n\
  kernel BUG at fs/f2fs/segment.c:2746!\nCPU: 0 UID: 0 PID: 5323 Comm: syz.0.0 Not\
  \ tainted 6.13.0-rc2-syzkaller-00018-g7cb1b4663150 #0\nRIP: 0010:get_new_segment\
  \ fs/f2fs/segment.c:2746 [inline]\nRIP: 0010:new_curseg+0x1f52/0x1f70 fs/f2fs/segment.c:2876\n\
  Call Trace:\n <TASK>\n __allocate_new_segment+0x1ce/0x940 fs/f2fs/segment.c:3210\n\
  \ f2fs_allocate_new_section fs/f2fs/segment.c:3224 [inline]\n f2fs_allocate_pinning_section+0xfa/0x4e0\
  \ fs/f2fs/segment.c:3238\n f2fs_expand_inode_data+0x696/0xca0 fs/f2fs/file.c:1830\n\
  \ f2fs_fallocate+0x537/0xa10 fs/f2fs/file.c:1940\n vfs_fallocate+0x569/0x6e0 fs/open.c:327\n\
  \ do_vfs_ioctl+0x258c/0x2e40 fs/ioctl.c:885\n __do_sys_ioctl fs/ioctl.c:904 [inline]\n\
  \ __se_sys_ioctl+0x80/0x170 fs/ioctl.c:892\n do_syscall_x64 arch/x86/entry/common.c:52\
  \ [inline]\n do_syscall_64+0xf3/0x230 arch/x86/entry/common.c:83\n entry_SYSCALL_64_after_hwframe+0x77/0x7f\n\
  \nConcurrent pinfile allocation may run out of free section, result in\npanic in\
  \ get_new_segment(), let's expand pin_sem lock coverage to\ninclude f2fs_gc(), so\
  \ that we can make sure to reclaim enough free\nspace for following allocation.\n\
  \nIn addition, do below changes to enhance error path handling:\n- call f2fs_bug_on()\
  \ only in non-pinfile allocation path in\nget_new_segment().\n- call reset_curseg_fields()\
  \ to reset all fields of curseg in\nnew_curseg()\n\nFixes: f5a53edcf01e (\"f2fs:\
  \ support aligned pinned file\")\nReported-by: syzbot+15669ec8c35ddf6c3d43@syzkaller.appspotmail.com\n\
  Closes: https://lore.kernel.org/linux-f2fs-devel/675cd64e.050a0220.37aaf.00bb.GAE@google.com\n\
  Signed-off-by: Chao Yu <chao@kernel.org>\nSigned-off-by: Jaegeuk Kim <jaegeuk@kernel.org>\n"
submodule:
- fs/f2fs
hunk_count: 6
covered_count: 5
