id: 193f9cee8638750b23cf
bug_link: https://syzkaller.appspot.com/bug?extid=193f9cee8638750b23cf
title: 'KASAN: use-after-free Read in hugetlb_handle_userfault'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: c1b8fdae62e59904ecdfe4f50410575ea02fec18
fix_commit: 958f32ce832ba781ac20e11bb2d12a9352ea28fc
datetime: '2022-10-03T14:03:32-07:00'
fix_commit_message: "mm: hugetlb: fix UAF in hugetlb_handle_userfault\n\nThe vma_lock\
  \ and hugetlb_fault_mutex are dropped before handling userfault\nand reacquire them\
  \ again after handle_userfault(), but reacquire the\nvma_lock could lead to UAF[1,2]\
  \ due to the following race,\n\nhugetlb_fault\n  hugetlb_no_page\n    /*unlock vma_lock\
  \ */\n    hugetlb_handle_userfault\n      handle_userfault\n        /* unlock mm->mmap_lock*/\n\
  \                                           vm_mmap_pgoff\n                    \
  \                         do_mmap\n                                            \
  \   mmap_region\n                                                 munmap_vma_range\n\
  \                                                   /* clean old vma */\n      \
  \  /* lock vma_lock again  <--- UAF */\n    /* unlock vma_lock */\n\nSince the vma_lock\
  \ will unlock immediately after\nhugetlb_handle_userfault(), let's drop the unneeded\
  \ lock and unlock in\nhugetlb_handle_userfault() to fix the issue.\n\n[1] https://lore.kernel.org/linux-mm/000000000000d5e00a05e834962e@google.com/\n\
  [2] https://lore.kernel.org/linux-mm/20220921014457.1668-1-liuzixian4@huawei.com/\n\
  Link: https://lkml.kernel.org/r/20220923042113.137273-1-liushixin2@huawei.com\n\
  Fixes: 1a1aad8a9b7b (\"userfaultfd: hugetlbfs: add userfaultfd hugetlb hook\")\n\
  Signed-off-by: Liu Shixin <liushixin2@huawei.com>\nSigned-off-by: Kefeng Wang <wangkefeng.wang@huawei.com>\n\
  Reported-by: syzbot+193f9cee8638750b23cf@syzkaller.appspotmail.com\nReported-by:\
  \ Liu Zixian <liuzixian4@huawei.com>\nReviewed-by: Mike Kravetz <mike.kravetz@oracle.com>\n\
  Cc: David Hildenbrand <david@redhat.com>\nCc: John Hubbard <jhubbard@nvidia.com>\n\
  Cc: Muchun Song <songmuchun@bytedance.com>\nCc: Sidhartha Kumar <sidhartha.kumar@oracle.com>\n\
  Cc: <stable@vger.kernel.org>\t[4.14+]\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\n"
submodule:
- mm
hunk_count: 8
covered_count: 6
