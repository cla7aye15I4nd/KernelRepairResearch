id: 57281c762a3922e14dfe
bug_link: https://syzkaller.appspot.com/bug?extid=57281c762a3922e14dfe
title: memory leak in mcba_usb_probe
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 5e87ddbe3942e27e939bdc02deb8579b0cbd8ecc
fix_commit: 91c02557174be7f72e46ed7311e3bea1939840b0
datetime: '2021-06-16T12:52:18+02:00'
fix_commit_message: "can: mcba_usb: fix memory leak in mcba_usb\n\nSyzbot reported\
  \ memory leak in SocketCAN driver for Microchip CAN BUS\nAnalyzer Tool. The problem\
  \ was in unfreed usb_coherent.\n\nIn mcba_usb_start() 20 coherent buffers are allocated\
  \ and there is\nnothing, that frees them:\n\n1) In callback function the urb is\
  \ resubmitted and that's all\n2) In disconnect function urbs are simply killed,\
  \ but URB_FREE_BUFFER\n   is not set (see mcba_usb_start) and this flag cannot be\
  \ used with\n   coherent buffers.\n\nFail log:\n| [ 1354.053291][ T8413] mcba_usb\
  \ 1-1:0.0 can0: device disconnected\n| [ 1367.059384][ T8420] kmemleak: 20 new suspected\
  \ memory leaks (see /sys/kernel/debug/kmem)\n\nSo, all allocated buffers should\
  \ be freed with usb_free_coherent()\nexplicitly\n\nNOTE:\nThe same pattern for allocating\
  \ and freeing coherent buffers\nis used in drivers/net/can/usb/kvaser_usb/kvaser_usb_core.c\n\
  \nFixes: 51f3baad7de9 (\"can: mcba_usb: Add support for Microchip CAN BUS Analyzer\"\
  )\nLink: https://lore.kernel.org/r/20210609215833.30393-1-paskripkin@gmail.com\n\
  Cc: linux-stable <stable@vger.kernel.org>\nReported-and-tested-by: syzbot+57281c762a3922e14dfe@syzkaller.appspotmail.com\n\
  Signed-off-by: Pavel Skripkin <paskripkin@gmail.com>\nSigned-off-by: Marc Kleine-Budde\
  \ <mkl@pengutronix.de>\n"
submodule:
- drivers/net/can/usb
hunk_count: 5
covered_count: 4
