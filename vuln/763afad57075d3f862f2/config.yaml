id: 763afad57075d3f862f2
bug_link: https://syzkaller.appspot.com/bug?extid=763afad57075d3f862f2
title: 'KASAN: slab-use-after-free Read in f2fs_filemap_fault'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 74b0ebcbdde4c7fe23c979e4cfc2fdbf349c39a3
fix_commit: eb70d5a6c932d9d23f4bb3e7b83782c21ac4b064
datetime: '2024-03-14T09:14:53-07:00'
fix_commit_message: "f2fs: fix to avoid use-after-free issue in f2fs_filemap_fault\n\
  \nsyzbot reports a f2fs bug as below:\n\nBUG: KASAN: slab-use-after-free in f2fs_filemap_fault+0xd1/0x2c0\
  \ fs/f2fs/file.c:49\nRead of size 8 at addr ffff88807bb22680 by task syz-executor184/5058\n\
  \nCPU: 0 PID: 5058 Comm: syz-executor184 Not tainted 6.7.0-syzkaller-09928-g052d534373b7\
  \ #0\nHardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google\
  \ 11/17/2023\nCall Trace:\n <TASK>\n __dump_stack lib/dump_stack.c:88 [inline]\n\
  \ dump_stack_lvl+0x1e7/0x2d0 lib/dump_stack.c:106\n print_address_description mm/kasan/report.c:377\
  \ [inline]\n print_report+0x163/0x540 mm/kasan/report.c:488\n kasan_report+0x142/0x170\
  \ mm/kasan/report.c:601\n f2fs_filemap_fault+0xd1/0x2c0 fs/f2fs/file.c:49\n __do_fault+0x131/0x450\
  \ mm/memory.c:4376\n do_shared_fault mm/memory.c:4798 [inline]\n do_fault mm/memory.c:4872\
  \ [inline]\n do_pte_missing mm/memory.c:3745 [inline]\n handle_pte_fault mm/memory.c:5144\
  \ [inline]\n __handle_mm_fault+0x23b7/0x72b0 mm/memory.c:5285\n handle_mm_fault+0x27e/0x770\
  \ mm/memory.c:5450\n do_user_addr_fault arch/x86/mm/fault.c:1364 [inline]\n handle_page_fault\
  \ arch/x86/mm/fault.c:1507 [inline]\n exc_page_fault+0x456/0x870 arch/x86/mm/fault.c:1563\n\
  \ asm_exc_page_fault+0x26/0x30 arch/x86/include/asm/idtentry.h:570\n\nThe root cause\
  \ is: in f2fs_filemap_fault(), vmf->vma may be not alive after\nfilemap_fault(),\
  \ so it may cause use-after-free issue when accessing\nvmf->vma->vm_flags in trace_f2fs_filemap_fault().\
  \ So it needs to keep vm_flags\nin separated temporary variable for tracepoint use.\n\
  \nFixes: 87f3afd366f7 (\"f2fs: add tracepoint for f2fs_vm_page_mkwrite()\")\nReported-and-tested-by:\
  \ syzbot+763afad57075d3f862f2@syzkaller.appspotmail.com\nCloses: https://lore.kernel.org/lkml/000000000000e8222b060f00db3b@google.com\n\
  Cc: Ed Tsai <Ed.Tsai@mediatek.com>\nSuggested-by: Hillf Danton <hdanton@sina.com>\n\
  Signed-off-by: Chao Yu <chao@kernel.org>\nSigned-off-by: Jaegeuk Kim <jaegeuk@kernel.org>\n"
submodule:
- fs/f2fs
hunk_count: 2
covered_count: 2
