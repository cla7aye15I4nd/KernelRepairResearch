id: b4d960daf7a3c7c2b7b1
bug_link: https://syzkaller.appspot.com/bug?extid=b4d960daf7a3c7c2b7b1
title: WARNING in virtio_transport_send_pkt_info
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: b08a784a5d1495c42ff9b0c70887d49211cddfe0
fix_commit: 7fb1291257ea1e27dbc3f34c6a37b4d640aafdd7
datetime: '2025-08-21T17:49:19-07:00'
fix_commit_message: "vsock/virtio: Fix message iterator handling on transmit path\n\
  \nCommit 6693731487a8 (\"vsock/virtio: Allocate nonlinear SKBs for handling\nlarge\
  \ transmit buffers\") converted the virtio vsock transmit path to\nutilise nonlinear\
  \ SKBs when handling large buffers. As part of this\nchange, virtio_transport_fill_skb()\
  \ was updated to call\nskb_copy_datagram_from_iter() instead of memcpy_from_msg()\
  \ as the latter\nexpects a single destination buffer and cannot handle nonlinear\
  \ SKBs\ncorrectly.\n\nUnfortunately, during this conversion, I overlooked the error\
  \ case when\nthe copying function returns -EFAULT due to a fault on the input buffer\n\
  in userspace. In this case, memcpy_from_msg() reverts the iterator to\nits initial\
  \ state thanks to copy_from_iter_full() whereas\nskb_copy_datagram_from_iter() leaves\
  \ the iterator partially advanced.\nThis results in a WARN_ONCE() from the vsock\
  \ code, which expects the\niterator to stay in sync with the number of bytes transmitted\
  \ so that\nvirtio_transport_send_pkt_info() can return -EFAULT when it is called\n\
  again:\n\n  ------------[ cut here ]------------\n  'send_pkt()' returns 0, but\
  \ 65536 expected\n  WARNING: CPU: 0 PID: 5503 at net/vmw_vsock/virtio_transport_common.c:428\
  \ virtio_transport_send_pkt_info+0xd11/0xf00 net/vmw_vsock/virtio_transport_common.c:426\n\
  \  Modules linked in:\n  CPU: 0 UID: 0 PID: 5503 Comm: syz.0.17 Not tainted 6.16.0-syzkaller-12063-g37816488247d\
  \ #0 PREEMPT(full)\n  Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-debian-1.16.3-2~bpo12+1\
  \ 04/01/2014\n\nCall virtio_transport_fill_skb_full() to restore the previous iterator\n\
  behaviour.\n\nCc: Jason Wang <jasowang@redhat.com>\nCc: Stefano Garzarella <sgarzare@redhat.com>\n\
  Fixes: 6693731487a8 (\"vsock/virtio: Allocate nonlinear SKBs for handling large\
  \ transmit buffers\")\nReported-by: syzbot+b4d960daf7a3c7c2b7b1@syzkaller.appspotmail.com\n\
  Signed-off-by: Will Deacon <will@kernel.org>\nAcked-by: Michael S. Tsirkin <mst@redhat.com>\n\
  Reviewed-by: Stefan Hajnoczi <stefanha@redhat.com>\nLink: https://patch.msgid.link/20250818180355.29275-3-will@kernel.org\n\
  Signed-off-by: Jakub Kicinski <kuba@kernel.org>\n"
submodule:
- net/vmw_vsock
hunk_count: 1
covered_count: 1
