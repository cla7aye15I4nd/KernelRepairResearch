id: bee87a0c3291c06aa8c6
bug_link: https://syzkaller.appspot.com/bug?extid=bee87a0c3291c06aa8c6
title: kernel BUG in bch2_inconsistent_error
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: baefd3f849ed956d4c1aee80889093cf0d9c6a94
fix_commit: f9f0a5390dcef1f96cc506a2cf7d50c8e348fa3d
datetime: '2024-11-07T16:48:21-05:00'
fix_commit_message: 'bcachefs: Change OPT_STR max to be 1 less than the size of choices
  array


  Change OPT_STR max value to be 1 less than the "ARRAY_SIZE" of "_choices"

  array. As a result, remove -1 from (opt->max-1) in bch2_opt_to_text.


  The "_choices" array is a null-terminated array, so computing the maximum

  using "ARRAY_SIZE" without subtracting 1 yields an incorrect result. Since

  bch2_opt_validate don''t subtract 1, as bch2_opt_to_text does, values

  bigger than the actual maximum would pass through option validation.


  Reported-by: syzbot+bee87a0c3291c06aa8c6@syzkaller.appspotmail.com

  Closes: https://syzkaller.appspot.com/bug?extid=bee87a0c3291c06aa8c6

  Fixes: 63c4b2545382 ("bcachefs: Better superblock opt validation")

  Suggested-by: Kent Overstreet <kent.overstreet@linux.dev>

  Signed-off-by: Piotr Zalewski <pZ010001011111@proton.me>

  Signed-off-by: Kent Overstreet <kent.overstreet@linux.dev>

  '
submodule:
- fs/bcachefs
hunk_count: 2
covered_count: 0
