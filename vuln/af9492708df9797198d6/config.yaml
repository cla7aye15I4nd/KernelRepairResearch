id: af9492708df9797198d6
bug_link: https://syzkaller.appspot.com/bug?extid=af9492708df9797198d6
title: general protection fault in dev_map_enqueue
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: c6f48506ba30c722dd9d89aa6a40eb1926277dff
fix_commit: 5bcf0dcbf9066348058b88a510c57f70f384c92c
datetime: '2024-04-22T10:24:41-07:00'
fix_commit_message: 'xdp: use flags field to disambiguate broadcast redirect


  When redirecting a packet using XDP, the bpf_redirect_map() helper will set

  up the redirect destination information in struct bpf_redirect_info (using

  the __bpf_xdp_redirect_map() helper function), and the xdp_do_redirect()

  function will read this information after the XDP program returns and pass

  the frame on to the right redirect destination.


  When using the BPF_F_BROADCAST flag to do multicast redirect to a whole

  map, __bpf_xdp_redirect_map() sets the ''map'' pointer in struct

  bpf_redirect_info to point to the destination map to be broadcast. And

  xdp_do_redirect() reacts to the value of this map pointer to decide whether

  it''s dealing with a broadcast or a single-value redirect. However, if the

  destination map is being destroyed before xdp_do_redirect() is called, the

  map pointer will be cleared out (by bpf_clear_redirect_map()) without

  waiting for any XDP programs to stop running. This causes xdp_do_redirect()

  to think that the redirect was to a single target, but the target pointer

  is also NULL (since broadcast redirects don''t have a single target), so

  this causes a crash when a NULL pointer is passed to dev_map_enqueue().


  To fix this, change xdp_do_redirect() to react directly to the presence of

  the BPF_F_BROADCAST flag in the ''flags'' value in struct bpf_redirect_info

  to disambiguate between a single-target and a broadcast redirect. And only

  read the ''map'' pointer if the broadcast flag is set, aborting if that has

  been cleared out in the meantime. This prevents the crash, while keeping

  the atomic (cmpxchg-based) clearing of the map pointer itself, and without

  adding any more checks in the non-broadcast fast path.


  Fixes: e624d4ed4aa8 ("xdp: Extend xdp_redirect_map with broadcast support")

  Reported-and-tested-by: syzbot+af9492708df9797198d6@syzkaller.appspotmail.com

  Signed-off-by: Toke Høiland-Jørgensen <toke@redhat.com>

  Acked-by: Stanislav Fomichev <sdf@google.com>

  Reviewed-by: Hangbin Liu <liuhangbin@gmail.com>

  Acked-by: Jesper Dangaard Brouer <hawk@kernel.org>

  Link: https://lore.kernel.org/r/20240418071840.156411-1-toke@redhat.com

  Signed-off-by: Martin KaFai Lau <martin.lau@kernel.org>

  '
submodule:
- net/core
hunk_count: 6
covered_count: 4
