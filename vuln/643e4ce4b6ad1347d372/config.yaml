id: 643e4ce4b6ad1347d372
bug_link: https://syzkaller.appspot.com/bug?extid=643e4ce4b6ad1347d372
title: possible deadlock in blkdev_put (2)
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: c5eafd790e1317f5bfc69845207f69f6447b4b2b
fix_commit: 322c4293ecc58110227b49d7e47ae37b9b03566f
datetime: '2021-12-13T11:37:31-07:00'
fix_commit_message: 'loop: make autoclear operation asynchronous


  syzbot is reporting circular locking problem at __loop_clr_fd() [1], for

  commit 87579e9b7d8dc36e ("loop: use worker per cgroup instead of kworker")

  is calling destroy_workqueue() with disk->open_mutex held.


  This circular dependency cannot be broken unless we call __loop_clr_fd()

  without holding disk->open_mutex. Therefore, defer __loop_clr_fd() from

  lo_release() to a WQ context.


  Link: https://syzkaller.appspot.com/bug?extid=643e4ce4b6ad1347d372 [1]

  Reported-by: syzbot <syzbot+643e4ce4b6ad1347d372@syzkaller.appspotmail.com>

  Suggested-by: Christoph Hellwig <hch@infradead.org>

  Cc: Jan Kara <jack@suse.cz>

  Tested-by: syzbot+643e4ce4b6ad1347d372@syzkaller.appspotmail.com

  Signed-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp>

  Reviewed-by: Christoph Hellwig <hch@lst.de>

  Link: https://lore.kernel.org/r/1ed7df28-ebd6-71fb-70e5-1c2972e05ddb@i-love.sakura.ne.jp

  Signed-off-by: Jens Axboe <axboe@kernel.dk>

  '
submodule:
- drivers/block
hunk_count: 6
covered_count: 4
