id: f66dd31987e6740657be
bug_link: https://syzkaller.appspot.com/bug?extid=f66dd31987e6740657be
title: memory leak in dvb_usb_device_init
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 0fc044b2b5e2d05a1fa1fb0d7f270367a7855d79
fix_commit: 94d90fb06b94a90c176270d38861bcba34ce377d
datetime: '2022-11-25T10:09:47+00:00'
fix_commit_message: "media: dvb-usb: fix memory leak in dvb_usb_adapter_init()\n\n\
  Syzbot reports a memory leak in \"dvb_usb_adapter_init()\".\nThe leak is due to\
  \ not accounting for and freeing current iteration's\nadapter->priv in case of an\
  \ error. Currently if an error occurs,\nit will exit before incrementing \"num_adapters_initalized\"\
  ,\nwhich is used as a reference counter to free all adap->priv\nin \"dvb_usb_adapter_exit()\"\
  . There are multiple error paths that\ncan exit from before incrementing the counter.\
  \ Including the\nerror handling paths for \"dvb_usb_adapter_stream_init()\",\n\"\
  dvb_usb_adapter_dvb_init()\" and \"dvb_usb_adapter_frontend_init()\"\nwithin \"\
  dvb_usb_adapter_init()\".\n\nThis means that in case of an error in any of these\
  \ functions the\ncurrent iteration is not accounted for and the current iteration's\n\
  adap->priv is not freed.\n\nFix this by freeing the current iteration's adap->priv\
  \ in the\n\"stream_init_err:\" label in the error path. The rest of the\n(accounted\
  \ for) adap->priv objects are freed in dvb_usb_adapter_exit()\nas expected using\
  \ the num_adapters_initalized variable.\n\nSyzbot report:\n\nBUG: memory leak\n\
  unreferenced object 0xffff8881172f1a00 (size 512):\n  comm \"kworker/0:2\", pid\
  \ 139, jiffies 4294994873 (age 10.960s)\n  hex dump (first 32 bytes):\n    00 00\
  \ 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................\n    00 00 00 00 00\
  \ 00 00 00 00 00 00 00 00 00 00 00  ................\nbacktrace:\n    [<ffffffff844af012>]\
  \ dvb_usb_adapter_init drivers/media/usb/dvb-usb/dvb-usb-init.c:75 [inline]\n  \
  \  [<ffffffff844af012>] dvb_usb_init drivers/media/usb/dvb-usb/dvb-usb-init.c:184\
  \ [inline]\n    [<ffffffff844af012>] dvb_usb_device_init.cold+0x4e5/0x79e drivers/media/usb/dvb-usb/dvb-usb-init.c:308\n\
  \    [<ffffffff830db21d>] dib0700_probe+0x8d/0x1b0 drivers/media/usb/dvb-usb/dib0700_core.c:883\n\
  \    [<ffffffff82d3fdc7>] usb_probe_interface+0x177/0x370 drivers/usb/core/driver.c:396\n\
  \    [<ffffffff8274ab37>] call_driver_probe drivers/base/dd.c:542 [inline]\n   \
  \ [<ffffffff8274ab37>] really_probe.part.0+0xe7/0x310 drivers/base/dd.c:621\n  \
  \  [<ffffffff8274ae6c>] really_probe drivers/base/dd.c:583 [inline]\n    [<ffffffff8274ae6c>]\
  \ __driver_probe_device+0x10c/0x1e0 drivers/base/dd.c:752\n    [<ffffffff8274af6a>]\
  \ driver_probe_device+0x2a/0x120 drivers/base/dd.c:782\n    [<ffffffff8274b786>]\
  \ __device_attach_driver+0xf6/0x140 drivers/base/dd.c:899\n    [<ffffffff82747c87>]\
  \ bus_for_each_drv+0xb7/0x100 drivers/base/bus.c:427\n    [<ffffffff8274b352>] __device_attach+0x122/0x260\
  \ drivers/base/dd.c:970\n    [<ffffffff827498f6>] bus_probe_device+0xc6/0xe0 drivers/base/bus.c:487\n\
  \    [<ffffffff82745cdb>] device_add+0x5fb/0xdf0 drivers/base/core.c:3405\n    [<ffffffff82d3d202>]\
  \ usb_set_configuration+0x8f2/0xb80 drivers/usb/core/message.c:2170\n    [<ffffffff82d4dbfc>]\
  \ usb_generic_driver_probe+0x8c/0xc0 drivers/usb/core/generic.c:238\n    [<ffffffff82d3f49c>]\
  \ usb_probe_device+0x5c/0x140 drivers/usb/core/driver.c:293\n    [<ffffffff8274ab37>]\
  \ call_driver_probe drivers/base/dd.c:542 [inline]\n    [<ffffffff8274ab37>] really_probe.part.0+0xe7/0x310\
  \ drivers/base/dd.c:621\n    [<ffffffff8274ae6c>] really_probe drivers/base/dd.c:583\
  \ [inline]\n    [<ffffffff8274ae6c>] __driver_probe_device+0x10c/0x1e0 drivers/base/dd.c:752\n\
  \nLink: https://syzkaller.appspot.com/bug?extid=f66dd31987e6740657be\nReported-and-tested-by:\
  \ syzbot+f66dd31987e6740657be@syzkaller.appspotmail.com\n\nLink: https://lore.kernel.org/linux-media/20220824012152.539788-1-mazinalhaddad05@gmail.com\n\
  Signed-off-by: Mazin Al Haddad <mazinalhaddad05@gmail.com>\nSigned-off-by: Mauro\
  \ Carvalho Chehab <mchehab@kernel.org>\n"
submodule:
- drivers/media/usb/dvb-usb
hunk_count: 2
covered_count: 2
