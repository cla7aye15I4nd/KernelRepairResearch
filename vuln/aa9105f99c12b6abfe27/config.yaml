id: aa9105f99c12b6abfe27
bug_link: https://syzkaller.appspot.com/bug?extid=aa9105f99c12b6abfe27
title: 'KASAN: use-after-free Read in __icmp_send'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: daa5c4d0167a308306525fd5ab9a5e18e21f4f74
fix_commit: 4477138fa0ae4e1b699786ef0600863ea6e6c61c
datetime: '2019-03-15T15:42:11-07:00'
fix_commit_message: 'tun: properly test for IFF_UP


  Same reasons than the ones explained in commit 4179cb5a4c92

  ("vxlan: test dev->flags & IFF_UP before calling netif_rx()")


  netif_rx_ni() or napi_gro_frags() must be called under a strict contract.


  At device dismantle phase, core networking clears IFF_UP

  and flush_all_backlogs() is called after rcu grace period

  to make sure no incoming packet might be in a cpu backlog

  and still referencing the device.


  A similar protocol is used for gro layer.


  Most drivers call netif_rx() from their interrupt handler,

  and since the interrupts are disabled at device dismantle,

  netif_rx() does not have to check dev->flags & IFF_UP


  Virtual drivers do not have this guarantee, and must

  therefore make the check themselves.


  Fixes: 1bd4978a88ac ("tun: honor IFF_UP in tun_get_user()")

  Signed-off-by: Eric Dumazet <edumazet@google.com>

  Reported-by: syzbot <syzkaller@googlegroups.com>

  Signed-off-by: David S. Miller <davem@davemloft.net>

  '
submodule:
- drivers/net
hunk_count: 6
covered_count: 0
