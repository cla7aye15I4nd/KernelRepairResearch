id: 3ba856e07b7127889d8c
bug_link: https://syzkaller.appspot.com/bug?extid=3ba856e07b7127889d8c
title: kernel BUG in add_new_free_space
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 8dbfc14fc736eb701089aff09645c3d4ad3decb1
fix_commit: d8ccbd21918fd7fa6ce3226cffc22c444228e8ad
datetime: '2023-07-24T18:06:05+02:00'
fix_commit_message: 'btrfs: remove BUG_ON()''s in add_new_free_space()


  At add_new_free_space() we have these BUG_ON()''s that are there to deal

  with any failure to add free space to the in memory free space cache.

  Such failures are mostly -ENOMEM that should be very rare. However there''s

  no need to have these BUG_ON()''s, we can just return any error to the

  caller and all callers and their upper call chain are already dealing with

  errors.


  So just make add_new_free_space() return any errors, while removing the

  BUG_ON()''s, and returning the total amount of added free space to an

  optional u64 pointer argument.


  Reported-by: syzbot+3ba856e07b7127889d8c@syzkaller.appspotmail.com

  Link: https://lore.kernel.org/linux-btrfs/000000000000e9cb8305ff4e8327@google.com/

  Signed-off-by: Filipe Manana <fdmanana@suse.com>

  Reviewed-by: David Sterba <dsterba@suse.com>

  Signed-off-by: David Sterba <dsterba@suse.com>

  '
submodule:
- fs/btrfs
hunk_count: 12
covered_count: 4
