id: d5b23b18d2f4feae8a67
bug_link: https://syzkaller.appspot.com/bug?extid=d5b23b18d2f4feae8a67
title: possible deadlock in wake_up_all_idle_cpus
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 09089db79859cbccccd8df95b034f36f7027efa6
fix_commit: 96611c26dc351c33f73b48756a9feacc109e5bab
datetime: '2021-10-22T15:32:46+02:00'
fix_commit_message: 'sched: Improve wake_up_all_idle_cpus() take #2


  As reported by syzbot and experienced by Pavel, using cpus_read_lock()

  in wake_up_all_idle_cpus() generates lock inversion (against mmap_sem

  and possibly others).


  Instead, shrink the preempt disable region by iterating all CPUs and

  checking the online status for each individual CPU while having

  preemption disabled.


  Fixes: 8850cb663b5c ("sched: Simplify wake_up_*idle*()")

  Reported-by: syzbot+d5b23b18d2f4feae8a67@syzkaller.appspotmail.com

  Reported-by: Pavel Machek <pavel@ucw.cz>

  Reported-by: Qian Cai <quic_qiancai@quicinc.com>

  Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>

  Tested-by: Qian Cai <quic_qiancai@quicinc.com>

  '
submodule:
- kernel
hunk_count: 1
covered_count: 1
