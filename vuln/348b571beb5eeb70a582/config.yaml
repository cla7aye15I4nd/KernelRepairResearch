id: 348b571beb5eeb70a582
bug_link: https://syzkaller.appspot.com/bug?extid=348b571beb5eeb70a582
title: 'KASAN: use-after-free Read in dev_uevent'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: e9b667a82cdcfe21d590344447d65daed52b353b
fix_commit: 16b1941eac2bd499f065a6739a40ce0011a3d740
datetime: '2022-03-15T18:46:01+01:00'
fix_commit_message: "usb: gadget: Fix use-after-free bug by not setting udc->dev.driver\n\
  \nThe syzbot fuzzer found a use-after-free bug:\n\nBUG: KASAN: use-after-free in\
  \ dev_uevent+0x712/0x780 drivers/base/core.c:2320\nRead of size 8 at addr ffff88802b934098\
  \ by task udevd/3689\n\nCPU: 2 PID: 3689 Comm: udevd Not tainted 5.17.0-rc4-syzkaller-00229-g4f12b742eb2b\
  \ #0\nHardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.14.0-2 04/01/2014\n\
  Call Trace:\n <TASK>\n __dump_stack lib/dump_stack.c:88 [inline]\n dump_stack_lvl+0xcd/0x134\
  \ lib/dump_stack.c:106\n print_address_description.constprop.0.cold+0x8d/0x303 mm/kasan/report.c:255\n\
  \ __kasan_report mm/kasan/report.c:442 [inline]\n kasan_report.cold+0x83/0xdf mm/kasan/report.c:459\n\
  \ dev_uevent+0x712/0x780 drivers/base/core.c:2320\n uevent_show+0x1b8/0x380 drivers/base/core.c:2391\n\
  \ dev_attr_show+0x4b/0x90 drivers/base/core.c:2094\n\nAlthough the bug manifested\
  \ in the driver core, the real cause was a\nrace with the gadget core.  dev_uevent()\
  \ does:\n\n\tif (dev->driver)\n\t\tadd_uevent_var(env, \"DRIVER=%s\", dev->driver->name);\n\
  \nand between the test and the dereference of dev->driver, the gadget\ncore sets\
  \ dev->driver to NULL.\n\nThe race wouldn't occur if the gadget core registered\
  \ its devices on\na real bus, using the standard synchronization techniques of the\n\
  driver core.  However, it's not necessary to make such a large change\nin order\
  \ to fix this bug; all we need to do is make sure that\nudc->dev.driver is always\
  \ NULL.\n\nIn fact, there is no reason for udc->dev.driver ever to be set to\nanything,\
  \ let alone to the value it currently gets: the address of the\ngadget's driver.\
  \  After all, a gadget driver only knows how to manage\na gadget, not how to manage\
  \ a UDC.\n\nThis patch simply removes the statements in the gadget core that touch\n\
  udc->dev.driver.\n\nFixes: 2ccea03a8f7e (\"usb: gadget: introduce UDC Class\")\n\
  CC: <stable@vger.kernel.org>\nReported-and-tested-by: syzbot+348b571beb5eeb70a582@syzkaller.appspotmail.com\n\
  Signed-off-by: Alan Stern <stern@rowland.harvard.edu>\nLink: https://lore.kernel.org/r/YiQgukfFFbBnwJ/9@rowland.harvard.edu\n\
  Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>\n"
submodule:
- drivers/usb/gadget/udc
hunk_count: 3
covered_count: 0
