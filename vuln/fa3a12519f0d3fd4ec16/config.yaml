id: fa3a12519f0d3fd4ec16
bug_link: https://syzkaller.appspot.com/bug?extid=fa3a12519f0d3fd4ec16
title: 'KASAN: slab-use-after-free Read in disk_add_events'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 5421681bc3ef13476bd9443379cd69381e8760fa
fix_commit: 1df1fc845d221eb646539836dbf509eb96b41afd
datetime: '2025-07-31T01:21:43+08:00'
fix_commit_message: "md: fix create on open mddev lifetime regression\n\nCommit 9e59d609763f\
  \ (\"md: call del_gendisk in control path\") moves\nsetting MD_DELETED from __mddev_put()\
  \ to do_md_stop(), however, for the\ncase create on open, mddev can be freed without\
  \ do_md_stop():\n\n1) open\n\nmd_probe\n md_alloc_and_put\n  md_alloc\n   mddev_alloc\n\
  \   atomic_set(&mddev->active, 1);\n   mddev->hold_active = UNTIL_IOCTL\n  mddev_put\n\
  \   atomic_dec_and_test(&mddev->active)\n    if (mddev->hold_active)\n    -> active\
  \ is 0, hold_active is set\nmd_open\n mddev_get\n  atomic_inc(&mddev->active);\n\
  \n2) ioctl that is not STOP_ARRAY, for example, GET_ARRAY_INFO:\n\nmd_ioctl\n mddev->hold_active\
  \ = 0\n\n3) close\n\nmd_release\n mddev_put(mddev);\n  atomic_dec_and_lock(&mddev->active,\
  \ &all_mddevs_lock)\n  __mddev_put\n  -> hold_active is cleared, mddev will be freed\n\
  \  queue_work(md_misc_wq, &mddev->del_work)\n\nNow that MD_DELETED is not set, before\
  \ mddev is freed by\nmddev_delayed_delete(), md_open can still succeed and break\
  \ mddev\nlifetime, causing mddev->kobj refcount underflow or mddev uaf\nproblem.\n\
  \nFix this problem by setting MD_DELETED before queuing del_work.\n\nReported-by:\
  \ syzbot+9921e319bd6168140b40@syzkaller.appspotmail.com\nCloses: https://lore.kernel.org/all/68894408.a00a0220.26d0e1.0012.GAE@google.com/\n\
  Reported-by: syzbot+fa3a12519f0d3fd4ec16@syzkaller.appspotmail.com\nCloses: https://lore.kernel.org/all/68894408.a00a0220.26d0e1.0013.GAE@google.com/\n\
  Fixes: 9e59d609763f (\"md: call del_gendisk in control path\")\nLink: https://lore.kernel.org/linux-raid/20250730073321.2583158-1-yukuai1@huaweicloud.com\n\
  Signed-off-by: Yu Kuai <yukuai3@huawei.com>\nReviewed-by: Paul Menzel <pmenzel@molgen.mpg.de>\n\
  Reviewed-by: Xiao Ni <xni@redhat.com>\n"
submodule:
- drivers/md
hunk_count: 1
covered_count: 1
