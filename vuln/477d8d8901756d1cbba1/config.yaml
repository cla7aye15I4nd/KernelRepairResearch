id: 477d8d8901756d1cbba1
bug_link: https://syzkaller.appspot.com/bug?extid=477d8d8901756d1cbba1
title: 'KASAN: invalid-free in ovl_copy_up_one'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: c63e56a4a6523fcb1358e1878607d77a40b534bb
fix_commit: 5b02bfc1e7e3811c5bf7f0fa626a0694d0dbbd77
datetime: '2023-10-31T00:12:57+02:00'
fix_commit_message: 'ovl: do not encode lower fh with upper sb_writers held


  When lower fs is a nested overlayfs, calling encode_fh() on a lower

  directory dentry may trigger copy up and take sb_writers on the upper fs

  of the lower nested overlayfs.


  The lower nested overlayfs may have the same upper fs as this overlayfs,

  so nested sb_writers lock is illegal.


  Move all the callers that encode lower fh to before ovl_want_write().


  Signed-off-by: Amir Goldstein <amir73il@gmail.com>

  '
submodule:
- fs/overlayfs
hunk_count: 26
covered_count: 4
