id: 4793f6096d174c90b4f7
bug_link: https://syzkaller.appspot.com/bug?extid=4793f6096d174c90b4f7
title: possible deadlock in __f2fs_ioctl
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: fdb7ccc3f9cb316c399b072c7a75a106678eb421
fix_commit: 5eaac835f27f2de6b73412d7c24e755733b49de0
datetime: '2023-01-06T15:13:41-08:00'
fix_commit_message: "f2fs: fix to avoid potential deadlock\n\nThere is a potential\
  \ deadlock reported by syzbot as below:\n\nF2FS-fs (loop2): invalid crc value\n\
  F2FS-fs (loop2): Found nat_bits in checkpoint\nF2FS-fs (loop2): Mounted with checkpoint\
  \ version = 48b305e4\n======================================================\nWARNING:\
  \ possible circular locking dependency detected\n6.1.0-rc8-syzkaller-33330-ga5541c0811a0\
  \ #0 Not tainted\n------------------------------------------------------\nsyz-executor.2/32123\
  \ is trying to acquire lock:\nffff0000c0e1a608 (&mm->mmap_lock){++++}-{3:3}, at:\
  \ __might_fault+0x54/0xb4 mm/memory.c:5644\n\nbut task is already holding lock:\n\
  ffff0001317c6088 (&sbi->sb_lock){++++}-{3:3}, at: f2fs_down_write fs/f2fs/f2fs.h:2205\
  \ [inline]\nffff0001317c6088 (&sbi->sb_lock){++++}-{3:3}, at: f2fs_ioc_get_encryption_pwsalt\
  \ fs/f2fs/file.c:2334 [inline]\nffff0001317c6088 (&sbi->sb_lock){++++}-{3:3}, at:\
  \ __f2fs_ioctl+0x1370/0x3318 fs/f2fs/file.c:4151\n\nwhich lock already depends on\
  \ the new lock.\n\nChain exists of:\n  &mm->mmap_lock --> &nm_i->nat_tree_lock -->\
  \ &sbi->sb_lock\n\n Possible unsafe locking scenario:\n\n       CPU0           \
  \         CPU1\n       ----                    ----\n  lock(&sbi->sb_lock);\n  \
  \                             lock(&nm_i->nat_tree_lock);\n                    \
  \           lock(&sbi->sb_lock);\n  lock(&mm->mmap_lock);\n\nLet's try to avoid\
  \ above deadlock condition by moving __might_fault()\nout of sbi->sb_lock coverage.\n\
  \nFixes: 95fa90c9e5a7 (\"f2fs: support recording errors into superblock\")\nLink:\
  \ https://lore.kernel.org/linux-f2fs-devel/000000000000cd5fe305ef617fe2@google.com/T/#u\n\
  Reported-by: syzbot+4793f6096d174c90b4f7@syzkaller.appspotmail.com\nSigned-off-by:\
  \ Chao Yu <chao@kernel.org>\nReviewed-by: Eric Biggers <ebiggers@google.com>\nSigned-off-by:\
  \ Jaegeuk Kim <jaegeuk@kernel.org>\n"
submodule:
- fs/f2fs
hunk_count: 2
covered_count: 2
