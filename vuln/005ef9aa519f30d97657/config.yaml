id: 005ef9aa519f30d97657
bug_link: https://syzkaller.appspot.com/bug?extid=005ef9aa519f30d97657
title: general protection fault in btree_node_iter_and_journal_peek
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: ca959e328b2243687aa0b95de01414d13e4f3ade
fix_commit: 3726a1970bd72419aa7a54f574635f855b98d67a
datetime: '2024-10-29T06:34:11-04:00'
fix_commit_message: 'bcachefs: Fix NULL ptr dereference in btree_node_iter_and_journal_peek


  Add NULL check for key returned from bch2_btree_and_journal_iter_peek in

  btree_node_iter_and_journal_peek to avoid NULL ptr dereference in

  bch2_bkey_buf_reassemble.


  When key returned from bch2_btree_and_journal_iter_peek is NULL it means

  that btree topology needs repair. Print topology error message with

  position at which node wasn''t found, its parent node information and

  btree_id with level.


  Return error code returned by bch2_topology_error to ensure that topology

  error is handled properly by recovery.


  Reported-by: syzbot+005ef9aa519f30d97657@syzkaller.appspotmail.com

  Closes: https://syzkaller.appspot.com/bug?extid=005ef9aa519f30d97657

  Fixes: 5222a4607cd8 ("bcachefs: BTREE_ITER_WITH_JOURNAL")

  Suggested-by: Alan Huang <mmpgouride@gmail.com>

  Suggested-by: Kent Overstreet <kent.overstreet@linux.dev>

  Signed-off-by: Piotr Zalewski <pZ010001011111@proton.me>

  Signed-off-by: Kent Overstreet <kent.overstreet@linux.dev>

  '
submodule:
- fs/bcachefs
hunk_count: 2
covered_count: 2
