id: 6e8cb445d4b43d006e0c
bug_link: https://syzkaller.appspot.com/bug?extid=6e8cb445d4b43d006e0c
title: WARNING in ip6mr_free_table
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 5eb7de8cd58e73851cd37ff8d0666517d9926948
fix_commit: 50b94204446e1215af081fd713d7d566d9258e35
datetime: '2024-12-04T18:49:16-08:00'
fix_commit_message: 'ipmr: tune the ipmr_can_free_table() checks.


  Eric reported a syzkaller-triggered splat caused by recent ipmr changes:


  WARNING: CPU: 2 PID: 6041 at net/ipv6/ip6mr.c:419

  ip6mr_free_table+0xbd/0x120 net/ipv6/ip6mr.c:419

  Modules linked in:

  CPU: 2 UID: 0 PID: 6041 Comm: syz-executor183 Not tainted

  6.12.0-syzkaller-10681-g65ae975e97d5 #0

  Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS

  1.16.3-debian-1.16.3-2~bpo12+1 04/01/2014

  RIP: 0010:ip6mr_free_table+0xbd/0x120 net/ipv6/ip6mr.c:419

  Code: 00 00 48 b8 00 00 00 00 00 fc ff df 48 89 fa 48 c1 ea 03 80 3c

  02 00 75 58 49 83 bc 24 c0 0e 00 00 00 74 09 e8 44 ef a9 f7 90 <0f> 0b

  90 e8 3b ef a9 f7 48 8d 7b 38 e8 12 a3 96 f7 48 89 df be 0f

  RSP: 0018:ffffc90004267bd8 EFLAGS: 00010293

  RAX: 0000000000000000 RBX: ffff88803c710000 RCX: ffffffff89e4d844

  RDX: ffff88803c52c880 RSI: ffffffff89e4d87c RDI: ffff88803c578ec0

  RBP: 0000000000000001 R08: 0000000000000005 R09: 0000000000000000

  R10: 0000000000000001 R11: 0000000000000001 R12: ffff88803c578000

  R13: ffff88803c710000 R14: ffff88803c710008 R15: dead000000000100

  FS: 00007f7a855ee6c0(0000) GS:ffff88806a800000(0000) knlGS:0000000000000000

  CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033

  CR2: 00007f7a85689938 CR3: 000000003c492000 CR4: 0000000000352ef0

  DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000

  DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400

  Call Trace:

  <TASK>

  ip6mr_rules_exit+0x176/0x2d0 net/ipv6/ip6mr.c:283

  ip6mr_net_exit_batch+0x53/0xa0 net/ipv6/ip6mr.c:1388

  ops_exit_list+0x128/0x180 net/core/net_namespace.c:177

  setup_net+0x4fe/0x860 net/core/net_namespace.c:394

  copy_net_ns+0x2b4/0x6b0 net/core/net_namespace.c:500

  create_new_namespaces+0x3ea/0xad0 kernel/nsproxy.c:110

  unshare_nsproxy_namespaces+0xc0/0x1f0 kernel/nsproxy.c:228

  ksys_unshare+0x45d/0xa40 kernel/fork.c:3334

  __do_sys_unshare kernel/fork.c:3405 [inline]

  __se_sys_unshare kernel/fork.c:3403 [inline]

  __x64_sys_unshare+0x31/0x40 kernel/fork.c:3403

  do_syscall_x64 arch/x86/entry/common.c:52 [inline]

  do_syscall_64+0xcd/0x250 arch/x86/entry/common.c:83

  entry_SYSCALL_64_after_hwframe+0x77/0x7f

  RIP: 0033:0x7f7a856332d9

  Code: 28 00 00 00 75 05 48 83 c4 28 c3 e8 51 18 00 00 90 48 89 f8 48

  89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d

  01 f0 ff ff 73 01 c3 48 c7 c1 b0 ff ff ff f7 d8 64 89 01 48

  RSP: 002b:00007f7a855ee238 EFLAGS: 00000246 ORIG_RAX: 0000000000000110

  RAX: ffffffffffffffda RBX: 00007f7a856bd308 RCX: 00007f7a856332d9

  RDX: 00007f7a8560f8c6 RSI: 0000000000000000 RDI: 0000000062040200

  RBP: 00007f7a856bd300 R08: 00007fff932160a7 R09: 00007f7a855ee6c0

  R10: 0000000000000000 R11: 0000000000000246 R12: 00007f7a856bd30c

  R13: 0000000000000000 R14: 00007fff93215fc0 R15: 00007fff932160a8

  </TASK>


  The root cause is a network namespace creation failing after successful

  initialization of the ipmr subsystem. Such a case is not currently

  matched by the ipmr_can_free_table() helper.


  New namespaces are zeroed on allocation and inserted into net ns list

  only after successful creation; when deleting an ipmr table, the list

  next pointer can be NULL only on netns initialization failure.


  Update the ipmr_can_free_table() checks leveraging such condition.


  Reported-by: Eric Dumazet <edumazet@google.com>

  Reported-by: syzbot+6e8cb445d4b43d006e0c@syzkaller.appspotmail.com

  Closes: https://syzkaller.appspot.com/bug?extid=6e8cb445d4b43d006e0c

  Fixes: 11b6e701bce9 ("ipmr: add debug check for mr table cleanup")

  Signed-off-by: Paolo Abeni <pabeni@redhat.com>

  Reviewed-by: Eric Dumazet <edumazet@google.com>

  Link: https://patch.msgid.link/8bde975e21bbca9d9c27e36209b2dd4f1d7a3f00.1733212078.git.pabeni@redhat.com

  Signed-off-by: Jakub Kicinski <kuba@kernel.org>

  '
submodule:
- include/net
- net/ipv4
- net/ipv6
hunk_count: 3
covered_count: 1
