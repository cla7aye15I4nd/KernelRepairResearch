id: 12056a09a0311d758e60
bug_link: https://syzkaller.appspot.com/bug?extid=12056a09a0311d758e60
title: 'KASAN: use-after-free Read in idr_for_each (2)'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 0298ef969a110ca03654f0cea9b50e3f3b331acc
fix_commit: 61cf93700fe6359552848ed5e3becba6cd760efa
datetime: '2021-03-10T07:28:42-07:00'
fix_commit_message: 'io_uring: Convert personality_idr to XArray


  You can''t call idr_remove() from within a idr_for_each() callback,

  but you can call xa_erase() from an xa_for_each() loop, so switch the

  entire personality_idr from the IDR to the XArray.  This manifests as a

  use-after-free as idr_for_each() attempts to walk the rest of the node

  after removing the last entry from it.


  Fixes: 071698e13ac6 ("io_uring: allow registering credentials")

  Cc: stable@vger.kernel.org # 5.6+

  Reported-by: yangerkun <yangerkun@huawei.com>

  Signed-off-by: Matthew Wilcox (Oracle) <willy@infradead.org>

  [Pavel: rebased (creds load was moved into io_init_req())]

  Signed-off-by: Pavel Begunkov <asml.silence@gmail.com>

  Link: https://lore.kernel.org/r/7ccff36e1375f2b0ebf73d957f037b43becc0dde.1615212806.git.asml.silence@gmail.com

  Signed-off-by: Jens Axboe <axboe@kernel.dk>

  '
submodule:
- fs
hunk_count: 10
covered_count: 0
