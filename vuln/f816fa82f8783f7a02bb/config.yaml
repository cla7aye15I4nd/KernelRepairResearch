id: f816fa82f8783f7a02bb
bug_link: https://syzkaller.appspot.com/bug?extid=f816fa82f8783f7a02bb
title: 'KASAN: use-after-free Read in nilfs_segctor_sync'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: ba54d194f8daad8943802d6dfe06e205f882c391
fix_commit: 8cccf05fe857a18ee26e20d11a8455a73ffd4efd
datetime: '2022-11-08T15:57:24-08:00'
fix_commit_message: "nilfs2: fix use-after-free bug of ns_writer on remount\n\nIf\
  \ a nilfs2 filesystem is downgraded to read-only due to metadata\ncorruption on\
  \ disk and is remounted read/write, or if emergency read-only\nremount is performed,\
  \ detaching a log writer and synchronizing the\nfilesystem can be done at the same\
  \ time.\n\nIn these cases, use-after-free of the log writer (hereinafter\nnilfs->ns_writer)\
  \ can happen as shown in the scenario below:\n\n Task1                         \
  \      Task2\n --------------------------------    ------------------------------\n\
  \ nilfs_construct_segment\n   nilfs_segctor_sync\n     init_wait\n     init_waitqueue_entry\n\
  \     add_wait_queue\n     schedule\n                                     nilfs_remount\
  \ (R/W remount case)\n\t\t\t\t       nilfs_attach_log_writer\n                 \
  \                        nilfs_detach_log_writer\n                             \
  \              nilfs_segctor_destroy\n                                         \
  \    kfree\n     finish_wait\n       _raw_spin_lock_irqsave\n         __raw_spin_lock_irqsave\n\
  \           do_raw_spin_lock\n             debug_spin_lock_before  <-- use-after-free\n\
  \nWhile Task1 is sleeping, nilfs->ns_writer is freed by Task2.  After Task1\nwaked\
  \ up, Task1 accesses nilfs->ns_writer which is already freed.  This\nscenario diagram\
  \ is based on the Shigeru Yoshida's post [1].\n\nThis patch fixes the issue by not\
  \ detaching nilfs->ns_writer on remount so\nthat this UAF race doesn't happen. \
  \ Along with this change, this patch\nalso inserts a few necessary read-only checks\
  \ with superblock instance\nwhere only the ns_writer pointer was used to check if\
  \ the filesystem is\nread-only.\n\nLink: https://syzkaller.appspot.com/bug?id=79a4c002e960419ca173d55e863bd09e8112df8b\n\
  Link: https://lkml.kernel.org/r/20221103141759.1836312-1-syoshida@redhat.com [1]\n\
  Link: https://lkml.kernel.org/r/20221104142959.28296-1-konishi.ryusuke@gmail.com\n\
  Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>\nReported-by: syzbot+f816fa82f8783f7a02bb@syzkaller.appspotmail.com\n\
  Reported-by: Shigeru Yoshida <syoshida@redhat.com>\nTested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>\n\
  Cc: <stable@vger.kernel.org>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\n"
submodule:
- fs/nilfs2
hunk_count: 5
covered_count: 5
