id: 5dfdbcf7b3eb5912abbb
bug_link: https://syzkaller.appspot.com/bug?extid=5dfdbcf7b3eb5912abbb
title: general protection fault in nfs_idmap_legacy_upcall
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: cbebc6ef4fc830f4040d4140bf53484812d5d5d9
fix_commit: 49686cbbb3ebafe42e63868222f269d8053ead00
datetime: '2018-01-22T10:05:11-05:00'
fix_commit_message: "NFS: reject request for id_legacy key without auxdata\n\nnfs_idmap_legacy_upcall()\
  \ is supposed to be called with 'aux' pointing\nto a 'struct idmap', via the call\
  \ to request_key_with_auxdata() in\nnfs_idmap_request_key().\n\nHowever it can also\
  \ be reached via the request_key() system call in\nwhich case 'aux' will be NULL,\
  \ causing a NULL pointer dereference in\nnfs_idmap_prepare_pipe_upcall(), assuming\
  \ that the key description is\nvalid enough to get that far.\n\nFix this by making\
  \ nfs_idmap_legacy_upcall() negate the key if no\nauxdata is provided.\n\nAs usual,\
  \ this bug was found by syzkaller.  A simple reproducer using\nthe command-line\
  \ keyctl program is:\n\n    keyctl request2 id_legacy uid:0 '' @s\n\nFixes: 57e62324e469\
  \ (\"NFS: Store the legacy idmapper result in the keyring\")\nReported-by: syzbot+5dfdbcf7b3eb5912abbb@syzkaller.appspotmail.com\n\
  Cc: <stable@vger.kernel.org> # v3.4+\nSigned-off-by: Eric Biggers <ebiggers@google.com>\n\
  Signed-off-by: Trond Myklebust <trondmy@gmail.com>\n"
submodule:
- fs/nfs
hunk_count: 1
covered_count: 1
