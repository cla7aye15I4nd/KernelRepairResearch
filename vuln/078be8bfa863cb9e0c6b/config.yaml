id: 078be8bfa863cb9e0c6b
bug_link: https://syzkaller.appspot.com/bug?extid=078be8bfa863cb9e0c6b
title: general protection fault in swap_reclaim_full_clusters
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: fae1980347bfd23325099b69db6638b94149a94c
fix_commit: dcf32ea7ecede94796fb30231b3969d7c838374c
datetime: '2024-11-12T16:01:36-08:00'
fix_commit_message: 'mm: swapfile: fix cluster reclaim work crash on rotational devices


  syzbot and Daan report a NULL pointer crash in the new full swap cluster

  reclaim work:


  > Oops: general protection fault, probably for non-canonical address 0xdffffc0000000001:
  0000 [#1] PREEMPT SMP KASAN PTI

  > KASAN: null-ptr-deref in range [0x0000000000000008-0x000000000000000f]

  > CPU: 1 UID: 0 PID: 51 Comm: kworker/1:1 Not tainted 6.12.0-rc6-syzkaller #0

  > Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google
  09/13/2024

  > Workqueue: events swap_reclaim_work

  > RIP: 0010:__list_del_entry_valid_or_report+0x20/0x1c0 lib/list_debug.c:49

  > Code: 90 90 90 90 90 90 90 90 90 90 f3 0f 1e fa 48 89 fe 48 83 c7 08 48 83 ec
  18 48 b8 00 00 00 00 00 fc ff df 48 89 fa 48 c1 ea 03 <80> 3c 02 00 0f 85 19 01
  00 00 48 89 f2 48 8b 4e 08 48 b8 00 00 00

  > RSP: 0018:ffffc90000bb7c30 EFLAGS: 00010202

  > RAX: dffffc0000000000 RBX: 0000000000000000 RCX: ffff88807b9ae078

  > RDX: 0000000000000001 RSI: 0000000000000000 RDI: 0000000000000008

  > RBP: 0000000000000001 R08: 0000000000000001 R09: 0000000000000000

  > R10: 0000000000000001 R11: 000000000000004f R12: dffffc0000000000

  > R13: ffffffffffffffb8 R14: ffff88807b9ae000 R15: ffffc90003af1000

  > FS:  0000000000000000(0000) GS:ffff8880b8700000(0000) knlGS:0000000000000000

  > CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033

  > CR2: 00007fffaca68fb8 CR3: 00000000791c8000 CR4: 00000000003526f0

  > DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000

  > DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400

  > Call Trace:

  >  <TASK>

  >  __list_del_entry_valid include/linux/list.h:124 [inline]

  >  __list_del_entry include/linux/list.h:215 [inline]

  >  list_move_tail include/linux/list.h:310 [inline]

  >  swap_reclaim_full_clusters+0x109/0x460 mm/swapfile.c:748

  >  swap_reclaim_work+0x2e/0x40 mm/swapfile.c:779


  The syzbot console output indicates a virtual environment where swapfile

  is on a rotational device.  In this case, clusters aren''t actually used,

  and si->full_clusters is not initialized.  Daan''s report is from qemu, so

  likely rotational too.


  Make sure to only schedule the cluster reclaim work when clusters are

  actually in use.


  Link: https://lkml.kernel.org/r/20241107142335.GB1172372@cmpxchg.org

  Link: https://lore.kernel.org/lkml/672ac50b.050a0220.2edce.1517.GAE@google.com/

  Link: https://github.com/systemd/systemd/issues/35044

  Fixes: 5168a68eb78f ("mm, swap: avoid over reclaim of full clusters")

  Reported-by: syzbot+078be8bfa863cb9e0c6b@syzkaller.appspotmail.com

  Signed-off-by: Johannes Weiner <hannes@cmpxchg.org>

  Reported-by: Daan De Meyer <daan.j.demeyer@gmail.com>

  Cc: Kairui Song <ryncsn@gmail.com>

  Signed-off-by: Andrew Morton <akpm@linux-foundation.org>

  '
submodule:
- mm
hunk_count: 1
covered_count: 0
