id: b62c37cdd58103293a5a
bug_link: https://syzkaller.appspot.com/bug?extid=b62c37cdd58103293a5a
title: 'upstream test error: WARNING: suspicious RCU usage in _destroy_all_sets'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: a8763466669d21b570b26160d0a5e0a2ee529d22
fix_commit: 8ecd06277a7664f4ef018abae3abd3451d64e7a6
datetime: '2024-06-19T15:12:56+02:00'
fix_commit_message: 'netfilter: ipset: Fix suspicious rcu_dereference_protected()


  When destroying all sets, we are either in pernet exit phase or

  are executing a "destroy all sets command" from userspace. The latter

  was taken into account in ip_set_dereference() (nfnetlink mutex is held),

  but the former was not. The patch adds the required check to

  rcu_dereference_protected() in ip_set_dereference().


  Fixes: 4e7aaa6b82d6 ("netfilter: ipset: Fix race between namespace cleanup and gc
  in the list:set type")

  Reported-by: syzbot+b62c37cdd58103293a5a@syzkaller.appspotmail.com

  Reported-by: syzbot+cfbe1da5fdfc39efc293@syzkaller.appspotmail.com

  Reported-by: kernel test robot <oliver.sang@intel.com>

  Closes: https://lore.kernel.org/oe-lkp/202406141556.e0b6f17e-lkp@intel.com

  Signed-off-by: Jozsef Kadlecsik <kadlec@netfilter.org>

  Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

  '
submodule:
- net/netfilter
hunk_count: 2
covered_count: 1
