id: f1e24a0594d4e3a895d3
bug_link: https://syzkaller.appspot.com/bug?extid=f1e24a0594d4e3a895d3
title: memory leak in tcp_cdg_init
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 8550ff8d8c75416e984d9c4b082845e57e560984
fix_commit: be5d1b61a2ad28c7e57fe8bfa277373e8ecffcdc
datetime: '2021-07-06T10:32:37-07:00'
fix_commit_message: "tcp: fix tcp_init_transfer() to not reset icsk_ca_initialized\n\
  \nThis commit fixes a bug (found by syzkaller) that could cause spurious\ndouble-initializations\
  \ for congestion control modules, which could cause\nmemory leaks or other problems\
  \ for congestion control modules (like CDG)\nthat allocate memory in their init\
  \ functions.\n\nThe buggy scenario constructed by syzkaller was something like:\n\
  \n(1) create a TCP socket\n(2) initiate a TFO connect via sendto()\n(3) while socket\
  \ is in TCP_SYN_SENT, call setsockopt(TCP_CONGESTION),\n    which calls:\n     \
  \  tcp_set_congestion_control() ->\n         tcp_reinit_congestion_control() ->\n\
  \           tcp_init_congestion_control()\n(4) receive ACK, connection is established,\
  \ call tcp_init_transfer(),\n    set icsk_ca_initialized=0 (without first calling\
  \ cc->release()),\n    call tcp_init_congestion_control() again.\n\nNote that in\
  \ this sequence tcp_init_congestion_control() is called\ntwice without a cc->release()\
  \ call in between. Thus, for CC modules\nthat allocate memory in their init() function,\
  \ e.g, CDG, a memory leak\nmay occur. The syzkaller tool managed to find a reproducer\
  \ that\ntriggered such a leak in CDG.\n\nThe bug was introduced when that commit\
  \ 8919a9b31eb4 (\"tcp: Only init\ncongestion control if not initialized already\"\
  )\nintroduced icsk_ca_initialized and set icsk_ca_initialized to 0 in\ntcp_init_transfer(),\
  \ missing the possibility for a sequence like the\none above, where a process could\
  \ call setsockopt(TCP_CONGESTION) in\nstate TCP_SYN_SENT (i.e. after the connect()\
  \ or TFO open sendmsg()),\nwhich would call tcp_init_congestion_control(). It did\
  \ not intend to\nreset any initialization that the user had already explicitly made;\n\
  it just missed the possibility of that particular sequence (which\nsyzkaller managed\
  \ to find).\n\nFixes: 8919a9b31eb4 (\"tcp: Only init congestion control if not initialized\
  \ already\")\nReported-by: syzbot+f1e24a0594d4e3a895d3@syzkaller.appspotmail.com\n\
  Signed-off-by: Nguyen Dinh Phi <phind.uet@gmail.com>\nAcked-by: Neal Cardwell <ncardwell@google.com>\n\
  Tested-by: Neal Cardwell <ncardwell@google.com>\nSigned-off-by: David S. Miller\
  \ <davem@davemloft.net>\n"
submodule:
- net/ipv4
hunk_count: 1
covered_count: 0
