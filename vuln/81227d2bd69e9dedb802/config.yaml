id: 81227d2bd69e9dedb802
bug_link: https://syzkaller.appspot.com/bug?extid=81227d2bd69e9dedb802
title: WARNING in kvm_mmu_notifier_change_pte
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: ea52f71598f3d0cfaaf53b7d837bee9919041351
fix_commit: 4cccb6221cae6d020270606b9e52b1678fc8b71a
datetime: '2024-01-12T15:20:46-08:00'
fix_commit_message: 'fs/proc/task_mmu: move mmu notification mechanism inside mm lock


  Move mmu notification mechanism inside mm lock to prevent race condition

  in other components which depend on it.  The notifier will invalidate

  memory range.  Depending upon the number of iterations, different memory

  ranges would be invalidated.


  The following warning would be removed by this patch:

  WARNING: CPU: 0 PID: 5067 at arch/x86/kvm/../../../virt/kvm/kvm_main.c:734 kvm_mmu_notifier_change_pte+0x860/0x960
  arch/x86/kvm/../../../virt/kvm/kvm_main.c:734


  There is no behavioural and performance change with this patch when

  there is no component registered with the mmu notifier.


  [akpm@linux-foundation.org: narrow the scope of `range'', per Sean]

  Link: https://lkml.kernel.org/r/20240109112445.590736-1-usama.anjum@collabora.com

  Fixes: 52526ca7fdb9 ("fs/proc/task_mmu: implement IOCTL to get and optionally clear
  info about PTEs")

  Signed-off-by: Muhammad Usama Anjum <usama.anjum@collabora.com>

  Reported-by: syzbot+81227d2bd69e9dedb802@syzkaller.appspotmail.com

  Link: https://lore.kernel.org/all/000000000000f6d051060c6785bc@google.com/

  Reviewed-by: Sean Christopherson <seanjc@google.com>

  Cc: Andrei Vagin <avagin@google.com>

  Cc: Arnd Bergmann <arnd@arndb.de>

  Cc: David Hildenbrand <david@redhat.com>

  Cc: Hugh Dickins <hughd@google.com>

  Cc: Kefeng Wang <wangkefeng.wang@huawei.com>

  Cc: Liam R. Howlett <Liam.Howlett@oracle.com>

  Cc: Michał Mirosław <mirq-linux@rere.qmqm.pl>

  Cc: Peter Xu <peterx@redhat.com>

  Cc: Ryan Roberts <ryan.roberts@arm.com>

  Cc: Stephen Rothwell <sfr@canb.auug.org.au>

  Cc: Suren Baghdasaryan <surenb@google.com>

  Cc: <stable@vger.kernel.org>

  Signed-off-by: Andrew Morton <akpm@linux-foundation.org>

  '
submodule:
- fs/proc
hunk_count: 4
covered_count: 0
