id: 2b99589e33edbe9475ca
bug_link: https://syzkaller.appspot.com/bug?extid=2b99589e33edbe9475ca
title: WARNING in folio_large_mapcount
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: e13e7922d03439e374c263049af5f740ceae6346
fix_commit: 595cf683519ab5a277d258a2251ee8cc7b838d6d
datetime: '2025-05-31T22:46:13-07:00'
fix_commit_message: "mm/khugepaged: fix race with folio split/free using temporary\
  \ reference\n\nhpage_collapse_scan_file() calls is_refcount_suitable(), which in\
  \ turn\ncalls folio_mapcount().  folio_mapcount() checks folio_test_large() before\n\
  proceeding to folio_large_mapcount(), but there is a race window where the\nfolio\
  \ may get split/freed between these checks, triggering:\n\n  VM_WARN_ON_FOLIO(!folio_test_large(folio),\
  \ folio)\n\nTake a temporary reference to the folio in hpage_collapse_scan_file().\
  \ \nThis stabilizes the folio during refcount check and prevents incorrect\nlarge\
  \ folio detection due to concurrent split/free.  Use helper\nfolio_expected_ref_count()\
  \ + 1 to compare with folio_ref_count() instead\nof using is_refcount_suitable().\n\
  \nLink: https://lkml.kernel.org/r/20250526182818.37978-1-shivankg@amd.com\nFixes:\
  \ 05c5323b2a34 (\"mm: track mapcount of large folios in single value\")\nSigned-off-by:\
  \ Shivank Garg <shivankg@amd.com>\nReported-by: syzbot+2b99589e33edbe9475ca@syzkaller.appspotmail.com\n\
  Closes: https://lore.kernel.org/all/6828470d.a70a0220.38f255.000c.GAE@google.com\n\
  Suggested-by: David Hildenbrand <david@redhat.com>\nAcked-by: David Hildenbrand\
  \ <david@redhat.com>\nAcked-by: Dev Jain <dev.jain@arm.com>\nReviewed-by: Baolin\
  \ Wang <baolin.wang@linux.alibaba.com>\nCc: Bharata B Rao <bharata@amd.com>\nCc:\
  \ Fengwei Yin <fengwei.yin@intel.com>\nCc: Liam Howlett <liam.howlett@oracle.com>\n\
  Cc: Lorenzo Stoakes <lorenzo.stoakes@oracle.com>\nCc: Mariano Pache <npache@redhat.com>\n\
  Cc: Ryan Roberts <ryan.roberts@arm.com>\nCc: Zi Yan <ziy@nvidia.com>\nCc: <stable@vger.kernel.org>\n\
  Signed-off-by: Andrew Morton <akpm@linux-foundation.org>\n"
submodule:
- mm
hunk_count: 3
covered_count: 3
