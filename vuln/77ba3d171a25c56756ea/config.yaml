id: 77ba3d171a25c56756ea
bug_link: https://syzkaller.appspot.com/bug?extid=77ba3d171a25c56756ea
title: 'KASAN: use-after-free Read in blk_mq_exit_sched'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 828615950b5876e75587fdd5e9d1185be9cabba7
fix_commit: f0c1c4d2864ed614f90d2da1bab1a1c42907b940
datetime: '2021-06-18T08:50:13-06:00'
fix_commit_message: 'blk-mq: fix use-after-free in blk_mq_exit_sched


  tagset can''t be used after blk_cleanup_queue() is returned because

  freeing tagset usually follows blk_clenup_queue(). Commit d97e594c5166

  ("blk-mq: Use request queue-wide tags for tagset-wide sbitmap") adds

  check on q->tag_set->flags in blk_mq_exit_sched(), and causes

  use-after-free.


  Fixes it by using hctx->flags.


  Reported-by: syzbot+77ba3d171a25c56756ea@syzkaller.appspotmail.com

  Fixes: d97e594c5166 ("blk-mq: Use request queue-wide tags for tagset-wide sbitmap")

  Cc: John Garry <john.garry@huawei.com>

  Signed-off-by: Ming Lei <ming.lei@redhat.com>

  Tested-by: John Garry <john.garry@huawei.com>

  Reviewed-by: John Garry <john.garry@huawei.com>

  Link: https://lore.kernel.org/r/20210609063046.122843-1-ming.lei@redhat.com

  Signed-off-by: Jens Axboe <axboe@kernel.dk>

  '
submodule:
- block
hunk_count: 2
covered_count: 2
