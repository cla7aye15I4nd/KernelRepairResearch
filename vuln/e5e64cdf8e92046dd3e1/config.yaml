id: e5e64cdf8e92046dd3e1
bug_link: https://syzkaller.appspot.com/bug?extid=e5e64cdf8e92046dd3e1
title: 'KASAN: slab-use-after-free Read in release_sock (2)'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 28010791193a4503f054e8d69a950ef815deb539
fix_commit: 862c628108562d8c7a516a900034823b381d3cba
datetime: '2025-08-29T14:51:06-04:00'
fix_commit_message: "Bluetooth: Fix use-after-free in l2cap_sock_cleanup_listen()\n\
  \nsyzbot reported the splat below without a repro.\n\nIn the splat, a single thread\
  \ calling bt_accept_dequeue() freed sk\nand touched it after that.\n\nThe root cause\
  \ would be the racy l2cap_sock_cleanup_listen() call\nadded by the cited commit.\n\
  \nbt_accept_dequeue() is called under lock_sock() except for\nl2cap_sock_release().\n\
  \nTwo threads could see the same socket during the list iteration\nin bt_accept_dequeue():\n\
  \n  CPU1                        CPU2 (close())\n  ----                        ----\n\
  \  sock_hold(sk)               sock_hold(sk);\n  lock_sock(sk)   <-- block close()\n\
  \  sock_put(sk)\n  bt_accept_unlink(sk)\n    sock_put(sk)  <-- refcnt by bt_accept_enqueue()\n\
  \  release_sock(sk)\n                              lock_sock(sk)\n             \
  \                 sock_put(sk)\n                              bt_accept_unlink(sk)\n\
  \                                sock_put(sk)        <-- last refcnt\n         \
  \                     bt_accept_unlink(sk)  <-- UAF\n\nDepending on the timing,\
  \ the other thread could show up in the\n\"Freed by task\" part.\n\nLet's call l2cap_sock_cleanup_listen()\
  \ under lock_sock() in\nl2cap_sock_release().\n\n[0]:\nBUG: KASAN: slab-use-after-free\
  \ in debug_spin_lock_before kernel/locking/spinlock_debug.c:86 [inline]\nBUG: KASAN:\
  \ slab-use-after-free in do_raw_spin_lock+0x26f/0x2b0 kernel/locking/spinlock_debug.c:115\n\
  Read of size 4 at addr ffff88803b7eb1c4 by task syz.5.3276/16995\nCPU: 3 UID: 0\
  \ PID: 16995 Comm: syz.5.3276 Not tainted syzkaller #0 PREEMPT(full)\nHardware name:\
  \ QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-debian-1.16.3-2~bpo12+1 04/01/2014\n\
  Call Trace:\n <TASK>\n __dump_stack lib/dump_stack.c:94 [inline]\n dump_stack_lvl+0x116/0x1f0\
  \ lib/dump_stack.c:120\n print_address_description mm/kasan/report.c:378 [inline]\n\
  \ print_report+0xcd/0x630 mm/kasan/report.c:482\n kasan_report+0xe0/0x110 mm/kasan/report.c:595\n\
  \ debug_spin_lock_before kernel/locking/spinlock_debug.c:86 [inline]\n do_raw_spin_lock+0x26f/0x2b0\
  \ kernel/locking/spinlock_debug.c:115\n spin_lock_bh include/linux/spinlock.h:356\
  \ [inline]\n release_sock+0x21/0x220 net/core/sock.c:3746\n bt_accept_dequeue+0x505/0x600\
  \ net/bluetooth/af_bluetooth.c:312\n l2cap_sock_cleanup_listen+0x5c/0x2a0 net/bluetooth/l2cap_sock.c:1451\n\
  \ l2cap_sock_release+0x5c/0x210 net/bluetooth/l2cap_sock.c:1425\n __sock_release+0xb3/0x270\
  \ net/socket.c:649\n sock_close+0x1c/0x30 net/socket.c:1439\n __fput+0x3ff/0xb70\
  \ fs/file_table.c:468\n task_work_run+0x14d/0x240 kernel/task_work.c:227\n resume_user_mode_work\
  \ include/linux/resume_user_mode.h:50 [inline]\n exit_to_user_mode_loop+0xeb/0x110\
  \ kernel/entry/common.c:43\n exit_to_user_mode_prepare include/linux/irq-entry-common.h:225\
  \ [inline]\n syscall_exit_to_user_mode_work include/linux/entry-common.h:175 [inline]\n\
  \ syscall_exit_to_user_mode include/linux/entry-common.h:210 [inline]\n do_syscall_64+0x3f6/0x4c0\
  \ arch/x86/entry/syscall_64.c:100\n entry_SYSCALL_64_after_hwframe+0x77/0x7f\nRIP:\
  \ 0033:0x7f2accf8ebe9\nCode: ff ff c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 40 00\
  \ 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48>\
  \ 3d 01 f0 ff ff 73 01 c3 48 c7 c1 a8 ff ff ff f7 d8 64 89 01 48\nRSP: 002b:00007ffdb6cb1378\
  \ EFLAGS: 00000246 ORIG_RAX: 00000000000001b4\nRAX: 0000000000000000 RBX: 00000000000426fb\
  \ RCX: 00007f2accf8ebe9\nRDX: 0000000000000000 RSI: 000000000000001e RDI: 0000000000000003\n\
  RBP: 00007f2acd1b7da0 R08: 0000000000000001 R09: 00000012b6cb166f\nR10: 0000001b30e20000\
  \ R11: 0000000000000246 R12: 00007f2acd1b609c\nR13: 00007f2acd1b6090 R14: ffffffffffffffff\
  \ R15: 00007ffdb6cb1490\n </TASK>\n\nAllocated by task 5326:\n kasan_save_stack+0x33/0x60\
  \ mm/kasan/common.c:47\n kasan_save_track+0x14/0x30 mm/kasan/common.c:68\n poison_kmalloc_redzone\
  \ mm/kasan/common.c:388 [inline]\n __kasan_kmalloc+0xaa/0xb0 mm/kasan/common.c:405\n\
  \ kasan_kmalloc include/linux/kasan.h:260 [inline]\n __do_kmalloc_node mm/slub.c:4365\
  \ [inline]\n __kmalloc_noprof+0x223/0x510 mm/slub.c:4377\n kmalloc_noprof include/linux/slab.h:909\
  \ [inline]\n sk_prot_alloc+0x1a8/0x2a0 net/core/sock.c:2239\n sk_alloc+0x36/0xc20\
  \ net/core/sock.c:2295\n bt_sock_alloc+0x3b/0x3a0 net/bluetooth/af_bluetooth.c:151\n\
  \ l2cap_sock_alloc.constprop.0+0x33/0x1d0 net/bluetooth/l2cap_sock.c:1894\n l2cap_sock_new_connection_cb+0x101/0x240\
  \ net/bluetooth/l2cap_sock.c:1482\n l2cap_connect_cfm+0x4c4/0xf80 net/bluetooth/l2cap_core.c:7287\n\
  \ hci_connect_cfm include/net/bluetooth/hci_core.h:2050 [inline]\n hci_remote_features_evt+0x4dd/0x970\
  \ net/bluetooth/hci_event.c:3712\n hci_event_func net/bluetooth/hci_event.c:7519\
  \ [inline]\n hci_event_packet+0xa0d/0x11c0 net/bluetooth/hci_event.c:7573\n hci_rx_work+0x2c5/0x16b0\
  \ net/bluetooth/hci_core.c:4071\n process_one_work+0x9cf/0x1b70 kernel/workqueue.c:3236\n\
  \ process_scheduled_works kernel/workqueue.c:3319 [inline]\n worker_thread+0x6c8/0xf10\
  \ kernel/workqueue.c:3400\n kthread+0x3c2/0x780 kernel/kthread.c:463\n ret_from_fork+0x5d7/0x6f0\
  \ arch/x86/kernel/process.c:148\n ret_from_fork_asm+0x1a/0x30 arch/x86/entry/entry_64.S:245\n\
  \nFreed by task 16995:\n kasan_save_stack+0x33/0x60 mm/kasan/common.c:47\n kasan_save_track+0x14/0x30\
  \ mm/kasan/common.c:68\n kasan_save_free_info+0x3b/0x60 mm/kasan/generic.c:576\n\
  \ poison_slab_object mm/kasan/common.c:243 [inline]\n __kasan_slab_free+0x60/0x70\
  \ mm/kasan/common.c:275\n kasan_slab_free include/linux/kasan.h:233 [inline]\n slab_free_hook\
  \ mm/slub.c:2417 [inline]\n slab_free mm/slub.c:4680 [inline]\n kfree+0x2b4/0x4d0\
  \ mm/slub.c:4879\n sk_prot_free net/core/sock.c:2278 [inline]\n __sk_destruct+0x75f/0x9a0\
  \ net/core/sock.c:2373\n sk_destruct+0xc2/0xf0 net/core/sock.c:2401\n __sk_free+0xf4/0x3e0\
  \ net/core/sock.c:2412\n sk_free+0x6a/0x90 net/core/sock.c:2423\n sock_put include/net/sock.h:1960\
  \ [inline]\n bt_accept_unlink+0x245/0x2e0 net/bluetooth/af_bluetooth.c:262\n bt_accept_dequeue+0x517/0x600\
  \ net/bluetooth/af_bluetooth.c:308\n l2cap_sock_cleanup_listen+0x5c/0x2a0 net/bluetooth/l2cap_sock.c:1451\n\
  \ l2cap_sock_release+0x5c/0x210 net/bluetooth/l2cap_sock.c:1425\n __sock_release+0xb3/0x270\
  \ net/socket.c:649\n sock_close+0x1c/0x30 net/socket.c:1439\n __fput+0x3ff/0xb70\
  \ fs/file_table.c:468\n task_work_run+0x14d/0x240 kernel/task_work.c:227\n resume_user_mode_work\
  \ include/linux/resume_user_mode.h:50 [inline]\n exit_to_user_mode_loop+0xeb/0x110\
  \ kernel/entry/common.c:43\n exit_to_user_mode_prepare include/linux/irq-entry-common.h:225\
  \ [inline]\n syscall_exit_to_user_mode_work include/linux/entry-common.h:175 [inline]\n\
  \ syscall_exit_to_user_mode include/linux/entry-common.h:210 [inline]\n do_syscall_64+0x3f6/0x4c0\
  \ arch/x86/entry/syscall_64.c:100\n entry_SYSCALL_64_after_hwframe+0x77/0x7f\n\n\
  Fixes: 1728137b33c0 (\"Bluetooth: L2CAP: Fix use-after-free in l2cap_sock_ready_cb\"\
  )\nReported-by: syzbot+e5e64cdf8e92046dd3e1@syzkaller.appspotmail.com\nCloses: https://lore.kernel.org/linux-bluetooth/68af6b9d.a70a0220.3cafd4.0032.GAE@google.com/\n\
  Signed-off-by: Kuniyuki Iwashima <kuniyu@google.com>\nSigned-off-by: Luiz Augusto\
  \ von Dentz <luiz.von.dentz@intel.com>\n"
submodule:
- net/bluetooth
hunk_count: 1
covered_count: 1
