id: 00f7f5b884b117ee6773
bug_link: https://syzkaller.appspot.com/bug?extid=00f7f5b884b117ee6773
title: possible deadlock in __nilfs_error (3)
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: dac2a4f663c4bcd75add07aedf9d30c9f8e5ead5
fix_commit: fb881cd7604536b17a1927fb0533f9a6982ffcc5
datetime: '2025-05-07T23:39:42-07:00'
fix_commit_message: "nilfs2: fix deadlock warnings caused by lock dependency in init_nilfs()\n\
  \nAfter commit c0e473a0d226 (\"block: fix race between set_blocksize and read\n\
  paths\") was merged, set_blocksize() called by sb_set_blocksize() now locks\nthe\
  \ inode of the backing device file.  As a result of this change, syzbot\nstarted\
  \ reporting deadlock warnings due to a circular dependency involving\nthe semaphore\
  \ \"ns_sem\" of the nilfs object, the inode lock of the backing\ndevice file, and\
  \ the locks that this inode lock is transitively dependent\non.\n\nThis is caused\
  \ by a new lock dependency added by the above change, since\ninit_nilfs() calls\
  \ sb_set_blocksize() in the lock section of \"ns_sem\". \nHowever, these warnings\
  \ are false positives because init_nilfs() is called\nin the early stage of the\
  \ mount operation and the filesystem has not yet\nstarted.\n\nThe reason why \"\
  ns_sem\" is locked in init_nilfs() was to avoid a race\ncondition in nilfs_fill_super()\
  \ caused by sharing a nilfs object among\nmultiple filesystem instances (super block\
  \ structures) in the early\nimplementation.  However, nilfs objects and super block\
  \ structures have\nlong ago become one-to-one, and there is no longer any need to\
  \ use the\nsemaphore there.\n\nSo, fix this issue by removing the use of the semaphore\
  \ \"ns_sem\" in\ninit_nilfs().\n\nLink: https://lkml.kernel.org/r/20250503053327.12294-1-konishi.ryusuke@gmail.com\n\
  Fixes: c0e473a0d226 (\"block: fix race between set_blocksize and read paths\")\n\
  Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>\nReported-by: syzbot+00f7f5b884b117ee6773@syzkaller.appspotmail.com\n\
  Closes: https://syzkaller.appspot.com/bug?extid=00f7f5b884b117ee6773\nTested-by:\
  \ syzbot+00f7f5b884b117ee6773@syzkaller.appspotmail.com\nReported-by: syzbot+f30591e72bfc24d4715b@syzkaller.appspotmail.com\n\
  Closes: https://syzkaller.appspot.com/bug?extid=f30591e72bfc24d4715b\nTested-by:\
  \ syzbot+f30591e72bfc24d4715b@syzkaller.appspotmail.com>\nSigned-off-by: Andrew\
  \ Morton <akpm@linux-foundation.org>\n"
submodule:
- fs/nilfs2
hunk_count: 2
covered_count: 1
