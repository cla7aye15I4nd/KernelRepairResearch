id: 04681da557a0e49a52e5
bug_link: https://syzkaller.appspot.com/bug?extid=04681da557a0e49a52e5
title: 'KASAN: use-after-free Read in nbp_vlan_rcu_free'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 95506588d2c1d72ca29adef8ae9bf771bcfb4ced
fix_commit: 9d332e69c1dc74dcd748de7cbd2dac5c61bda265
datetime: '2018-11-17T21:38:44-08:00'
fix_commit_message: "net: bridge: fix vlan stats use-after-free on destruction\n\n\
  Syzbot reported a use-after-free of the global vlan context on port vlan\ndestruction.\
  \ When I added per-port vlan stats I missed the fact that the\nglobal vlan context\
  \ can be freed before the per-port vlan rcu callback.\nThere're a few different\
  \ ways to deal with this, I've chosen to add a\nnew private flag that is set only\
  \ when per-port stats are allocated so\nwe can directly check it on destruction\
  \ without dereferencing the global\ncontext at all. The new field in net_bridge_vlan\
  \ uses a hole.\n\nv2: cosmetic change, move the check to br_process_vlan_info where\
  \ the\n    other checks are done\nv3: add change log in the patch, add private (in-kernel\
  \ only) flags in a\n    hole in net_bridge_vlan struct and use that instead of mixing\n\
  \    user-space flags with private flags\n\nFixes: 9163a0fc1f0c (\"net: bridge:\
  \ add support for per-port vlan stats\")\nReported-by: syzbot+04681da557a0e49a52e5@syzkaller.appspotmail.com\n\
  Signed-off-by: Nikolay Aleksandrov <nikolay@cumulusnetworks.com>\nSigned-off-by:\
  \ David S. Miller <davem@davemloft.net>\n"
submodule:
- net/bridge
hunk_count: 4
covered_count: 1
