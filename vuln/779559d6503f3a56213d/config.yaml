id: 779559d6503f3a56213d
bug_link: https://syzkaller.appspot.com/bug?extid=779559d6503f3a56213d
title: 'WARNING: ODEBUG bug in net_dm_cmd_trace'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 547fd083770ab8353e7aa7f9e802b499e30fd4ef
fix_commit: 9398e9c0b1d44eeb700e9e766c02bcc765c82570
datetime: '2021-03-10T15:19:02-08:00'
fix_commit_message: "drop_monitor: Perform cleanup upon probe registration failure\n\
  \nIn the rare case that drop_monitor fails to register its probe on the\n'napi_poll'\
  \ tracepoint, it will not deactivate its hysteresis timer as\npart of the error\
  \ path. If the hysteresis timer was armed by the shortly\nlived 'kfree_skb' probe\
  \ and user space retries to initiate tracing, a\nwarning will be emitted for trying\
  \ to initialize an active object [1].\n\nFix this by properly undoing all the operations\
  \ that were done prior to\nprobe registration, in both software and hardware code\
  \ paths.\n\nNote that syzkaller managed to fail probe registration by injecting\
  \ a\nslab allocation failure [2].\n\n[1]\nODEBUG: init active (active state 0) object\
  \ type: timer_list hint: sched_send_work+0x0/0x60 include/linux/list.h:135\nWARNING:\
  \ CPU: 1 PID: 8649 at lib/debugobjects.c:505 debug_print_object+0x16e/0x250 lib/debugobjects.c:505\n\
  Modules linked in:\nCPU: 1 PID: 8649 Comm: syz-executor.0 Not tainted 5.11.0-syzkaller\
  \ #0\nHardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google\
  \ 01/01/2011\nRIP: 0010:debug_print_object+0x16e/0x250 lib/debugobjects.c:505\n\
  [...]\nCall Trace:\n __debug_object_init+0x524/0xd10 lib/debugobjects.c:588\n debug_timer_init\
  \ kernel/time/timer.c:722 [inline]\n debug_init kernel/time/timer.c:770 [inline]\n\
  \ init_timer_key+0x2d/0x340 kernel/time/timer.c:814\n net_dm_trace_on_set net/core/drop_monitor.c:1111\
  \ [inline]\n set_all_monitor_traces net/core/drop_monitor.c:1188 [inline]\n net_dm_monitor_start\
  \ net/core/drop_monitor.c:1295 [inline]\n net_dm_cmd_trace+0x720/0x1220 net/core/drop_monitor.c:1339\n\
  \ genl_family_rcv_msg_doit+0x228/0x320 net/netlink/genetlink.c:739\n genl_family_rcv_msg\
  \ net/netlink/genetlink.c:783 [inline]\n genl_rcv_msg+0x328/0x580 net/netlink/genetlink.c:800\n\
  \ netlink_rcv_skb+0x153/0x420 net/netlink/af_netlink.c:2502\n genl_rcv+0x24/0x40\
  \ net/netlink/genetlink.c:811\n netlink_unicast_kernel net/netlink/af_netlink.c:1312\
  \ [inline]\n netlink_unicast+0x533/0x7d0 net/netlink/af_netlink.c:1338\n netlink_sendmsg+0x856/0xd90\
  \ net/netlink/af_netlink.c:1927\n sock_sendmsg_nosec net/socket.c:652 [inline]\n\
  \ sock_sendmsg+0xcf/0x120 net/socket.c:672\n ____sys_sendmsg+0x6e8/0x810 net/socket.c:2348\n\
  \ ___sys_sendmsg+0xf3/0x170 net/socket.c:2402\n __sys_sendmsg+0xe5/0x1b0 net/socket.c:2435\n\
  \ do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46\n entry_SYSCALL_64_after_hwframe+0x44/0xae\n\
  \n[2]\n FAULT_INJECTION: forcing a failure.\n name failslab, interval 1, probability\
  \ 0, space 0, times 1\n CPU: 1 PID: 8645 Comm: syz-executor.0 Not tainted 5.11.0-syzkaller\
  \ #0\n Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google\
  \ 01/01/2011\n Call Trace:\n  dump_stack+0xfa/0x151\n  should_fail.cold+0x5/0xa\n\
  \  should_failslab+0x5/0x10\n  __kmalloc+0x72/0x3f0\n  tracepoint_add_func+0x378/0x990\n\
  \  tracepoint_probe_register+0x9c/0xe0\n  net_dm_cmd_trace+0x7fc/0x1220\n  genl_family_rcv_msg_doit+0x228/0x320\n\
  \  genl_rcv_msg+0x328/0x580\n  netlink_rcv_skb+0x153/0x420\n  genl_rcv+0x24/0x40\n\
  \  netlink_unicast+0x533/0x7d0\n  netlink_sendmsg+0x856/0xd90\n  sock_sendmsg+0xcf/0x120\n\
  \  ____sys_sendmsg+0x6e8/0x810\n  ___sys_sendmsg+0xf3/0x170\n  __sys_sendmsg+0xe5/0x1b0\n\
  \  do_syscall_64+0x2d/0x70\n  entry_SYSCALL_64_after_hwframe+0x44/0xae\n\nFixes:\
  \ 70c69274f354 (\"drop_monitor: Initialize timer and work item upon tracing enable\"\
  )\nFixes: 8ee2267ad33e (\"drop_monitor: Convert to using devlink tracepoint\")\n\
  Reported-by: syzbot+779559d6503f3a56213d@syzkaller.appspotmail.com\nSigned-off-by:\
  \ Ido Schimmel <idosch@nvidia.com>\nReviewed-by: Jiri Pirko <jiri@nvidia.com>\n\
  Signed-off-by: David S. Miller <davem@davemloft.net>\n"
submodule:
- net/core
hunk_count: 2
covered_count: 1
