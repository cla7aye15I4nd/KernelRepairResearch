id: 8400677f3fd43f37d3bc
bug_link: https://syzkaller.appspot.com/bug?extid=8400677f3fd43f37d3bc
title: kernel BUG in vlan_get_tci
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: a7af435df0e04cfb4a4004136d597c42639a2ae7
fix_commit: 77ee7a6d16b6ec07b5c3ae2b6b60a24c1afbed09
datetime: '2025-01-02T18:40:54-08:00'
fix_commit_message: "af_packet: fix vlan_get_tci() vs MSG_PEEK\n\nBlamed commit forgot\
  \ MSG_PEEK case, allowing a crash [1] as found\nby syzbot.\n\nRework vlan_get_tci()\
  \ to not touch skb at all,\nso that it can be used from many cpus on the same skb.\n\
  \nAdd a const qualifier to skb argument.\n\n[1]\nskbuff: skb_under_panic: text:ffffffff8a8da482\
  \ len:32 put:14 head:ffff88807a1d5800 data:ffff88807a1d5810 tail:0x14 end:0x140\
  \ dev:<NULL>\n------------[ cut here ]------------\n kernel BUG at net/core/skbuff.c:206\
  \ !\nOops: invalid opcode: 0000 [#1] PREEMPT SMP KASAN PTI\nCPU: 0 UID: 0 PID: 5880\
  \ Comm: syz-executor172 Not tainted 6.13.0-rc3-syzkaller-00762-g9268abe611b0 #0\n\
  Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 09/13/2024\n\
  \ RIP: 0010:skb_panic net/core/skbuff.c:206 [inline]\n RIP: 0010:skb_under_panic+0x14b/0x150\
  \ net/core/skbuff.c:216\nCode: 0b 8d 48 c7 c6 9e 6c 26 8e 48 8b 54 24 08 8b 0c 24\
  \ 44 8b 44 24 04 4d 89 e9 50 41 54 41 57 41 56 e8 3a 5a 79 f7 48 83 c4 20 90 <0f>\
  \ 0b 0f 1f 00 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 f3\nRSP: 0018:ffffc90003baf5b8\
  \ EFLAGS: 00010286\nRAX: 0000000000000087 RBX: dffffc0000000000 RCX: 8565c1eec37aa000\n\
  RDX: 0000000000000000 RSI: 0000000080000000 RDI: 0000000000000000\nRBP: ffff88802616fb50\
  \ R08: ffffffff817f0a4c R09: 1ffff92000775e50\nR10: dffffc0000000000 R11: fffff52000775e51\
  \ R12: 0000000000000140\nR13: ffff88807a1d5800 R14: ffff88807a1d5810 R15: 0000000000000014\n\
  FS:  00007fa03261f6c0(0000) GS:ffff8880b8600000(0000) knlGS:0000000000000000\nCS:\
  \  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\nCR2: 00007ffd65753000 CR3: 0000000031720000\
  \ CR4: 00000000003526f0\nDR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000\n\
  DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400\nCall Trace:\n\
  \ <TASK>\n  skb_push+0xe5/0x100 net/core/skbuff.c:2636\n  vlan_get_tci+0x272/0x550\
  \ net/packet/af_packet.c:565\n  packet_recvmsg+0x13c9/0x1ef0 net/packet/af_packet.c:3616\n\
  \  sock_recvmsg_nosec net/socket.c:1044 [inline]\n  sock_recvmsg+0x22f/0x280 net/socket.c:1066\n\
  \  ____sys_recvmsg+0x1c6/0x480 net/socket.c:2814\n  ___sys_recvmsg net/socket.c:2856\
  \ [inline]\n  do_recvmmsg+0x426/0xab0 net/socket.c:2951\n  __sys_recvmmsg net/socket.c:3025\
  \ [inline]\n  __do_sys_recvmmsg net/socket.c:3048 [inline]\n  __se_sys_recvmmsg\
  \ net/socket.c:3041 [inline]\n  __x64_sys_recvmmsg+0x199/0x250 net/socket.c:3041\n\
  \  do_syscall_x64 arch/x86/entry/common.c:52 [inline]\n  do_syscall_64+0xf3/0x230\
  \ arch/x86/entry/common.c:83\n\nFixes: 79eecf631c14 (\"af_packet: Handle outgoing\
  \ VLAN packets without hardware offloading\")\nReported-by: syzbot+8400677f3fd43f37d3bc@syzkaller.appspotmail.com\n\
  Closes: https://lore.kernel.org/netdev/6772c485.050a0220.2f3838.04c6.GAE@google.com/T/#u\n\
  Signed-off-by: Eric Dumazet <edumazet@google.com>\nCc: Chengen Du <chengen.du@canonical.com>\n\
  Reviewed-by: Willem de Bruijn <willemb@google.com>\nLink: https://patch.msgid.link/20241230161004.2681892-1-edumazet@google.com\n\
  Signed-off-by: Jakub Kicinski <kuba@kernel.org>\n"
submodule:
- net/packet
hunk_count: 2
covered_count: 2
