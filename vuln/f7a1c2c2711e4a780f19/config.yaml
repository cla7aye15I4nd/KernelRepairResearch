id: f7a1c2c2711e4a780f19
bug_link: https://syzkaller.appspot.com/bug?extid=f7a1c2c2711e4a780f19
title: 'KASAN: slab-use-after-free Read in __uprobe_unregister'
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 62c0b1061593d7012292f781f11145b2d46f43ab
fix_commit: 5fe6e308abaea082c20fbf2aa5df8e14495622cf
datetime: '2024-09-05T16:56:13+02:00'
fix_commit_message: 'bpf: Fix use-after-free in bpf_uprobe_multi_link_attach()


  If bpf_link_prime() fails, bpf_uprobe_multi_link_attach() goes to the

  error_free label and frees the array of bpf_uprobe''s without calling

  bpf_uprobe_unregister().


  This leaks bpf_uprobe->uprobe and worse, this frees bpf_uprobe->consumer

  without removing it from the uprobe->consumers list.


  Fixes: 89ae89f53d20 ("bpf: Add multi uprobe link")

  Closes: https://lore.kernel.org/all/000000000000382d39061f59f2dd@google.com/

  Reported-by: syzbot+f7a1c2c2711e4a780f19@syzkaller.appspotmail.com

  Signed-off-by: Oleg Nesterov <oleg@redhat.com>

  Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>

  Acked-by: Andrii Nakryiko <andrii@kernel.org>

  Acked-by: Jiri Olsa <jolsa@kernel.org>

  Tested-by: syzbot+f7a1c2c2711e4a780f19@syzkaller.appspotmail.com

  Cc: stable@vger.kernel.org

  Link: https://lore.kernel.org/r/20240813152524.GA7292@redhat.com

  '
submodule:
- kernel/trace
hunk_count: 1
covered_count: 1
