id: fe63f377148a6371a9db
bug_link: https://syzkaller.appspot.com/bug?extid=fe63f377148a6371a9db
title: possible deadlock in pcpu_alloc_noprof
source_page: https://syzkaller.appspot.com/upstream/fixed
trigger_commit: 7909d1fb90e290ffd7b8570f4e2f97fe2fb381d0
fix_commit: 677bdb7346b6fd806ea45b11cbfe36de0b0cd644
datetime: '2025-02-26T19:31:05-05:00'
fix_commit_message: 'bcachefs: Fix deadlock


  This fixes two deadlocks:


  1.pcpu_alloc_mutex involved one as pointed by syzbot[1]

  2.recursion deadlock.


  The root cause is that we hold the bc lock during alloc_percpu, fix it

  by following the pattern used by __btree_node_mem_alloc().


  [1] https://lore.kernel.org/all/66f97d9a.050a0220.6bad9.001d.GAE@google.com/T/


  Reported-by: syzbot+fe63f377148a6371a9db@syzkaller.appspotmail.com

  Tested-by: syzbot+fe63f377148a6371a9db@syzkaller.appspotmail.com

  Signed-off-by: Alan Huang <mmpgouride@gmail.com>

  Signed-off-by: Kent Overstreet <kent.overstreet@linux.dev>

  '
submodule:
- fs/bcachefs
hunk_count: 8
covered_count: 0
